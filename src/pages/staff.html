<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FMSTYLE - H·ªá Th·ªëng B√°n H√†ng</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&family=Be+Vietnam+Pro:wght@300;400;500;600;700&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Montserrat', 'Be Vietnam Pro', sans-serif;
            background-image: url("../assets/1.png");
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            min-height: 100vh;
            color: #333;
        }

        .container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background: linear-gradient(135deg, rgba(253, 244, 215, 0.95) 0%, rgba(212, 231, 230, 0.95) 35%, rgba(241, 189, 181, 0.95) 70%, rgba(216, 211, 233, 0.95) 100%);
            backdrop-filter: blur(10px);
            color: #1a2b48;
            padding: 20px 0;
            box-shadow: 4px 0 25px rgba(0, 0, 0, 0.15);
            position: fixed;
            height: 100vh;
            border-right: 1px solid rgba(0, 0, 0, 0.1);
            overflow-y: auto;
            z-index: 100;
            pointer-events: auto;
        }

        .sidebar-header {
            padding: 25px 20px;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            margin-bottom: 20px;
        }

        .sidebar-header h1 {
            font-size: 32px;
            font-weight: 900;
            letter-spacing: -2px;
            text-transform: uppercase;
            line-height: 1;
            position: relative;
            display: inline-block;
            background: linear-gradient(to bottom, #ff9800 0%, #f39c12 45%, #e65100 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            filter: drop-shadow(0px 2px 4px rgba(255, 152, 0, 0.3));
            margin-bottom: 8px;
        }

        .sidebar-header h1::after {
            content: attr(data-text);
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            z-index: 5;
            background: linear-gradient(110deg, transparent 35%, rgba(255, 255, 255, 0.8) 45%, rgba(255, 255, 255, 0.8) 50%, transparent 60%);
            background-size: 200% 100%;
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: shine 5s infinite linear;
        }

        @keyframes shine {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .sidebar-header p {
            font-size: 12px;
            opacity: 0.8;
            color: #4a5568;
            font-weight: 500;
        }

        .user-info {
            padding: 15px 20px;
            background: rgba(255,255,255,0.15);
            margin: 0 15px 20px;
            border-radius: 10px;
            font-size: 13px;
            color: #1a2b48;
        }

        .user-info span {
            color: #4a90e2;
            font-weight: 700;
        }

        .menu-item {
            padding: 14px 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-left: 3px solid transparent;
            display: flex;
            align-items: center;
            gap: 12px;
            color: #4a5568;
            font-size: 14px;
            user-select: none;
            -webkit-user-select: none;
            pointer-events: auto;
            position: relative;
            z-index: 10;
        }

        .menu-item:hover {
            background: rgba(212, 231, 230, 0.3);
            border-left-color: #4a90e2;
            color: #1a2b48;
        }

        .menu-item.active {
            background: linear-gradient(90deg, rgba(212, 231, 230, 0.4) 0%, transparent 100%);
            border-left-color: #4a90e2;
            color: #1a2b48;
            font-weight: 700;
        }
        
        .menu-item span {
            pointer-events: none;
        }

        .logout-btn {
            margin: 20px 15px;
            padding: 12px;
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 700;
            width: calc(100% - 30px);
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.4);
        }

        .logout-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(231, 76, 60, 0.5);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: 280px;
            padding: 25px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            min-height: 100vh;
        }

        .page-header {
            background: linear-gradient(135deg, #fdf4d7 0%, #d4e7e6 35%, #f1bdb5 70%, #d8d3e9 100%);
            padding: 25px 30px;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            margin-bottom: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .page-header h2 {
            color: #1a2b48;
            font-size: 24px;
            font-weight: 800;
        }

        .page-header p {
            color: #666;
            font-size: 13px;
            margin-top: 5px;
        }

        /* Buttons */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-family: inherit;
        }

        .btn-primary {
            background: linear-gradient(135deg, #d4e7e6 0%, #4a90e2 100%);
            color: #1a2b48;
            font-weight: 700;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(74, 144, 226, 0.3);
            filter: brightness(1.05);
        }

        .btn-success {
            background: linear-gradient(135deg, #00b894 0%, #00cec9 100%);
            color: white;
            font-weight: 700;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 184, 148, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
            font-weight: 700;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(231, 76, 60, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #636e72 0%, #2d3436 100%);
            color: white;
            font-weight: 700;
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(45, 52, 54, 0.4);
        }

        .btn-warning {
            background: linear-gradient(135deg, #fdcb6e 0%, #f39c12 100%);
            color: #1a2b48;
            font-weight: 700;
        }

        .btn-outline {
            background: transparent;
            border: 2px solid #ddd;
            color: #666;
        }

        .btn-outline:hover {
            border-color: #00d2ff;
            color: #00d2ff;
        }

        .btn-sm {
            padding: 8px 14px;
            font-size: 12px;
        }

        /* Search Box */
        .search-box {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            background: white;
            padding: 15px 20px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .search-input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e8e8e8;
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .search-input:focus {
            outline: none;
            border-color: #4a90e2;
            box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1);
        }

        /* Table */
        .table-container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 2px 15px rgba(0, 0, 0, 0.05);
            overflow: hidden;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: linear-gradient(135deg, #d4e7e6 0%, #4a90e2 100%);
            color: #1a2b48;
        }

        th {
            padding: 16px 18px;
            text-align: left;
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        td {
            padding: 14px 18px;
            border-bottom: 1px solid #f0f0f0;
            font-size: 13px;
        }

        tbody tr {
            transition: all 0.2s ease;
        }

        tbody tr:hover {
            background: #f8f9fa;
        }

        tbody tr:last-child td {
            border-bottom: none;
        }

        /* Cart Section */
        .cart-section {
            display: grid;
            grid-template-columns: 1fr 420px;
            gap: 25px;
        }

        .products-panel {
            background: white;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 2px 15px rgba(0, 0, 0, 0.05);
        }

        .cart-panel {
            background: white;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 2px 15px rgba(0, 0, 0, 0.05);
            position: sticky;
            top: 25px;
            max-height: calc(100vh - 50px);
            overflow-y: auto;
        }

        .panel-title {
            font-size: 16px;
            font-weight: 700;
            color: #1a1a2e;
            margin-bottom: 15px;
            padding-bottom: 12px;
            border-bottom: 2px solid #f0f0f0;
        }

        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #f5f5f5;
        }

        .cart-item-info {
            flex: 1;
        }

        .cart-item-name {
            font-weight: 600;
            color: #1a1a2e;
            font-size: 13px;
        }

        .cart-item-price {
            color: #00b894;
            font-weight: 600;
            font-size: 12px;
            margin-top: 3px;
        }

        .cart-item-qty {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .qty-btn {
            width: 28px;
            height: 28px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
        }

        .qty-btn.minus {
            background: #ffe6e6;
            color: #e74c3c;
        }

        .qty-btn.plus {
            background: #e6fff5;
            color: #00b894;
        }

        .qty-btn:hover {
            transform: scale(1.1);
        }

        .qty-value {
            width: 35px;
            text-align: center;
            font-weight: 600;
            font-size: 14px;
        }

        .cart-item-remove {
            background: none;
            border: none;
            color: #e74c3c;
            cursor: pointer;
            font-size: 16px;
            padding: 5px;
            margin-left: 10px;
        }

        .cart-summary {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px dashed #e0e0e0;
        }

        .cart-summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 13px;
        }

        .cart-summary-row.total {
            font-size: 16px;
            font-weight: 700;
            color: #1a1a2e;
            padding-top: 10px;
            border-top: 2px solid #1a1a2e;
            margin-top: 12px;
        }

        .cart-summary-row .label {
            color: #666;
        }

        .cart-summary-row .value {
            font-weight: 600;
        }

        .value-success {
            color: #00b894;
        }

        .value-danger {
            color: #e74c3c;
        }

        .cart-empty {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }

        /* Form */
        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            color: #333;
            font-weight: 600;
            font-size: 12px;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px 14px;
            border: 2px solid #e8e8e8;
            border-radius: 8px;
            font-size: 13px;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #4a90e2;
            box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        /* Product Grid */
        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .product-card {
            background: #fafafa;
            border-radius: 12px;
            padding: 15px;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            cursor: pointer;
        }

        .product-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.08);
            border-color: #00d2ff;
        }

        .product-card-name {
            font-weight: 700;
            color: #1a1a2e;
            font-size: 13px;
            margin-bottom: 5px;
        }

        .product-card-code {
            color: #888;
            font-size: 11px;
            margin-bottom: 8px;
        }

        .product-card-stock {
            font-size: 11px;
            padding: 3px 8px;
            border-radius: 15px;
            display: inline-block;
            margin-bottom: 8px;
        }

        .stock-ok {
            background: #e6fff5;
            color: #00b894;
        }

        .stock-warning {
            background: #fff3e0;
            color: #f39c12;
        }

        .stock-danger {
            background: #ffe6e6;
            color: #e74c3c;
        }

        .product-card-price {
            font-size: 15px;
            font-weight: 700;
            color: #00b894;
        }

        .product-card-btn {
            width: 100%;
            margin-top: 10px;
            padding: 8px;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .product-card-btn:hover {
            background: linear-gradient(135deg, #00d2ff 0%, #3a7bd5 100%);
        }

        .product-card-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 10000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }

        .modal.active {
            display: flex;
        }
        
        .modal.show {
            display: flex !important;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 25px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                transform: translateY(-40px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .modal-header h3 {
            color: #1a1a2e;
            font-size: 18px;
            font-weight: 700;
        }

        .close-btn {
            background: #f5f5f5;
            border: none;
            font-size: 18px;
            cursor: pointer;
            color: #666;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s;
        }

        .close-btn:hover {
            background: #ffe6e6;
            color: #e74c3c;
        }

        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 2px solid #f0f0f0;
        }

        /* Toast */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            pointer-events: none;
        }

        .toast {
            min-width: 300px;
            padding: 14px 18px;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            gap: 10px;
            animation: slideInRight 0.4s ease-out, fadeOut 0.4s ease-in 2.6s forwards;
            pointer-events: auto;
            cursor: pointer;
        }

        .toast-success {
            background: linear-gradient(135deg, #00b894 0%, #00cec9 100%);
            color: white;
        }

        .toast-error {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
        }

        .toast-info {
            background: linear-gradient(135deg, #00d2ff 0%, #3a7bd5 100%);
            color: white;
        }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-weight: 600;
            font-size: 13px;
        }

        .toast-message {
            font-size: 12px;
            opacity: 0.9;
            margin-top: 2px;
        }

        .toast-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 14px;
        }

        @keyframes slideInRight {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; transform: translateX(100px); }
        }

        /* Stats Cards */
        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: white;
            border-radius: 14px;
            padding: 20px;
            box-shadow: 0 2px 15px rgba(0, 0, 0, 0.05);
        }

        .stat-card h3 {
            font-size: 24px;
            font-weight: 700;
            color: #1a1a2e;
            margin-bottom: 5px;
        }

        .stat-card p {
            font-size: 12px;
            color: #888;
        }

        .stat-card.blue { border-left: 4px solid #00d2ff; }
        .stat-card.green { border-left: 4px solid #00b894; }
        .stat-card.orange { border-left: 4px solid #f39c12; }
        .stat-card.purple { border-left: 4px solid #9b59b6; }

        /* Badge */
        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 11px;
            font-weight: 600;
        }

        .badge-success { background: #e6fff5; color: #00b894; }
        .badge-warning { background: #fff3e0; color: #f39c12; }
        .badge-danger { background: #ffe6e6; color: #e74c3c; }
        .badge-info { background: #e6f7ff; color: #00d2ff; }

        /* Customer Section */
        .customer-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .customer-section-title {
            font-size: 13px;
            font-weight: 700;
            color: #1a1a2e;
            margin-bottom: 12px;
        }

        .customer-info-box {
            background: #e6fff5;
            padding: 12px;
            border-radius: 8px;
            margin-top: 10px;
        }

        .customer-info-box p {
            font-size: 12px;
            margin-bottom: 4px;
        }

        .customer-info-box strong {
            color: #00b894;
        }

        /* Points Section */
        .points-section {
            background: #fff3e0;
            padding: 12px;
            border-radius: 8px;
            margin-top: 10px;
        }

        .points-section label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            cursor: pointer;
        }

        .points-section input[type="checkbox"] {
            width: auto;
        }

        /* Stock Warning */
        .stock-warning-list {
            margin-top: 20px;
            padding: 15px;
            background: #fff3e0;
            border-radius: 10px;
            border-left: 4px solid #f39c12;
        }

        .stock-warning-list h4 {
            font-size: 13px;
            color: #f39c12;
            margin-bottom: 10px;
        }

        .stock-warning-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(243, 156, 18, 0.2);
            font-size: 12px;
        }

        .stock-warning-item:last-child {
            border-bottom: none;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .spinner {
            border: 3px solid #f0f0f0;
            border-top: 3px solid #00d2ff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 0.8s linear infinite;
            margin: 15px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 50px 20px;
            color: #999;
        }

        /* Chart Container */
        .chart-container {
            background: white;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 2px 15px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 12px;
            border-bottom: 2px solid #f0f0f0;
        }

        .chart-title {
            font-size: 16px;
            font-weight: 700;
            color: #1a1a2e;
        }

        .chart-filter {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .chart-filter select,
        .chart-filter input {
            padding: 6px 12px;
            border: 2px solid #e8e8e8;
            border-radius: 6px;
            font-size: 12px;
            font-family: inherit;
        }

        .chart-filter select:focus,
        .chart-filter input:focus {
            outline: none;
            border-color: #4a90e2;
        }

        .chart-wrapper {
            position: relative;
            height: 300px;
            margin-top: 15px;
        }

        /* Top Lists */
        .top-list-container {
            background: white;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 2px 15px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
        }

        .top-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #f5f5f5;
        }

        .top-list-item:last-child {
            border-bottom: none;
        }

        .top-list-rank {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 14px;
            margin-right: 12px;
        }

        .rank-1 { background: #ffd700; color: #1a1a2e; }
        .rank-2 { background: #c0c0c0; color: #1a1a2e; }
        .rank-3 { background: #cd7f32; color: white; }
        .rank-other { background: #e8e8e8; color: #666; }

        .top-list-info {
            flex: 1;
        }

        .top-list-name {
            font-weight: 600;
            color: #1a1a2e;
            font-size: 13px;
            margin-bottom: 3px;
        }

        .top-list-detail {
            font-size: 11px;
            color: #888;
        }

        .top-list-value {
            font-weight: 700;
            color: #00b894;
            font-size: 14px;
        }

        /* Slow Moving Warning */
        .slow-moving-warning {
            background: #fff3e0;
            border-left: 4px solid #f39c12;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
        }

        .slow-moving-warning h4 {
            color: #f39c12;
            font-size: 13px;
            margin-bottom: 10px;
        }

        /* Supplier Section */
        .supplier-section {
            background: #e6f7ff;
            border-left: 4px solid #00d2ff;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
        }

        .supplier-section h4 {
            color: #00d2ff;
            font-size: 13px;
            margin-bottom: 10px;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .cart-section {
                grid-template-columns: 1fr;
            }

            .cart-panel {
                position: relative;
                top: 0;
                max-height: none;
            }

            .chart-wrapper {
                height: 250px;
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
            }

            .main-content {
                margin-left: 0;
                padding: 15px;
            }

            .chart-filter {
                flex-direction: column;
                align-items: stretch;
            }

            .chart-wrapper {
                height: 200px;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h1 data-text="FMSTYLE">FMSTYLE</h1>
                <p>H·ªá Th·ªëng B√°n H√†ng</p>
            </div>
            <div class="user-info" id="user-info">
                Xin ch√†o, <span id="user-name">Nh√¢n vi√™n</span>
            </div>
            <div class="menu-item active" onclick="showPage('dashboard', this)">
                <span>T·ªïng Quan</span>
            </div>
            <div class="menu-item" onclick="showPage('products', this)">
                <span>Kho H√†ng H√≥a</span>
            </div>
            <div class="menu-item" onclick="showPage('create-order', this)">
                <span>T·∫°o H√≥a ƒê∆°n</span>
            </div>
            <div class="menu-item" onclick="showPage('orders', this)">
                <span>Danh S√°ch H√≥a ƒê∆°n</span>
            </div>
            <div class="menu-item" onclick="showPage('customers', this)">
                <span>Kh√°ch H√†ng</span>
            </div>
            <div class="menu-item" onclick="showPage('statistics', this)">
                <span>Th·ªëng K√™ Doanh Thu</span>
            </div>
            <div class="menu-item" onclick="showPage('lichsu', this)">
                <span>L·ªãch S·ª≠</span>
            </div>
            <!-- <div class="menu-item" onclick="showPage('phieunhap', this)">
                <span>Phi·∫øu Nh·∫≠p H√†ng</span>
            </div> -->
            <button class="logout-btn" onclick="logout()">ƒêƒÉng Xu·∫•t</button>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div id="page-content"></div>
            
            <!-- Invoice Detail Section (thay th·∫ø modal) -->
            <div id="invoice-detail-section" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; overflow-y: auto; padding: 20px;">
                <div style="max-width: 1000px; margin: 0 auto; background: white; border-radius: 12px; padding: 25px; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #e0e0e0;">
                        <h2 style="margin: 0; color: #1a2b48;">üìÑ Chi Ti·∫øt H√≥a ƒê∆°n</h2>
                        <button onclick="closeInvoiceDetailSection()" style="background: #dc2626; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: 600;">‚úï ƒê√≥ng</button>
                    </div>
                    <div id="invoice-detail-body" style="max-height: 70vh; overflow-y: auto;"></div>
                    <div style="margin-top: 20px; padding-top: 15px; border-top: 2px solid #e0e0e0; display: flex; gap: 10px; justify-content: flex-end;">
                        <button class="btn btn-secondary" onclick="closeInvoiceDetailSection()">ƒê√≥ng</button>
                        <button class="btn btn-success" id="print-invoice-btn" onclick="printInvoiceFromDetail()" style="display: none;">üñ®Ô∏è In H√≥a ƒê∆°n</button>
                        <button class="btn btn-primary" id="export-pdf-btn" onclick="exportPDFFromDetail()" style="display: none;">üìÑ Xu·∫•t PDF</button>
                    </div>
                </div>
            </div>
            
            <!-- Return Product Section (thay th·∫ø modal) -->
            <div id="return-product-section" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; overflow-y: auto; padding: 20px;">
                <div style="max-width: 700px; margin: 0 auto; background: white; border-radius: 12px; padding: 25px; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #e0e0e0;">
                        <h2 style="margin: 0; color: #e65100;">‚Ü©Ô∏è Tr·∫£ H√†ng</h2>
                        <button onclick="closeReturnProductSection()" style="background: #dc2626; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: 600;">‚úï ƒê√≥ng</button>
                    </div>
                    <div id="return-product-body"></div>
                </div>
            </div>
            
            <!-- Exchange Product Section (thay th·∫ø modal) -->
            <div id="exchange-product-section" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; overflow-y: auto; padding: 20px;">
                <div style="max-width: 700px; margin: 0 auto; background: white; border-radius: 12px; padding: 25px; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #e0e0e0;">
                        <h2 style="margin: 0; color: #1976d2;">üîÑ ƒê·ªïi H√†ng</h2>
                        <button onclick="closeExchangeProductSection()" style="background: #dc2626; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: 600;">‚úï ƒê√≥ng</button>
                    </div>
                    <div id="exchange-product-body"></div>
                </div>
            </div>
            
            <!-- New Supplier Section (Popup) -->
            <div id="new-supplier-section" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 9999; overflow-y: auto; padding: 20px; backdrop-filter: blur(5px);">
                <div style="max-width: 650px; margin: 20px auto; background: white; border-radius: 16px; padding: 0; box-shadow: 0 20px 60px rgba(0,0,0,0.3); animation: modalSlideIn 0.3s ease;">
                    <div style="background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); padding: 25px; border-radius: 16px 16px 0 0; color: white;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <h2 style="margin: 0; font-size: 22px; font-weight: 700; display: flex; align-items: center; gap: 10px;">
                                <span style="font-size: 32px;">üè¢</span>
                                <span>Th√™m Nh√† Cung C·∫•p M·ªõi</span>
                            </h2>
                            <button onclick="closeNewSupplierSection()" style="background: rgba(255,255,255,0.2); color: white; border: none; padding: 10px 16px; border-radius: 8px; cursor: pointer; font-size: 18px; font-weight: 600; transition: all 0.3s;"
                                    onmouseover="this.style.background='rgba(255,255,255,0.3)'" 
                                    onmouseout="this.style.background='rgba(255,255,255,0.2)'">‚úï</button>
                        </div>
                    </div>
                    
                    <div style="padding: 25px;">
                        <div style="background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); padding: 15px; border-radius: 10px; margin-bottom: 25px; border-left: 4px solid #ff9800;">
                            <p style="margin: 0; color: #e65100; font-size: 13px; display: flex; align-items: flex-start; gap: 10px; line-height: 1.6;">
                                <span style="font-size: 18px;">‚ÑπÔ∏è</span>
                                <span><strong>L∆∞u √Ω:</strong> M√£ nh√† cung c·∫•p s·∫Ω ƒë∆∞·ª£c t·ª± ƒë·ªông t·∫°o sau khi l∆∞u. Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin ƒë·ªÉ qu·∫£n l√Ω t·ªët h∆°n. Ch·ªâ c√≥ <strong>T√™n Nh√† Cung C·∫•p</strong> l√† b·∫Øt bu·ªôc.</span>
                            </p>
                        </div>
                        
                        <form id="new-supplier-form-section" onsubmit="saveNewSupplierFromSection(event)">
                            <div class="form-group">
                                <label style="display: flex; align-items: center; gap: 8px; font-size: 14px; font-weight: 600; color: #1a2b48; margin-bottom: 8px;">
                                    <span style="font-size: 20px;">üè∑Ô∏è</span>
                                    <span>T√™n Nh√† Cung C·∫•p <span style="color: #e74c3c;">*</span></span>
                                </label>
                                <input type="text" id="new-supplier-name-section" required placeholder="V√≠ d·ª•: C√¥ng ty TNHH ABC, C·ª≠a h√†ng XYZ..." 
                                       style="width: 100%; padding: 14px 18px; border: 2px solid #e8e8e8; border-radius: 10px; font-size: 14px; transition: all 0.3s ease; font-family: inherit;"
                                       onfocus="this.style.borderColor='#ff9800'; this.style.boxShadow='0 0 0 4px rgba(255, 152, 0, 0.15)'"
                                       onblur="this.style.borderColor='#e8e8e8'; this.style.boxShadow='none'">
                            </div>
                            
                            <div class="form-row" style="margin-top: 20px;">
                                <div class="form-group">
                                    <label style="display: flex; align-items: center; gap: 8px; font-size: 14px; font-weight: 600; color: #1a2b48; margin-bottom: 8px;">
                                        <span style="font-size: 20px;">üìû</span>
                                        <span>S·ªë ƒêi·ªán Tho·∫°i</span>
                                    </label>
                                    <input type="tel" id="new-supplier-phone-section" placeholder="0xxxxxxxxx" 
                                           pattern="[0-9]{10,11}" 
                                           style="width: 100%; padding: 14px 18px; border: 2px solid #e8e8e8; border-radius: 10px; font-size: 14px; transition: all 0.3s ease; font-family: inherit;"
                                           onfocus="this.style.borderColor='#ff9800'; this.style.boxShadow='0 0 0 4px rgba(255, 152, 0, 0.15)'"
                                           onblur="this.style.borderColor='#e8e8e8'; this.style.boxShadow='none'">
                                    <p style="font-size: 11px; color: #999; margin-top: 6px; margin-bottom: 0;">ƒê·ªãnh d·∫°ng: 10-11 ch·ªØ s·ªë</p>
                                </div>
                                <div class="form-group">
                                    <label style="display: flex; align-items: center; gap: 8px; font-size: 14px; font-weight: 600; color: #1a2b48; margin-bottom: 8px;">
                                        <span style="font-size: 20px;">üìß</span>
                                        <span>Email</span>
                                    </label>
                                    <input type="email" id="new-supplier-email-section" placeholder="example@company.com" 
                                           style="width: 100%; padding: 14px 18px; border: 2px solid #e8e8e8; border-radius: 10px; font-size: 14px; transition: all 0.3s ease; font-family: inherit;"
                                           onfocus="this.style.borderColor='#ff9800'; this.style.boxShadow='0 0 0 4px rgba(255, 152, 0, 0.15)'"
                                           onblur="this.style.borderColor='#e8e8e8'; this.style.boxShadow='none'">
                                    <p style="font-size: 11px; color: #999; margin-top: 6px; margin-bottom: 0;">ƒê·ªÉ tr·ªëng n·∫øu kh√¥ng c√≥</p>
                                </div>
                            </div>
                            
                            <div class="form-group" style="margin-top: 20px;">
                                <label style="display: flex; align-items: center; gap: 8px; font-size: 14px; font-weight: 600; color: #1a2b48; margin-bottom: 8px;">
                                    <span style="font-size: 20px;">üìç</span>
                                    <span>ƒê·ªãa Ch·ªâ</span>
                                </label>
                                <input type="text" id="new-supplier-address-section" placeholder="S·ªë nh√†, ƒë∆∞·ªùng, ph∆∞·ªùng/x√£, qu·∫≠n/huy·ªán, t·ªânh/th√†nh ph·ªë" 
                                       style="width: 100%; padding: 14px 18px; border: 2px solid #e8e8e8; border-radius: 10px; font-size: 14px; transition: all 0.3s ease; font-family: inherit;"
                                       onfocus="this.style.borderColor='#ff9800'; this.style.boxShadow='0 0 0 4px rgba(255, 152, 0, 0.15)'"
                                       onblur="this.style.borderColor='#e8e8e8'; this.style.boxShadow='none'">
                            </div>
                            
                            <div class="form-group" style="margin-top: 20px;">
                                <label style="display: flex; align-items: center; gap: 8px; font-size: 14px; font-weight: 600; color: #1a2b48; margin-bottom: 8px;">
                                    <span style="font-size: 20px;">üìù</span>
                                    <span>Ghi Ch√∫</span>
                                </label>
                                <textarea id="new-supplier-note-section" rows="4" placeholder="Ghi ch√∫ v·ªÅ nh√† cung c·∫•p: th·ªùi gian giao h√†ng, ph∆∞∆°ng th·ª©c thanh to√°n, ƒëi·ªÅu ki·ªán ƒë·∫∑c bi·ªát..." 
                                         style="width: 100%; padding: 14px 18px; border: 2px solid #e8e8e8; border-radius: 10px; font-size: 13px; font-family: inherit; resize: vertical; transition: all 0.3s ease;"
                                         onfocus="this.style.borderColor='#ff9800'; this.style.boxShadow='0 0 0 4px rgba(255, 152, 0, 0.15)'"
                                         onblur="this.style.borderColor='#e8e8e8'; this.style.boxShadow='none'"></textarea>
                                <p style="font-size: 11px; color: #999; margin-top: 6px; margin-bottom: 0;">C√≥ th·ªÉ ƒë·ªÉ tr·ªëng</p>
                            </div>
                            
                            <div style="display: flex; gap: 12px; margin-top: 30px; padding-top: 20px; border-top: 2px solid #f0f0f0;">
                                <button type="button" class="btn btn-outline" onclick="closeNewSupplierSection()" style="flex: 1; padding: 12px; font-size: 14px; font-weight: 600;">
                                    <span style="margin-right: 6px;">‚úï</span> H·ªßy
                                </button>
                                <button type="submit" class="btn btn-success" style="flex: 1; padding: 12px; font-size: 14px; font-weight: 600; background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); border: none;">
                                    <span style="margin-right: 6px;">üíæ</span> L∆∞u Nh√† Cung C·∫•p
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification Section -->
    <div id="notification-section" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 9999; overflow-y: auto; padding: 20px; backdrop-filter: blur(5px);">
        <div style="max-width: 900px; margin: 20px auto; background: white; border-radius: 16px; padding: 0; box-shadow: 0 20px 60px rgba(0,0,0,0.3); animation: modalSlideIn 0.3s ease;">
            <div style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%); padding: 25px; border-radius: 16px 16px 0 0; color: white;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h2 style="margin: 0; font-size: 22px; font-weight: 700; display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 32px;">üîî</span>
                        <span>Th√¥ng B√°o H·ªá Th·ªëng</span>
                    </h2>
                    <button onclick="closeNotificationSection()" style="background: rgba(255,255,255,0.2); color: white; border: none; padding: 10px 16px; border-radius: 8px; cursor: pointer; font-size: 18px; font-weight: 600; transition: all 0.3s;"
                            onmouseover="this.style.background='rgba(255,255,255,0.3)'" 
                            onmouseout="this.style.background='rgba(255,255,255,0.2)'">‚úï</button>
                </div>
            </div>
            
            <div style="padding: 25px;">
                <!-- Low Stock Warnings -->
                <div id="notification-low-stock" style="margin-bottom: 25px;">
                    <div style="background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); padding: 20px; border-radius: 12px; border-left: 5px solid #ff9800; margin-bottom: 15px;">
                        <h3 style="margin: 0 0 15px 0; color: #e65100; font-size: 18px; font-weight: 700; display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 24px;">‚ö†Ô∏è</span>
                            <span>C·∫£nh B√°o H√†ng T·ªìn Kho Th·∫•p</span>
                        </h3>
                        <div id="low-stock-list" style="display: grid; gap: 10px;"></div>
                    </div>
                </div>
                
                <div id="notification-slow-moving" style="margin-bottom: 25px;">
                    <div style="background: linear-gradient(135deg, #fce4ec 0%, #f8bbd0 100%); padding: 20px; border-radius: 12px; border-left: 5px solid #e91e63; margin-bottom: 15px;">
                        <h3 style="margin: 0 0 15px 0; color: #c2185b; font-size: 18px; font-weight: 700; display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 24px;">üêå</span>
                            <span>C·∫£nh B√°o H√†ng T·ªìn B√°n Ch·∫≠m</span>
                        </h3>
                        <div id="slow-moving-list" style="display: grid; gap: 10px;"></div>
                    </div>
                </div>
                
                <!-- Empty State -->
                <div id="notification-empty" style="text-align: center; padding: 40px 20px; display: none;">
                    <div style="font-size: 64px; margin-bottom: 15px;">‚úÖ</div>
                    <h3 style="color: #4caf50; font-size: 20px; margin-bottom: 10px;">Kh√¥ng c√≥ c·∫£nh b√°o</h3>
                    <p style="color: #999; font-size: 14px;">T·∫•t c·∫£ s·∫£n ph·∫©m ƒë·ªÅu trong tr·∫°ng th√°i t·ªët!</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container" class="toast-container"></div>

    <!-- Customer Modal -->
    <div id="customer-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Ch·ªçn Kh√°ch H√†ng</h3>
                <button class="close-btn" onclick="closeCustomerModal()">√ó</button>
            </div>
            <div id="customer-modal-body"></div>
        </div>
    </div>

    <!-- New Customer Modal -->
    <div id="new-customer-modal" class="modal">
        <div class="modal-content" style="max-width: 700px; padding: 35px;">
            <div class="modal-header">
                <h3>Th√™m Kh√°ch H√†ng M·ªõi</h3>
                <button class="close-btn" onclick="closeNewCustomerModal()">√ó</button>
            </div>
            <form id="new-customer-form" onsubmit="saveNewCustomer(event)">
                <div class="form-group">
                    <label>H·ªç T√™n *</label>
                    <input type="text" id="new-cust-name" required placeholder="Nh·∫≠p h·ªç t√™n" style="padding: 12px 16px; font-size: 14px;">
                    <p style="font-size: 11px; color: #999; margin-top: 5px;">M√£ kh√°ch h√†ng s·∫Ω ƒë∆∞·ª£c t·ª± ƒë·ªông sinh</p>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>S·ªë ƒêi·ªán Tho·∫°i</label>
                        <input type="text" id="new-cust-phone" placeholder="0xxxxxxxxx" style="padding: 12px 16px; font-size: 14px;">
                    </div>
                    <div class="form-group">
                        <label>Ph√¢n Lo·∫°i KH *</label>
                        <select id="new-cust-type" required disabled style="background-color: #f5f5f5; cursor: not-allowed; padding: 12px 16px; font-size: 14px;"></select>
                        <input type="hidden" id="new-cust-type-hidden" name="idPLKH">
                        <p style="font-size: 11px; color: #999; margin-top: 5px;">M·∫∑c ƒë·ªãnh: Kh√°ch L·∫ª (kh√¥ng th·ªÉ thay ƒë·ªïi)</p>
                    </div>
                </div>
                <div class="form-group">
                    <label>ƒê·ªãa Ch·ªâ</label>
                    <input type="text" id="new-cust-address" placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ" style="padding: 12px 16px; font-size: 14px;">
                </div>
                <div class="form-actions" style="margin-top: 25px; padding-top: 20px; border-top: 2px solid #f0f0f0;">
                    <button type="button" class="btn btn-outline" onclick="closeNewCustomerModal()">H·ªßy</button>
                    <button type="submit" class="btn btn-success">L∆∞u Kh√°ch H√†ng</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Success Modal -->
    <div id="success-modal" class="modal">
        <div class="modal-content" style="text-align: center;">
            <div style="font-size: 60px; margin-bottom: 15px;">‚úÖ</div>
            <h3 style="color: #00b894; margin-bottom: 10px;">T·∫°o H√≥a ƒê∆°n Th√†nh C√¥ng!</h3>
            <p id="success-message" style="color: #666; margin-bottom: 20px; font-size: 13px;"></p>
            <div class="form-actions" style="justify-content: center;">
                <button class="btn btn-secondary" onclick="closeSuccessModal()">ƒê√≥ng</button>
                <button class="btn btn-success" onclick="printInvoice()">In H√≥a ƒê∆°n</button>
            </div>
        </div>
    </div>

    <!-- Invoice Detail Modal -->
    <div id="invoice-detail-modal" class="modal">
        <div class="modal-content" style="max-width: 900px; width: 95%;">
            <div class="modal-header" style="background: linear-gradient(135deg, #d4e7e6 0%, #4a90e2 100%); color: white; border-radius: 12px 12px 0 0; margin: -25px -25px 20px -25px; padding: 20px 25px;">
                <h3 style="color: white; margin: 0; font-size: 20px;">üìÑ Chi Ti·∫øt H√≥a ƒê∆°n</h3>
                <button class="close-btn" onclick="closeInvoiceDetailModal()" style="background: rgba(255,255,255,0.2); color: white;">√ó</button>
            </div>
            <div id="invoice-detail-body" style="max-height: 75vh; overflow-y: auto; padding: 0 5px;"></div>
            <div class="form-actions" style="margin-top: 20px; padding-top: 15px; border-top: 2px solid #f0f0f0;">
                <button class="btn btn-secondary" onclick="closeInvoiceDetailModal()">ƒê√≥ng</button>
                <button class="btn btn-success" id="print-invoice-btn" onclick="printInvoiceFromDetail()" style="display: none;">üñ®Ô∏è In H√≥a ƒê∆°n</button>
                <button class="btn btn-primary" id="export-pdf-btn" onclick="exportPDFFromDetail()" style="display: none;">üìÑ Xu·∫•t PDF</button>
            </div>
        </div>
    </div>

    <!-- Return Product Modal -->
    <div id="return-product-modal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3>Tr·∫£ H√†ng</h3>
                <button class="close-btn" onclick="closeReturnProductModal()">√ó</button>
            </div>
            <div id="return-product-body"></div>
        </div>
    </div>

    <!-- Exchange Product Modal -->
    <div id="exchange-product-modal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3>ƒê·ªïi H√†ng</h3>
                <button class="close-btn" onclick="closeExchangeProductModal()">√ó</button>
            </div>
            <div id="exchange-product-body"></div>
        </div>
    </div>

    <!-- New Supplier Modal -->
    <div id="new-supplier-modal" class="modal">
        <div class="modal-content" style="max-width: 650px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); color: white; border-radius: 12px 12px 0 0; margin: -25px -25px 20px -25px; padding: 20px 25px;">
                <h3 style="color: white; margin: 0; font-size: 20px; display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 28px;">üè¢</span>
                    <span>Th√™m Nh√† Cung C·∫•p M·ªõi</span>
                </h3>
                <button class="close-btn" onclick="closeNewSupplierModal()" style="background: rgba(255,255,255,0.2); color: white;">√ó</button>
            </div>
            
            <div style="background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); padding: 12px 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #ff9800;">
                <p style="margin: 0; color: #e65100; font-size: 12px; display: flex; align-items: center; gap: 8px;">
                    <span>‚ÑπÔ∏è</span>
                    <span>M√£ nh√† cung c·∫•p s·∫Ω ƒë∆∞·ª£c t·ª± ƒë·ªông t·∫°o sau khi l∆∞u. Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin ƒë·ªÉ qu·∫£n l√Ω t·ªët h∆°n.</span>
                </p>
            </div>
            
            <form id="new-supplier-form" onsubmit="saveNewSupplier(event)">
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 6px;">
                        <span>üè∑Ô∏è</span>
                        <span>T√™n Nh√† Cung C·∫•p <span style="color: #e74c3c;">*</span></span>
                    </label>
                    <input type="text" id="new-supplier-name" required placeholder="V√≠ d·ª•: C√¥ng ty TNHH ABC, C·ª≠a h√†ng XYZ..." 
                           style="width: 100%; padding: 12px 16px; border: 2px solid #e8e8e8; border-radius: 8px; font-size: 14px; transition: all 0.3s ease;"
                           onfocus="this.style.borderColor='#ff9800'; this.style.boxShadow='0 0 0 3px rgba(255, 152, 0, 0.1)'"
                           onblur="this.style.borderColor='#e8e8e8'; this.style.boxShadow='none'">
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 6px;">
                            <span>üìû</span>
                            <span>S·ªë ƒêi·ªán Tho·∫°i</span>
                        </label>
                        <input type="tel" id="new-supplier-phone" placeholder="0xxxxxxxxx ho·∫∑c 0xxx xxx xxx" 
                               pattern="[0-9]{10,11}" 
                               style="width: 100%; padding: 12px 16px; border: 2px solid #e8e8e8; border-radius: 8px; font-size: 14px; transition: all 0.3s ease;"
                               onfocus="this.style.borderColor='#ff9800'; this.style.boxShadow='0 0 0 3px rgba(255, 152, 0, 0.1)'"
                               onblur="this.style.borderColor='#e8e8e8'; this.style.boxShadow='none'">
                        <p style="font-size: 11px; color: #999; margin-top: 5px; margin-bottom: 0;">ƒê·ªãnh d·∫°ng: 10-11 ch·ªØ s·ªë</p>
                    </div>
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 6px;">
                            <span>üìß</span>
                            <span>Email</span>
                        </label>
                        <input type="email" id="new-supplier-email" placeholder="example@company.com" 
                               style="width: 100%; padding: 12px 16px; border: 2px solid #e8e8e8; border-radius: 8px; font-size: 14px; transition: all 0.3s ease;"
                               onfocus="this.style.borderColor='#ff9800'; this.style.boxShadow='0 0 0 3px rgba(255, 152, 0, 0.1)'"
                               onblur="this.style.borderColor='#e8e8e8'; this.style.boxShadow='none'">
                        <p style="font-size: 11px; color: #999; margin-top: 5px; margin-bottom: 0;">ƒê·ªÉ tr·ªëng n·∫øu kh√¥ng c√≥</p>
                    </div>
                </div>
                
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 6px;">
                        <span>üìç</span>
                        <span>ƒê·ªãa Ch·ªâ</span>
                    </label>
                    <input type="text" id="new-supplier-address" placeholder="S·ªë nh√†, ƒë∆∞·ªùng, ph∆∞·ªùng/x√£, qu·∫≠n/huy·ªán, t·ªânh/th√†nh ph·ªë" 
                           style="width: 100%; padding: 12px 16px; border: 2px solid #e8e8e8; border-radius: 8px; font-size: 14px; transition: all 0.3s ease;"
                           onfocus="this.style.borderColor='#ff9800'; this.style.boxShadow='0 0 0 3px rgba(255, 152, 0, 0.1)'"
                           onblur="this.style.borderColor='#e8e8e8'; this.style.boxShadow='none'">
                </div>
                
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 6px;">
                        <span>üìù</span>
                        <span>Ghi Ch√∫</span>
                    </label>
                    <textarea id="new-supplier-note" rows="4" placeholder="Ghi ch√∫ v·ªÅ nh√† cung c·∫•p: th·ªùi gian giao h√†ng, ph∆∞∆°ng th·ª©c thanh to√°n, ƒëi·ªÅu ki·ªán ƒë·∫∑c bi·ªát..." 
                             style="width: 100%; padding: 12px 16px; border: 2px solid #e8e8e8; border-radius: 8px; font-size: 13px; font-family: inherit; resize: vertical; transition: all 0.3s ease;"
                             onfocus="this.style.borderColor='#ff9800'; this.style.boxShadow='0 0 0 3px rgba(255, 152, 0, 0.1)'"
                             onblur="this.style.borderColor='#e8e8e8'; this.style.boxShadow='none'"></textarea>
                    <p style="font-size: 11px; color: #999; margin-top: 5px; margin-bottom: 0;">C√≥ th·ªÉ ƒë·ªÉ tr·ªëng</p>
                </div>
                
                <div class="form-actions" style="margin-top: 25px; padding-top: 20px; border-top: 2px solid #f0f0f0;">
                    <button type="button" class="btn btn-outline" onclick="closeNewSupplierModal()" style="flex: 1;">
                        <span style="margin-right: 5px;">‚úï</span> H·ªßy
                    </button>
                    <button type="submit" class="btn btn-success" style="flex: 1; background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); border: none;">
                        <span style="margin-right: 5px;">üíæ</span> L∆∞u Nh√† Cung C·∫•p
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- New Product Modal -->
    <div id="new-product-modal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3>‚ûï Th√™m H√†ng H√≥a M·ªõi</h3>
                <button class="close-btn" onclick="closeNewProductModal()">√ó</button>
            </div>
            <form id="new-product-form" onsubmit="saveNewProduct(event)">
                <div class="form-group">
                    <label>T√™n H√†ng *</label>
                    <input type="text" id="new-product-name" required placeholder="Nh·∫≠p t√™n h√†ng h√≥a">
                </div>
                <div class="form-group">
                    <label>Ph√¢n Lo·∫°i S·∫£n Ph·∫©m *</label>
                    <select id="new-product-type" required>
                        <option value="">-- Ch·ªçn ph√¢n lo·∫°i --</option>
                    </select>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Gi√° Nh·∫≠p *</label>
                        <input type="number" id="new-product-gianhap" required min="0" step="1000" placeholder="0">
                    </div>
                    <div class="form-group">
                        <label>Gi√° B√°n *</label>
                        <input type="number" id="new-product-giaban" required min="0" step="1000" placeholder="0">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>S·ªë L∆∞·ª£ng Nh·∫≠p</label>
                        <input type="number" id="new-product-soluong" min="0" value="0" placeholder="0">
                    </div>
                    <div class="form-group">
                        <label>T·ªìn Kho T·ªëi Thi·ªÉu</label>
                        <input type="number" id="new-product-tonkho" min="0" value="10" placeholder="10">
                    </div>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-outline" onclick="closeNewProductModal()">H·ªßy</button>
                    <button type="submit" class="btn btn-success">Th√™m H√†ng H√≥a</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Phi·∫øu Nh·∫≠p Detail Section -->
    <div id="phieunhap-detail-section" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; overflow-y: auto; padding: 20px;">
        <div style="max-width: 1000px; margin: 0 auto; background: white; border-radius: 12px; padding: 0; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0; padding: 20px 25px; border-bottom: 2px solid #e0e0e0; background: #f8f9fa; border-radius: 12px 12px 0 0;">
                <h2 style="margin: 0; color: #1a2b48; font-size: 20px; font-weight: 700;">üìã Chi Ti·∫øt Phi·∫øu Nh·∫≠p H√†ng</h2>
                <button onclick="closePhieuNhapDetailSection()" style="background: #dc2626; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: 600; transition: all 0.3s;" onmouseover="this.style.background='#b91c1c'" onmouseout="this.style.background='#dc2626'">‚úï ƒê√≥ng</button>
            </div>
            <div id="phieunhap-detail-body" style="max-height: 75vh; overflow-y: auto;"></div>
            <div style="margin-top: 0; padding: 20px 25px; border-top: 2px solid #e0e0e0; display: flex; gap: 10px; justify-content: flex-end; background: #f8f9fa; border-radius: 0 0 12px 12px;">
                <button class="btn btn-secondary" onclick="closePhieuNhapDetailSection()">ƒê√≥ng</button>
            </div>
        </div>
    </div>

    <!-- New Phi·∫øu Nh·∫≠p Section -->
    <div id="new-phieunhap-section" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; overflow-y: auto; padding: 20px;">
        <div style="max-width: 1200px; margin: 0 auto; background: white; border-radius: 12px; padding: 0; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0; padding: 20px 25px; border-bottom: 2px solid #e0e0e0; background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); border-radius: 12px 12px 0 0;">
                <h2 style="margin: 0; color: #e65100; font-size: 20px; font-weight: 700;">‚ûï T·∫°o Phi·∫øu Nh·∫≠p H√†ng M·ªõi</h2>
                <button onclick="closeNewPhieuNhapSection()" style="background: #dc2626; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: 600; transition: all 0.3s;" onmouseover="this.style.background='#b91c1c'" onmouseout="this.style.background='#dc2626'">‚úï ƒê√≥ng</button>
            </div>
            <div id="new-phieunhap-body" style="max-height: 80vh; overflow-y: auto;"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3000/api';
        let currentPage = 'dashboard';
        let products = [];
        let customers = [];
        let customerTypes = [];
        let cart = [];
        let selectedCustomer = null;
        let appliedDiscount = null;
        let lastInvoiceId = null;
        let nhanvienList = [];
        let discountList = [];
        let currentUser = null;
        let phanLoaiSanPhamList = []; // Danh s√°ch ph√¢n lo·∫°i s·∫£n ph·∫©m
        let currentUserNhanVien = null; // Th√¥ng tin nh√¢n vi√™n hi·ªán t·∫°i (bao g·ªìm v·ªã tr√≠)
        let nhacungcapList = []; // Danh s√°ch nh√† cung c·∫•p

        // Initialize
        window.onload = async function () {
            // Check login
            const user = JSON.parse(localStorage.getItem("user"));
            if (!user) {
                window.location.href = "login.html";
                return;
            }
            currentUser = user;
            document.getElementById('user-name').textContent = user.username || 'Nh√¢n vi√™n';

            await loadInitialData();
            showPage('dashboard');
        };

        // Logout
        function logout() {
            localStorage.removeItem("user");
            window.location.href = "login.html";
        }

        // Load initial data
        async function loadInitialData() {
            try {
                const [productsRes, customersRes, nhanvienRes, discountRes, typesRes, phanLoaiSPRes, nhacungcapRes] = await Promise.all([
                    fetch(`${API_BASE}/hanghoa`),
                    fetch(`${API_BASE}/khachhang`),
                    fetch(`${API_BASE}/nhanvien`),
                    fetch(`${API_BASE}/khuyenmai`), // Schema m·ªõi: KHUYENMAI thay v√¨ MAGIAMGIA
                    fetch(`${API_BASE}/phanloaikh`),
                    fetch(`${API_BASE}/phanloaisanpham`),
                    fetch(`${API_BASE}/nhacungcap`)
                ]);

                const productsData = await productsRes.json();
                const customersData = await customersRes.json();
                const nhanvienData = await nhanvienRes.json();
                const discountData = await discountRes.json();
                const typesData = await typesRes.json();
                const phanLoaiSPData = await phanLoaiSPRes.json();
                const nhacungcapData = await nhacungcapRes.json();

                if (productsData.success) {
                    products = productsData.data;
                    // Update notification badge if on dashboard
                    if (currentPage === 'dashboard') {
                        updateNotificationBadge();
                    }
                }
                if (customersData.success) customers = customersData.data;
                if (nhanvienData.success) {
                    nhanvienList = nhanvienData.data;
                    // T√¨m nh√¢n vi√™n hi·ªán t·∫°i d·ª±a v√†o idNV t·ª´ currentUser
                    if (currentUser && currentUser.idNV) {
                        currentUserNhanVien = nhanvienData.data.find(nv => nv.id === currentUser.idNV);
                    }
                }
                if (typesData.success) customerTypes = typesData.data;
                if (phanLoaiSPData.success) phanLoaiSanPhamList = phanLoaiSPData.data;
                if (nhacungcapData.success) nhacungcapList = nhacungcapData.data;
                
                // Ch·ªâ l·∫•y khuy·∫øn m√£i c√≤n hi·ªáu l·ª±c
                // Schema m·ªõi: KHUYENMAI c√≥ ngayBD, ngayKT, trangthai (computed)
                if (discountData.success) {
                    const today = new Date().toISOString().split('T')[0];
                    discountList = discountData.data.filter(d => {
                        // H·ªó tr·ª£ c·∫£ schema c≈© v√† m·ªõi
                        if (d.trangthai !== undefined && d.trangthai !== 1 && d.trangthai !== true) return false;
                        const ngayKT = d.ngayKT || d.ngayketthuc;
                        if (ngayKT && ngayKT < today) return false;
                        // Schema m·ªõi kh√¥ng c√≥ gioihan/soluongsudung
                        if (d.gioihan && d.soluongsudung >= d.gioihan) return false;
                        return true;
                    });
                }
            } catch (error) {
                console.error('Error loading data:', error);
                showToast('L·ªói k·∫øt n·ªëi server', 'error');
            }
        }

        // Show page
        function showPage(pageName, element) {
            currentPage = pageName;
            document.querySelectorAll('.menu-item').forEach(item => item.classList.remove('active'));
            if (element) element.classList.add('active');

            switch (pageName) {
                case 'dashboard': renderDashboard(); break;
                case 'products': renderProducts(); break;
                case 'create-order': renderCreateOrder(); break;
                case 'orders': renderOrders(); break;
                case 'customers': renderCustomers(); break;
                case 'statistics': renderStatistics(); break;
                case 'phieunhap': renderPhieuNhap(); break;
                case 'create-phieunhap': renderCreatePhieuNhap(); break;
                case 'lichsu': renderLichSu(); break;
            }
        }

        // ==================== DASHBOARD ====================
        let revenueChart = null;
        let ordersChart = null;

        async function renderDashboard() {
            const content = document.getElementById('page-content');
            const today = new Date();
            const currentMonth = today.getMonth() + 1;
            const currentYear = today.getFullYear();
            const startDate = new Date(currentYear, currentMonth - 1, 1);
            const endDate = new Date(currentYear, currentMonth, 0);
            
            content.innerHTML = `
                <div class="page-header">
                    <div>
                        <h2>T·ªïng Quan H·ªá Th·ªëng</h2>
                        <p>Th·ªëng k√™ nhanh ho·∫°t ƒë·ªông kinh doanh</p>
                    </div>
                    <div>
                        <button onclick="openNotificationSection()" style="position: relative; background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%); color: white; border: none; padding: 12px 24px; border-radius: 10px; cursor: pointer; font-size: 15px; font-weight: 600; box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3); transition: all 0.3s; display: flex; align-items: center; gap: 8px;"
                                onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(255, 107, 107, 0.4)'"
                                onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(255, 107, 107, 0.3)'">
                            <span style="font-size: 20px;">üîî</span>
                            <span>Th√¥ng B√°o</span>
                            <span id="notification-badge" style="position: absolute; top: -8px; right: -8px; background: #fff; color: #ff6b6b; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 700; box-shadow: 0 2px 8px rgba(0,0,0,0.2);">0</span>
                        </button>
                    </div>
                </div>
                <div class="stats-row">
                    <div class="stat-card blue">
                        <h3 id="stat-products">0</h3>
                        <p>S·∫£n ph·∫©m trong kho</p>
                    </div>
                    <div class="stat-card green">
                        <h3 id="stat-customers">0</h3>
                        <p>Kh√°ch h√†ng</p>
                    </div>
                    <div class="stat-card orange">
                        <h3 id="stat-orders">0</h3>
                        <p>H√≥a ƒë∆°n h√¥m nay</p>
                    </div>
                    <div class="stat-card purple">
                        <h3 id="stat-revenue">0ƒë</h3>
                        <p>Doanh thu h√¥m nay</p>
                    </div>
                </div>
                
                <!-- Charts Row -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
                    <!-- Revenue Chart -->
                    <div class="chart-container">
                        <div class="chart-header">
                            <div class="chart-title">üìà Bi·ªÉu ƒê·ªì Doanh Thu</div>
                            <div class="chart-filter">
                                <select id="revenue-period" onchange="updateDashboardCharts()">
                                    <option value="day">Theo Ng√†y</option>
                                    <option value="month" selected>Theo Th√°ng</option>
                                    <option value="year">Theo NƒÉm</option>
                                </select>
                                <select id="revenue-year" onchange="updateDashboardCharts()" style="display: none;">
                                    ${Array.from({length: 5}, (_, i) => {
                                        const year = currentYear - i;
                                        return `<option value="${year}" ${i === 0 ? 'selected' : ''}>${year}</option>`;
                                    }).join('')}
                                </select>
                                <input type="month" id="revenue-month" onchange="updateDashboardCharts()" 
                                       value="${currentYear}-${String(currentMonth).padStart(2, '0')}" 
                                       style="display: none;">
                </div>
                        </div>
                        <div class="chart-wrapper">
                            <canvas id="revenue-chart"></canvas>
                        </div>
                    </div>
                    
                    <!-- Orders Chart -->
                    <div class="chart-container">
                        <div class="chart-header">
                            <div class="chart-title">üìä Bi·ªÉu ƒê·ªì S·ªë ƒê∆°n H√†ng</div>
                            <div class="chart-filter">
                                <select id="orders-period" onchange="updateDashboardCharts()">
                                    <option value="day">Theo Ng√†y</option>
                                    <option value="month" selected>Theo Th√°ng</option>
                                    <option value="year">Theo NƒÉm</option>
                                </select>
                                <select id="orders-year" onchange="updateDashboardCharts()" style="display: none;">
                                    ${Array.from({length: 5}, (_, i) => {
                                        const year = currentYear - i;
                                        return `<option value="${year}" ${i === 0 ? 'selected' : ''}>${year}</option>`;
                                    }).join('')}
                                </select>
                                <input type="month" id="orders-month" onchange="updateDashboardCharts()" 
                                       value="${currentYear}-${String(currentMonth).padStart(2, '0')}" 
                                       style="display: none;">
                            </div>
                        </div>
                        <div class="chart-wrapper">
                            <canvas id="orders-chart"></canvas>
                        </div>
                    </div>
                </div>
                
                <!-- Top Lists Row -->
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-top: 20px;">
                    <!-- Top Employees -->
                    <div class="top-list-container">
                        <div class="panel-title">üë• Top Nh√¢n Vi√™n B√°n Ch·∫°y</div>
                        <div id="top-employees-list"></div>
                    </div>
                    
                    <!-- Loyal Customers -->
                    <div class="top-list-container">
                        <div class="panel-title">‚≠ê Kh√°ch H√†ng Th√¢n Thi·∫øt</div>
                        <div id="loyal-customers-list"></div>
                    </div>
                    
                    <!-- Best Selling Products -->
                    <div class="top-list-container">
                        <div class="panel-title">üî• S·∫£n Ph·∫©m B√°n Ch·∫°y</div>
                        <div id="best-products-list"></div>
                    </div>
                </div>
                
                <!-- Supplier Statistics Section -->
                <div style="margin-top: 30px;">
                    <div class="panel-title" style="margin-bottom: 20px; font-size: 20px; font-weight: 700; color: #1a2b48;">
                        üè¢ Th·ªëng K√™ Nh√† Cung C·∫•p
                    </div>
                    
                    <!-- Supplier Metrics Cards -->
                    <div id="supplier-metrics-cards" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 15px; margin-bottom: 25px;"></div>
                    
                    <!-- Supplier Content Row -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <!-- Top Suppliers -->
                        <div class="top-list-container">
                            <div class="panel-title">‚≠ê Top Nh√† Cung C·∫•p Theo Gi√° Tr·ªã</div>
                            <div id="top-suppliers-list"></div>
                        </div>
                        
                        <!-- Supplier Summary Details -->
                        <div class="top-list-container">
                            <div class="panel-title">üìà Chi Ti·∫øt Th·ªëng K√™</div>
                            <div id="supplier-summary"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Warnings and Info -->
                <div id="stock-warnings"></div>
                <div id="slow-moving-warning"></div>
            `;

            try {
                const [ordersRes] = await Promise.all([
                    fetch(`${API_BASE}/hoadon`)
                ]);

                const ordersData = await ordersRes.json();

                document.getElementById('stat-products').textContent = products.length;
                document.getElementById('stat-customers').textContent = customers.length;

                if (ordersData.success) {
                    const today = new Date().toISOString().split('T')[0];
                    const todayOrders = ordersData.data.filter(o => o.ngayLap && o.ngayLap.startsWith(today));
                    document.getElementById('stat-orders').textContent = todayOrders.length;
                    const todayRevenue = todayOrders.reduce((sum, o) => sum + (parseFloat(o.tongTien) || 0), 0);
                    document.getElementById('stat-revenue').textContent = formatCurrency(todayRevenue);
                }

                // Load dashboard data
                await loadDashboardData();
                
                // Setup chart filters
                setupChartFilters();
            } catch (error) {
                console.error('Error loading dashboard:', error);
            }
        }

        function setupChartFilters() {
            const revenuePeriod = document.getElementById('revenue-period');
            const ordersPeriod = document.getElementById('orders-period');
            
            if (revenuePeriod) {
                revenuePeriod.addEventListener('change', function() {
                    const period = this.value;
                    const yearSelect = document.getElementById('revenue-year');
                    const monthInput = document.getElementById('revenue-month');
                    if (period === 'year') {
                        yearSelect.style.display = 'inline-block';
                        monthInput.style.display = 'none';
                    } else if (period === 'month') {
                        yearSelect.style.display = 'none';
                        monthInput.style.display = 'inline-block';
                    } else {
                        yearSelect.style.display = 'none';
                        monthInput.style.display = 'none';
                    }
                });
            }
            
            if (ordersPeriod) {
                ordersPeriod.addEventListener('change', function() {
                    const period = this.value;
                    const yearSelect = document.getElementById('orders-year');
                    const monthInput = document.getElementById('orders-month');
                    if (period === 'year') {
                        yearSelect.style.display = 'inline-block';
                        monthInput.style.display = 'none';
                    } else if (period === 'month') {
                        yearSelect.style.display = 'none';
                        monthInput.style.display = 'inline-block';
                    } else {
                        yearSelect.style.display = 'none';
                        monthInput.style.display = 'none';
                    }
                });
            }
        }

        async function loadDashboardData() {
            try {
                // Load charts
                await loadRevenueChart();
                await loadOrdersChart();
                
                // Load top employees
                await loadTopEmployees();
                
                // Load loyal customers
                loadLoyalCustomers();
                
                // Load best selling products
                await loadBestSellingProducts();
                
                // Load stock warnings
                renderStockWarnings();

                // Load slow moving products
                await loadSlowMovingProducts();
                
                // Load supplier statistics
                await loadSupplierStatistics();
                
                // Update notification badge
                updateNotificationBadge();
            } catch (error) {
                console.error('Error loading dashboard data:', error);
            }
        }

        async function updateDashboardCharts() {
            await loadRevenueChart();
            await loadOrdersChart();
        }

        async function loadRevenueChart() {
            try {
                const period = document.getElementById('revenue-period')?.value || 'month';
                let url = `${API_BASE}/thongke/doanhthu?period=${period}`;
                
                if (period === 'month') {
                    const monthInput = document.getElementById('revenue-month')?.value;
                    if (monthInput) {
                        const [year, month] = monthInput.split('-');
                        const startDate = `${year}-${month}-01`;
                        const lastDay = new Date(year, month, 0).getDate();
                        const endDate = `${year}-${month}-${lastDay}`;
                        url += `&startDate=${startDate}&endDate=${endDate}`;
                    }
                } else if (period === 'year') {
                    const year = document.getElementById('revenue-year')?.value || new Date().getFullYear();
                    url += `&startDate=${year}-01-01&endDate=${year}-12-31`;
                } else {
                    // Day: last 30 days
                    const endDate = new Date();
                    const startDate = new Date();
                    startDate.setDate(startDate.getDate() - 30);
                    url += `&startDate=${startDate.toISOString().split('T')[0]}&endDate=${endDate.toISOString().split('T')[0]}`;
                }
                
                const response = await fetch(url);
                const result = await response.json();
                
                if (result.success && result.data) {
                    const data = result.data;
                    let labels = [];
                    let revenues = [];
                    
                    if (period === 'day') {
                        // Group by date
                        const grouped = {};
                        data.forEach(item => {
                            const date = item.ngay || item.ngayLap?.split('T')[0];
                            if (date) {
                                if (!grouped[date]) grouped[date] = 0;
                                grouped[date] += parseFloat(item.tongDoanhThu || 0);
                            }
                        });
                        labels = Object.keys(grouped).sort();
                        revenues = labels.map(date => grouped[date]);
                    } else if (period === 'month') {
                        // Group by month
                        const grouped = {};
                        data.forEach(item => {
                            const key = `${item.nam || new Date().getFullYear()}-${String(item.thang || 1).padStart(2, '0')}`;
                            if (!grouped[key]) grouped[key] = 0;
                            grouped[key] += parseFloat(item.tongDoanhThu || 0);
                        });
                        labels = Object.keys(grouped).sort();
                        revenues = labels.map(key => grouped[key]);
                        labels = labels.map(key => {
                            const [y, m] = key.split('-');
                            return `Th√°ng ${m}/${y}`;
                        });
                    } else if (period === 'year') {
                        // Group by year
                        const grouped = {};
                        data.forEach(item => {
                            const year = item.nam || new Date().getFullYear();
                            if (!grouped[year]) grouped[year] = 0;
                            grouped[year] += parseFloat(item.tongDoanhThu || 0);
                        });
                        labels = Object.keys(grouped).sort();
                        revenues = labels.map(year => grouped[year]);
                        labels = labels.map(year => `NƒÉm ${year}`);
                    }
                    
                    const ctx = document.getElementById('revenue-chart');
                    if (!ctx) return;
                    
                    if (revenueChart) {
                        revenueChart.destroy();
                    }
                    
                    revenueChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Doanh Thu',
                                data: revenues,
                                borderColor: '#4a90e2',
                                backgroundColor: 'rgba(74, 144, 226, 0.1)',
                                borderWidth: 3,
                                pointRadius: 5,
                                pointHoverRadius: 7,
                                pointBackgroundColor: '#4a90e2',
                                pointBorderColor: '#ffffff',
                                pointBorderWidth: 2,
                                tension: 0.4,
                                fill: true,
                                pointHoverBackgroundColor: '#4a90e2',
                                pointHoverBorderColor: '#ffffff'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            interaction: {
                                intersect: false,
                                mode: 'index'
                            },
                            plugins: {
                                legend: {
                                    display: false
                                },
                                tooltip: {
                                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                    padding: 12,
                                    titleFont: {
                                        size: 14,
                                        weight: 'bold'
                                    },
                                    bodyFont: {
                                        size: 13
                                    },
                                    callbacks: {
                                        label: function(context) {
                                            return 'Doanh thu: ' + formatCurrency(context.parsed.y);
                                        }
                                    }
                                }
                            },
                            scales: {
                                x: {
                                    grid: {
                                        display: false
                                    },
                                    ticks: {
                                        font: {
                                            size: 11
                                        }
                                    }
                                },
                                y: {
                                    beginAtZero: true,
                                    grid: {
                                        color: 'rgba(0, 0, 0, 0.05)'
                                    },
                                    ticks: {
                                        callback: function(value) {
                                            return formatCurrency(value);
                                        },
                                        font: {
                                            size: 11
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
            } catch (error) {
                console.error('Error loading revenue chart:', error);
            }
        }

        async function loadOrdersChart() {
            try {
                const period = document.getElementById('orders-period')?.value || 'month';
                let url = `${API_BASE}/thongke/doanhthu?period=${period}`;
                
                if (period === 'month') {
                    const monthInput = document.getElementById('orders-month')?.value;
                    if (monthInput) {
                        const [year, month] = monthInput.split('-');
                        const startDate = `${year}-${month}-01`;
                        const lastDay = new Date(year, month, 0).getDate();
                        const endDate = `${year}-${month}-${lastDay}`;
                        url += `&startDate=${startDate}&endDate=${endDate}`;
                    }
                } else if (period === 'year') {
                    const year = document.getElementById('orders-year')?.value || new Date().getFullYear();
                    url += `&startDate=${year}-01-01&endDate=${year}-12-31`;
                } else {
                    const endDate = new Date();
                    const startDate = new Date();
                    startDate.setDate(startDate.getDate() - 30);
                    url += `&startDate=${startDate.toISOString().split('T')[0]}&endDate=${endDate.toISOString().split('T')[0]}`;
                }
                
                const response = await fetch(url);
                const result = await response.json();
                
                if (result.success && result.data) {
                    const data = result.data;
                    let labels = [];
                    let orders = [];
                    
                    if (period === 'day') {
                        const grouped = {};
                        data.forEach(item => {
                            const date = item.ngay || item.ngayLap?.split('T')[0];
                            if (date) {
                                if (!grouped[date]) grouped[date] = 0;
                                grouped[date] += parseInt(item.soHoaDon || 0);
                            }
                        });
                        labels = Object.keys(grouped).sort();
                        orders = labels.map(date => grouped[date]);
                    } else if (period === 'month') {
                        const grouped = {};
                        data.forEach(item => {
                            const key = `${item.nam || new Date().getFullYear()}-${String(item.thang || 1).padStart(2, '0')}`;
                            if (!grouped[key]) grouped[key] = 0;
                            grouped[key] += parseInt(item.soHoaDon || 0);
                        });
                        labels = Object.keys(grouped).sort();
                        orders = labels.map(key => grouped[key]);
                        labels = labels.map(key => {
                            const [y, m] = key.split('-');
                            return `Th√°ng ${m}/${y}`;
                        });
                    } else if (period === 'year') {
                        const grouped = {};
                        data.forEach(item => {
                            const year = item.nam || new Date().getFullYear();
                            if (!grouped[year]) grouped[year] = 0;
                            grouped[year] += parseInt(item.soHoaDon || 0);
                        });
                        labels = Object.keys(grouped).sort();
                        orders = labels.map(year => grouped[year]);
                        labels = labels.map(year => `NƒÉm ${year}`);
                    }
                    
                    const ctx = document.getElementById('orders-chart');
                    if (!ctx) return;
                    
                    if (ordersChart) {
                        ordersChart.destroy();
                    }
                    
                    ordersChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'S·ªë ƒê∆°n H√†ng',
                                data: orders,
                                borderColor: '#00b894',
                                backgroundColor: 'rgba(0, 184, 148, 0.1)',
                                borderWidth: 3,
                                pointRadius: 5,
                                pointHoverRadius: 7,
                                pointBackgroundColor: '#00b894',
                                pointBorderColor: '#ffffff',
                                pointBorderWidth: 2,
                                tension: 0.4,
                                fill: true,
                                pointHoverBackgroundColor: '#00b894',
                                pointHoverBorderColor: '#ffffff'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            interaction: {
                                intersect: false,
                                mode: 'index'
                            },
                            plugins: {
                                legend: {
                                    display: false
                                },
                                tooltip: {
                                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                    padding: 12,
                                    titleFont: {
                                        size: 14,
                                        weight: 'bold'
                                    },
                                    bodyFont: {
                                        size: 13
                                    },
                                    callbacks: {
                                        label: function(context) {
                                            return 'S·ªë ƒë∆°n h√†ng: ' + context.parsed.y + ' ƒë∆°n';
                                        }
                                    }
                                }
                            },
                            scales: {
                                x: {
                                    grid: {
                                        display: false
                                    },
                                    ticks: {
                                        font: {
                                            size: 11
                                        }
                                    }
                                },
                                y: {
                                    beginAtZero: true,
                                    grid: {
                                        color: 'rgba(0, 0, 0, 0.05)'
                                    },
                                    ticks: {
                                        stepSize: 1,
                                        font: {
                                            size: 11
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
            } catch (error) {
                console.error('Error loading orders chart:', error);
            }
        }

        async function loadTopEmployees() {
            try {
                const today = new Date();
                const startDate = new Date(today.getFullYear(), today.getMonth(), 1);
                const endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                
                const url = `${API_BASE}/thongke/doanhthu?period=day&startDate=${startDate.toISOString().split('T')[0]}&endDate=${endDate.toISOString().split('T')[0]}`;
                const response = await fetch(url);
                const result = await response.json();
                
                if (result.success && result.data) {
                    // Group by employee
                    const employeeStats = {};
                    result.data.forEach(item => {
                        const idNV = item.idNV;
                        if (!employeeStats[idNV]) {
                            employeeStats[idNV] = {
                                idNV: idNV,
                                tenNV: item.tenNhanVien || item.maNV || 'N/A',
                                maNV: item.maNV || '',
                                soHoaDon: 0,
                                tongDoanhThu: 0
                            };
                        }
                        employeeStats[idNV].soHoaDon += parseInt(item.soHoaDon || 0);
                        employeeStats[idNV].tongDoanhThu += parseFloat(item.tongDoanhThu || 0);
                    });
                    
                    const topEmployees = Object.values(employeeStats)
                        .sort((a, b) => b.tongDoanhThu - a.tongDoanhThu)
                        .slice(0, 5);
                    
                    const container = document.getElementById('top-employees-list');
                    if (!container) return;
                    
                    if (topEmployees.length === 0) {
                        container.innerHTML = '<div class="empty-state">Ch∆∞a c√≥ d·ªØ li·ªáu</div>';
                        return;
                    }
                    
                    container.innerHTML = topEmployees.map((emp, index) => `
                        <div class="top-list-item">
                            <div class="top-list-rank ${index === 0 ? 'rank-1' : index === 1 ? 'rank-2' : index === 2 ? 'rank-3' : 'rank-other'}">
                                ${index + 1}
                            </div>
                            <div class="top-list-info">
                                <div class="top-list-name">${emp.tenNV}</div>
                                <div class="top-list-detail">${emp.maNV} ‚Ä¢ ${emp.soHoaDon} ƒë∆°n</div>
                            </div>
                            <div class="top-list-value">${formatCurrency(emp.tongDoanhThu)}</div>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('Error loading top employees:', error);
            }
        }

        function loadLoyalCustomers() {
            try {
                const loyalCustomers = customers
                    .filter(c => c.diemtichluy && c.diemtichluy > 0)
                    .sort((a, b) => (b.diemtichluy || 0) - (a.diemtichluy || 0))
                    .slice(0, 5);
                
                const container = document.getElementById('loyal-customers-list');
                if (!container) return;
                
                if (loyalCustomers.length === 0) {
                    container.innerHTML = '<div class="empty-state">Ch∆∞a c√≥ kh√°ch h√†ng th√¢n thi·∫øt</div>';
                    return;
                }
                
                container.innerHTML = loyalCustomers.map((customer, index) => `
                    <div class="top-list-item">
                        <div class="top-list-rank ${index === 0 ? 'rank-1' : index === 1 ? 'rank-2' : index === 2 ? 'rank-3' : 'rank-other'}">
                            ${index + 1}
                        </div>
                        <div class="top-list-info">
                            <div class="top-list-name">${customer.tenKH}</div>
                            <div class="top-list-detail">${customer.maKH} ${customer.sdt ? '‚Ä¢ ' + customer.sdt : ''}</div>
                        </div>
                        <div class="top-list-value">${customer.diemtichluy || 0} ƒëi·ªÉm</div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading loyal customers:', error);
            }
        }

        async function loadBestSellingProducts() {
            try {
                const response = await fetch(`${API_BASE}/hoadon`);
                const result = await response.json();
                
                if (result.success && result.data) {
                    // Get all order details
                    const productSales = {};
                    
                    for (const order of result.data) {
                        if (!order.id) continue;
                        try {
                            const detailRes = await fetch(`${API_BASE}/chitiethd/${order.id}`);
                            const detailResult = await detailRes.json();
                            
                            if (detailResult.success && detailResult.data) {
                                detailResult.data.forEach(item => {
                                    const idHang = item.idHang;
                                    if (!productSales[idHang]) {
                                        productSales[idHang] = {
                                            idHang: idHang,
                                            maHang: item.maHang || '',
                                            tenHang: item.tenHang || '',
                                            soLuong: 0,
                                            tongTien: 0
                                        };
                                    }
                                    productSales[idHang].soLuong += parseInt(item.soluong || 0);
                                    productSales[idHang].tongTien += parseFloat(item.tongtien || 0);
                                });
                            }
                        } catch (err) {
                            console.error('Error loading order details:', err);
                        }
                    }
                    
                    const bestProducts = Object.values(productSales)
                        .sort((a, b) => b.soLuong - a.soLuong)
                        .slice(0, 5);
                    
                    const container = document.getElementById('best-products-list');
                    if (!container) return;
                    
                    if (bestProducts.length === 0) {
                        container.innerHTML = '<div class="empty-state">Ch∆∞a c√≥ d·ªØ li·ªáu</div>';
                        return;
                    }
                    
                    container.innerHTML = bestProducts.map((product, index) => `
                        <div class="top-list-item">
                            <div class="top-list-rank ${index === 0 ? 'rank-1' : index === 1 ? 'rank-2' : index === 2 ? 'rank-3' : 'rank-other'}">
                                ${index + 1}
                            </div>
                            <div class="top-list-info">
                                <div class="top-list-name">${product.tenHang}</div>
                                <div class="top-list-detail">${product.maHang}</div>
                            </div>
                            <div class="top-list-value">${product.soLuong} sp</div>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('Error loading best selling products:', error);
                const container = document.getElementById('best-products-list');
                if (container) {
                    container.innerHTML = '<div class="empty-state">L·ªói t·∫£i d·ªØ li·ªáu</div>';
                }
            }
        }

        async function loadSlowMovingProducts() {
            try {
                // Get all orders
                const response = await fetch(`${API_BASE}/hoadon`);
                const result = await response.json();
                
                if (result.success && result.data) {
                    const now = new Date();
                    const ninetyDaysAgo = new Date(now.getTime() - 90 * 24 * 60 * 60 * 1000);
                    const productSales = {};
                    
                    // Count sales for each product in the last 90 days
                    for (const order of result.data) {
                        if (!order.id || !order.ngayLap) continue;
                        
                        // Parse order date
                        const orderDate = new Date(order.ngayLap);
                        if (orderDate < ninetyDaysAgo) continue; // Skip orders older than 90 days
                        
                        try {
                            const detailRes = await fetch(`${API_BASE}/chitiethd/${order.id}`);
                            const detailResult = await detailRes.json();
                            
                            if (detailResult.success && detailResult.data) {
                                detailResult.data.forEach(item => {
                                    const idHang = item.idHang;
                                    if (!productSales[idHang]) {
                                        productSales[idHang] = 0;
                                    }
                                    productSales[idHang] += parseInt(item.soluong || 0);
                                });
                            }
                        } catch (err) {
                            // Skip errors
                        }
                    }
                    
                    // Find slow moving products:
                    // 1. Sau 30 ng√†y nh·∫≠p h√†ng kh√¥ng sinh b·∫•t c·ª© h√≥a ƒë∆°n n√†o
                    // 2. S·ªë l∆∞·ª£ng b√°n trong 90 ng√†y g·∫ßn nh·∫•t < 5 s·∫£n ph·∫©m
                    const slowMoving = products
                        .filter(p => {
                            if (!p.ngayNhapCuoi) return false;
                            
                            // Parse ngayNhapCuoi
                            const ngayNhapCuoi = new Date(p.ngayNhapCuoi);
                            const thirtyDaysAfterImport = new Date(ngayNhapCuoi.getTime() + 30 * 24 * 60 * 60 * 1000);
                            
                            // ƒêi·ªÅu ki·ªán 1: Sau 30 ng√†y nh·∫≠p h√†ng kh√¥ng sinh b·∫•t c·ª© h√≥a ƒë∆°n n√†o
                            const condition1 = now >= thirtyDaysAfterImport;
                            
                            // ƒêi·ªÅu ki·ªán 2: S·ªë l∆∞·ª£ng b√°n trong 90 ng√†y g·∫ßn nh·∫•t < 5
                            const salesIn90Days = productSales[p.id] || 0;
                            const condition2 = salesIn90Days < 5;
                            
                            return condition1 && condition2;
                        })
                        .sort((a, b) => {
                            // Sort by ngayNhapCuoi (oldest first)
                            const dateA = new Date(a.ngayNhapCuoi || 0);
                            const dateB = new Date(b.ngayNhapCuoi || 0);
                            return dateA - dateB;
                        })
                        .slice(0, 5);
                    
                    const container = document.getElementById('slow-moving-warning');
                    if (!container) return;
                    
                    if (slowMoving.length === 0) {
                        container.innerHTML = '';
                        return;
                    }
                    
                    container.innerHTML = `
                        <div class="slow-moving-warning">
                            <h4>‚ö†Ô∏è H√†ng H√≥a T·ªìn B√°n Ch·∫≠m</h4>
                            ${slowMoving.map(p => `
                                <div class="stock-warning-item">
                                    <span><strong>${p.tenHang}</strong> (${p.maHang})</span>
                                    <span class="badge badge-warning">T·ªìn: ${p.soluong} sp</span>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
                
                // Update notification badge
                updateNotificationBadge();
            } catch (error) {
                console.error('Error loading slow moving products:', error);
            }
        }

        async function loadSupplierStatistics() {
            try {
                // ƒê·∫£m b·∫£o nhacungcapList ƒë√£ ƒë∆∞·ª£c load
                if (!nhacungcapList || nhacungcapList.length === 0) {
                    const nhacungcapRes = await fetch(`${API_BASE}/nhacungcap`);
                    const nhacungcapData = await nhacungcapRes.json();
                    if (nhacungcapData.success && nhacungcapData.data) {
                        nhacungcapList = nhacungcapData.data;
                    }
                }
                
                // Load phi·∫øu nh·∫≠p ƒë·ªÉ t√≠nh th·ªëng k√™
                const phieuNhapRes = await fetch(`${API_BASE}/phieunhap`);
                const phieuNhapData = await phieuNhapRes.json();
                
                if (phieuNhapData.success && phieuNhapData.data) {
                    const phieuNhapList = phieuNhapData.data;
                    
                    // T√≠nh th·ªëng k√™ nh√† cung c·∫•p
                    const supplierStats = {};
                    
                    phieuNhapList.forEach(pn => {
                        if (pn.idNCC && pn.tenNhaCungCap) {
                            const idNCC = parseInt(pn.idNCC);
                            if (!isNaN(idNCC) && pn.tenNhaCungCap.trim()) {
                                if (!supplierStats[idNCC]) {
                                    supplierStats[idNCC] = {
                                        id: idNCC,
                                        tenNCC: pn.tenNhaCungCap.trim(),
                                        maNCC: (pn.maNCC || '').trim(),
                                        soPhieuNhap: 0,
                                        tongGiaTri: 0
                                    };
                                }
                                supplierStats[idNCC].soPhieuNhap++;
                                const tongTien = parseFloat(pn.tongTien || 0);
                                if (!isNaN(tongTien)) {
                                    supplierStats[idNCC].tongGiaTri += tongTien;
                                }
                            }
                        }
                    });
                    
                    // Calculate total value first (needed for percentage calculation)
                    const totalValue = Object.values(supplierStats).reduce((sum, s) => sum + s.tongGiaTri, 0);
                    const totalPhieuNhap = Object.values(supplierStats).reduce((sum, s) => sum + s.soPhieuNhap, 0);
                    const suppliersWithOrders = Object.keys(supplierStats).length;
                    
                    // Top nh√† cung c·∫•p theo gi√° tr·ªã nh·∫≠p h√†ng
                    const topSuppliers = Object.values(supplierStats)
                        .sort((a, b) => b.tongGiaTri - a.tongGiaTri)
                        .slice(0, 5);
                    
                    // Render top suppliers
                    const topSuppliersContainer = document.getElementById('top-suppliers-list');
                    if (topSuppliersContainer) {
                        if (topSuppliers.length === 0) {
                            topSuppliersContainer.innerHTML = '<div class="empty-state">Ch∆∞a c√≥ d·ªØ li·ªáu nh√† cung c·∫•p</div>';
                        } else {
                            const rankColors = ['#ffd700', '#c0c0c0', '#cd7f32', '#667eea', '#667eea'];
                            const rankIcons = ['ü•á', 'ü•à', 'ü•â', '4Ô∏è‚É£', '5Ô∏è‚É£'];
                            
                            topSuppliersContainer.innerHTML = topSuppliers.map((supplier, index) => {
                                const percentage = totalValue > 0 ? ((supplier.tongGiaTri / totalValue) * 100).toFixed(1) : 0;
                                return `
                                    <div style="background: ${index < 3 ? 'linear-gradient(135deg, #fff 0%, #f8f9fa 100%)' : '#fff'}; border-radius: 10px; padding: 15px; margin-bottom: 12px; border-left: 4px solid ${rankColors[index]}; box-shadow: 0 2px 8px rgba(0,0,0,0.05); transition: transform 0.2s, box-shadow 0.2s;" 
                                         onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)';" 
                                         onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.05)';">
                                        <div style="display: flex; align-items: center; gap: 12px;">
                                            <div style="width: 40px; height: 40px; border-radius: 50%; background: ${rankColors[index]}; display: flex; align-items: center; justify-content: center; font-size: 18px; font-weight: 700; color: ${index < 3 ? '#fff' : '#1a2b48'}; flex-shrink: 0;">
                                                ${rankIcons[index] || (index + 1)}
                                            </div>
                                            <div style="flex: 1; min-width: 0;">
                                                <div style="font-weight: 700; color: #1a2b48; font-size: 15px; margin-bottom: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                                    ${supplier.tenNCC}
                                                </div>
                                                <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                                                    <span style="font-size: 12px; color: #666; background: #f0f0f0; padding: 3px 8px; border-radius: 4px;">${supplier.maNCC}</span>
                                                    <span style="font-size: 12px; color: #999;">‚Ä¢</span>
                                                    <span style="font-size: 12px; color: #4a90e2; font-weight: 500;">${supplier.soPhieuNhap} phi·∫øu</span>
                                                    <span style="font-size: 12px; color: #999;">‚Ä¢</span>
                                                    <span style="font-size: 12px; color: #00b894; font-weight: 500;">${percentage}%</span>
                                                </div>
                                                <div style="background: #e0e0e0; border-radius: 4px; height: 4px; margin-top: 8px; overflow: hidden;">
                                                    <div style="background: linear-gradient(90deg, ${rankColors[index]}, ${rankColors[index]}dd); height: 100%; width: ${percentage}%; transition: width 0.3s;"></div>
                                                </div>
                                            </div>
                                            <div style="text-align: right; flex-shrink: 0;">
                                                <div style="font-weight: 900; color: ${rankColors[index]}; font-size: 16px; margin-bottom: 2px;">
                                                    ${formatCurrency(supplier.tongGiaTri)}
                                                </div>
                                                <div style="font-size: 11px; color: #999;">
                                                    Gi√° tr·ªã nh·∫≠p
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('');
                        }
                    }
                    
                    // Calculate additional statistics
                    const totalSuppliers = (nhacungcapList && nhacungcapList.length) ? nhacungcapList.length : 0;
                    const activeSuppliers = (nhacungcapList && nhacungcapList.length) ? nhacungcapList.filter(ncc => ncc.trangthai !== 0).length : 0;
                    const inactiveSuppliers = totalSuppliers - activeSuppliers;
                    const avgPhieuNhapPerSupplier = suppliersWithOrders > 0 ? (totalPhieuNhap / suppliersWithOrders).toFixed(1) : 0;
                    const avgValuePerSupplier = suppliersWithOrders > 0 ? (totalValue / suppliersWithOrders) : 0;
                    
                    // Render metric cards
                    const metricsContainer = document.getElementById('supplier-metrics-cards');
                    if (metricsContainer) {
                        metricsContainer.innerHTML = `
                            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; padding: 20px; color: white; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);">
                                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
                                    <div style="font-size: 14px; opacity: 0.9;">T·ªïng Nh√† Cung C·∫•p</div>
                                    <div style="font-size: 24px; font-weight: 700;">üì¶</div>
                                </div>
                                <div style="font-size: 32px; font-weight: 900; margin-bottom: 5px;">${totalSuppliers}</div>
                                <div style="font-size: 12px; opacity: 0.8;">${activeSuppliers} ƒëang ho·∫°t ƒë·ªông</div>
                            </div>
                            
                            <div style="background: linear-gradient(135deg, #00b894 0%, #00cec9 100%); border-radius: 12px; padding: 20px; color: white; box-shadow: 0 4px 15px rgba(0, 184, 148, 0.3);">
                                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
                                    <div style="font-size: 14px; opacity: 0.9;">ƒêang Ho·∫°t ƒê·ªông</div>
                                    <div style="font-size: 24px; font-weight: 700;">‚úÖ</div>
                                </div>
                                <div style="font-size: 32px; font-weight: 900; margin-bottom: 5px;">${activeSuppliers}</div>
                                <div style="font-size: 12px; opacity: 0.8;">${totalSuppliers > 0 ? ((activeSuppliers / totalSuppliers) * 100).toFixed(1) : 0}% t·ªïng s·ªë</div>
                            </div>
                            
                            <div style="background: linear-gradient(135deg, #4a90e2 0%, #357abd 100%); border-radius: 12px; padding: 20px; color: white; box-shadow: 0 4px 15px rgba(74, 144, 226, 0.3);">
                                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
                                    <div style="font-size: 14px; opacity: 0.9;">C√≥ Giao D·ªãch</div>
                                    <div style="font-size: 24px; font-weight: 700;">üíº</div>
                                </div>
                                <div style="font-size: 32px; font-weight: 900; margin-bottom: 5px;">${suppliersWithOrders}</div>
                                <div style="font-size: 12px; opacity: 0.8;">${totalPhieuNhap} phi·∫øu nh·∫≠p</div>
                            </div>
                            
                            <div style="background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); border-radius: 12px; padding: 20px; color: white; box-shadow: 0 4px 15px rgba(255, 152, 0, 0.3);">
                                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
                                    <div style="font-size: 14px; opacity: 0.9;">T·ªïng Gi√° Tr·ªã Nh·∫≠p</div>
                                    <div style="font-size: 24px; font-weight: 700;">üí∞</div>
                                </div>
                                <div style="font-size: 24px; font-weight: 900; margin-bottom: 5px; line-height: 1.2;">${formatCurrency(totalValue)}</div>
                                <div style="font-size: 12px; opacity: 0.8;">TB: ${formatCurrency(avgValuePerSupplier)}/NCC</div>
                            </div>
                        `;
                    }
                    
                    // Render summary details
                    const summaryContainer = document.getElementById('supplier-summary');
                    if (summaryContainer) {
                        summaryContainer.innerHTML = `
                            <div style="padding: 10px 0;">
                                <div style="background: #f8f9fa; border-radius: 8px; padding: 15px; margin-bottom: 12px; border-left: 4px solid #667eea;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                        <span style="color: #666; font-size: 13px; font-weight: 500;">üìã T·ªïng Phi·∫øu Nh·∫≠p</span>
                                        <span style="font-weight: 700; color: #667eea; font-size: 18px;">${totalPhieuNhap}</span>
                                    </div>
                                    <div style="font-size: 11px; color: #999; margin-top: 5px;">
                                        Trung b√¨nh: ${avgPhieuNhapPerSupplier} phi·∫øu/NCC
                                    </div>
                                </div>
                                
                                <div style="background: #f8f9fa; border-radius: 8px; padding: 15px; margin-bottom: 12px; border-left: 4px solid #00b894;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                        <span style="color: #666; font-size: 13px; font-weight: 500;">üìä T·ª∑ L·ªá Ho·∫°t ƒê·ªông</span>
                                        <span style="font-weight: 700; color: #00b894; font-size: 18px;">${totalSuppliers > 0 ? ((activeSuppliers / totalSuppliers) * 100).toFixed(1) : 0}%</span>
                                    </div>
                                    <div style="background: #e0e0e0; border-radius: 4px; height: 6px; margin-top: 8px; overflow: hidden;">
                                        <div style="background: linear-gradient(90deg, #00b894, #00cec9); height: 100%; width: ${totalSuppliers > 0 ? (activeSuppliers / totalSuppliers) * 100 : 0}%; transition: width 0.3s;"></div>
                                    </div>
                                </div>
                                
                                <div style="background: #f8f9fa; border-radius: 8px; padding: 15px; margin-bottom: 12px; border-left: 4px solid #4a90e2;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                        <span style="color: #666; font-size: 13px; font-weight: 500;">üîÑ T·ª∑ L·ªá Giao D·ªãch</span>
                                        <span style="font-weight: 700; color: #4a90e2; font-size: 18px;">${totalSuppliers > 0 ? ((suppliersWithOrders / totalSuppliers) * 100).toFixed(1) : 0}%</span>
                                    </div>
                                    <div style="font-size: 11px; color: #999; margin-top: 5px;">
                                        ${suppliersWithOrders}/${totalSuppliers} nh√† cung c·∫•p c√≥ giao d·ªãch
                                    </div>
                                </div>
                                
                                <div style="background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); border-radius: 8px; padding: 15px; margin-top: 15px; color: white;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                                        <span style="font-size: 13px; opacity: 0.95; font-weight: 500;">üíµ Gi√° Tr·ªã Trung B√¨nh</span>
                                        <span style="font-weight: 900; font-size: 20px;">${formatCurrency(avgValuePerSupplier)}</span>
                                    </div>
                                    <div style="font-size: 11px; opacity: 0.85; margin-top: 5px;">
                                        M·ªói nh√† cung c·∫•p c√≥ giao d·ªãch
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                } else {
                    // N·∫øu kh√¥ng c√≥ d·ªØ li·ªáu
                    const totalSuppliers = (nhacungcapList && nhacungcapList.length) ? nhacungcapList.length : 0;
                    const activeSuppliers = (nhacungcapList && nhacungcapList.length) ? nhacungcapList.filter(ncc => ncc.trangthai !== 0).length : 0;
                    
                    // Render metric cards v·ªõi d·ªØ li·ªáu c∆° b·∫£n
                    const metricsContainer = document.getElementById('supplier-metrics-cards');
                    if (metricsContainer) {
                        metricsContainer.innerHTML = `
                            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; padding: 20px; color: white; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);">
                                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
                                    <div style="font-size: 14px; opacity: 0.9;">T·ªïng Nh√† Cung C·∫•p</div>
                                    <div style="font-size: 24px; font-weight: 700;">üì¶</div>
                                </div>
                                <div style="font-size: 32px; font-weight: 900; margin-bottom: 5px;">${totalSuppliers}</div>
                                <div style="font-size: 12px; opacity: 0.8;">${activeSuppliers} ƒëang ho·∫°t ƒë·ªông</div>
                            </div>
                            
                            <div style="background: linear-gradient(135deg, #00b894 0%, #00cec9 100%); border-radius: 12px; padding: 20px; color: white; box-shadow: 0 4px 15px rgba(0, 184, 148, 0.3);">
                                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
                                    <div style="font-size: 14px; opacity: 0.9;">ƒêang Ho·∫°t ƒê·ªông</div>
                                    <div style="font-size: 24px; font-weight: 700;">‚úÖ</div>
                                </div>
                                <div style="font-size: 32px; font-weight: 900; margin-bottom: 5px;">${activeSuppliers}</div>
                                <div style="font-size: 12px; opacity: 0.8;">${totalSuppliers > 0 ? ((activeSuppliers / totalSuppliers) * 100).toFixed(1) : 0}% t·ªïng s·ªë</div>
                            </div>
                            
                            <div style="background: linear-gradient(135deg, #4a90e2 0%, #357abd 100%); border-radius: 12px; padding: 20px; color: white; box-shadow: 0 4px 15px rgba(74, 144, 226, 0.3);">
                                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
                                    <div style="font-size: 14px; opacity: 0.9;">C√≥ Giao D·ªãch</div>
                                    <div style="font-size: 24px; font-weight: 700;">üíº</div>
                                </div>
                                <div style="font-size: 32px; font-weight: 900; margin-bottom: 5px;">0</div>
                                <div style="font-size: 12px; opacity: 0.8;">Ch∆∞a c√≥ phi·∫øu nh·∫≠p</div>
                            </div>
                            
                            <div style="background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); border-radius: 12px; padding: 20px; color: white; box-shadow: 0 4px 15px rgba(255, 152, 0, 0.3);">
                                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
                                    <div style="font-size: 14px; opacity: 0.9;">T·ªïng Gi√° Tr·ªã Nh·∫≠p</div>
                                    <div style="font-size: 24px; font-weight: 700;">üí∞</div>
                                </div>
                                <div style="font-size: 24px; font-weight: 900; margin-bottom: 5px; line-height: 1.2;">0‚Ç´</div>
                                <div style="font-size: 12px; opacity: 0.8;">Ch∆∞a c√≥ giao d·ªãch</div>
                            </div>
                        `;
                    }
                    
                    const topSuppliersContainer = document.getElementById('top-suppliers-list');
                    const summaryContainer = document.getElementById('supplier-summary');
                    if (topSuppliersContainer) {
                        topSuppliersContainer.innerHTML = '<div class="empty-state">Ch∆∞a c√≥ d·ªØ li·ªáu giao d·ªãch</div>';
                    }
                    if (summaryContainer) {
                        summaryContainer.innerHTML = `
                            <div style="padding: 20px; text-align: center; color: #999;">
                                <div style="font-size: 48px; margin-bottom: 10px;">üìä</div>
                                <div style="font-size: 14px;">Ch∆∞a c√≥ d·ªØ li·ªáu th·ªëng k√™</div>
                                <div style="font-size: 12px; margin-top: 5px; opacity: 0.7;">T·∫°o phi·∫øu nh·∫≠p ƒë·ªÉ xem th·ªëng k√™</div>
                            </div>
                        `;
                    }
                }
            } catch (error) {
                console.error('Error loading supplier statistics:', error);
                const topSuppliersContainer = document.getElementById('top-suppliers-list');
                const summaryContainer = document.getElementById('supplier-summary');
                const metricsContainer = document.getElementById('supplier-metrics-cards');
                if (topSuppliersContainer) {
                    topSuppliersContainer.innerHTML = '<div class="empty-state">L·ªói t·∫£i d·ªØ li·ªáu</div>';
                }
                if (summaryContainer) {
                    summaryContainer.innerHTML = '<div class="empty-state">L·ªói t·∫£i d·ªØ li·ªáu</div>';
                }
                if (metricsContainer) {
                    metricsContainer.innerHTML = '<div class="empty-state">L·ªói t·∫£i d·ªØ li·ªáu</div>';
                }
            }
        }

        function renderStockWarnings() {
            const lowStockItems = products.filter(p => p.soluong < 20 && p.soluong > 0);
            const container = document.getElementById('stock-warnings');
            
            if (lowStockItems.length === 0) {
                container.innerHTML = '';
                return;
            }

            container.innerHTML = `
                <div class="stock-warning-list">
                    <h4>‚ö†Ô∏è C·∫£nh B√°o H√†ng T·ªìn Kho Th·∫•p (d∆∞·ªõi 20)</h4>
                    ${lowStockItems.map(p => `
                        <div class="stock-warning-item">
                            <span><strong>${p.tenHang}</strong> (${p.maHang})</span>
                            <span class="badge badge-warning">C√≤n ${p.soluong} ${p.donvi || 'sp'}</span>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // ==================== NOTIFICATIONS ====================
        function openNotificationSection() {
            const section = document.getElementById('notification-section');
            if (section) {
                section.style.display = 'block';
                section.scrollTop = 0;
                loadNotificationData();
            }
        }

        function closeNotificationSection() {
            const section = document.getElementById('notification-section');
            if (section) {
                section.style.display = 'none';
            }
        }

        async function loadNotificationData() {
            try {
                // Load low stock items
                const lowStockItems = products.filter(p => p.soluong < 20 && p.soluong > 0);
                const lowStockList = document.getElementById('low-stock-list');
                
                if (lowStockList) {
                    if (lowStockItems.length === 0) {
                        lowStockList.innerHTML = '<div style="text-align: center; padding: 20px; color: #4caf50; font-weight: 500;">‚úÖ Kh√¥ng c√≥ s·∫£n ph·∫©m n√†o t·ªìn kho th·∫•p</div>';
                    } else {
                        lowStockList.innerHTML = lowStockItems.map(p => `
                            <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #ffcc80; display: flex; justify-content: space-between; align-items: center; transition: all 0.2s;"
                                 onmouseover="this.style.boxShadow='0 2px 8px rgba(255,152,0,0.2)'; this.style.transform='translateX(5px)'"
                                 onmouseout="this.style.boxShadow='none'; this.style.transform='translateX(0)'">
                                <div style="flex: 1;">
                                    <div style="font-weight: 700; color: #1a2b48; font-size: 15px; margin-bottom: 5px;">${p.tenHang}</div>
                                    <div style="font-size: 13px; color: #666;">M√£: ${p.maHang} ‚Ä¢ ƒê∆°n v·ªã: ${p.donvi || 'sp'}</div>
                                </div>
                                <div style="background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); color: white; padding: 8px 16px; border-radius: 6px; font-weight: 700; font-size: 14px; white-space: nowrap; margin-left: 15px;">
                                    C√≤n ${p.soluong} ${p.donvi || 'sp'}
                                </div>
                            </div>
                        `).join('');
                    }
                }

                // Load slow moving products
                let slowMovingItems = [];
                try {
                    const ordersRes = await fetch(`${API_BASE}/hoadon`);
                    const ordersData = await ordersRes.json();
                    
                    if (ordersData.success && ordersData.data) {
                        const now = new Date();
                        const ninetyDaysAgo = new Date(now.getTime() - 90 * 24 * 60 * 60 * 1000);
                        const productSales = {};
                        
                        // Count sales for each product in the last 90 days
                        for (const order of ordersData.data) {
                            if (!order.id || !order.ngayLap) continue;
                            
                            const orderDate = new Date(order.ngayLap);
                            if (orderDate < ninetyDaysAgo) continue;
                            
                            try {
                                const detailRes = await fetch(`${API_BASE}/chitiethoadon/${order.id}`);
                                const detailData = await detailRes.json();
                                if (detailData.success && detailData.data) {
                                    detailData.data.forEach(item => {
                                        productSales[item.idHang] = (productSales[item.idHang] || 0) + item.soluong;
                                    });
                                }
                            } catch (err) {
                                // Skip errors
                            }
                        }
                        
                        // Find slow moving products:
                        // 1. Sau 30 ng√†y nh·∫≠p h√†ng kh√¥ng sinh b·∫•t c·ª© h√≥a ƒë∆°n n√†o
                        // 2. S·ªë l∆∞·ª£ng b√°n trong 90 ng√†y g·∫ßn nh·∫•t < 5 s·∫£n ph·∫©m
                        slowMovingItems = products
                            .filter(p => {
                                if (!p.ngayNhapCuoi) return false;
                                
                                const ngayNhapCuoi = new Date(p.ngayNhapCuoi);
                                const thirtyDaysAfterImport = new Date(ngayNhapCuoi.getTime() + 30 * 24 * 60 * 60 * 1000);
                                
                                // ƒêi·ªÅu ki·ªán 1: Sau 30 ng√†y nh·∫≠p h√†ng kh√¥ng sinh b·∫•t c·ª© h√≥a ƒë∆°n n√†o
                                const condition1 = now >= thirtyDaysAfterImport;
                                
                                // ƒêi·ªÅu ki·ªán 2: S·ªë l∆∞·ª£ng b√°n trong 90 ng√†y g·∫ßn nh·∫•t < 5
                                const salesIn90Days = productSales[p.id] || 0;
                                const condition2 = salesIn90Days < 5;
                                
                                return condition1 && condition2;
                            })
                            .sort((a, b) => {
                                // Sort by ngayNhapCuoi (oldest first)
                                const dateA = new Date(a.ngayNhapCuoi || 0);
                                const dateB = new Date(b.ngayNhapCuoi || 0);
                                return dateA - dateB;
                            })
                            .slice(0, 10);
                    }
                } catch (error) {
                    console.error('Error loading slow moving products:', error);
                }

                const slowMovingList = document.getElementById('slow-moving-list');
                if (slowMovingList) {
                    if (slowMovingItems.length === 0) {
                        slowMovingList.innerHTML = '<div style="text-align: center; padding: 20px; color: #4caf50; font-weight: 500;">‚úÖ Kh√¥ng c√≥ s·∫£n ph·∫©m n√†o b√°n ch·∫≠m</div>';
                    } else {
                        slowMovingList.innerHTML = slowMovingItems.map(p => `
                            <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #f48fb1; display: flex; justify-content: space-between; align-items: center; transition: all 0.2s;"
                                 onmouseover="this.style.boxShadow='0 2px 8px rgba(233,30,99,0.2)'; this.style.transform='translateX(5px)'"
                                 onmouseout="this.style.boxShadow='none'; this.style.transform='translateX(0)'">
                                <div style="flex: 1;">
                                    <div style="font-weight: 700; color: #1a2b48; font-size: 15px; margin-bottom: 5px;">${p.tenHang}</div>
                                    <div style="font-size: 13px; color: #666;">M√£: ${p.maHang} ‚Ä¢ T·ªìn kho cao nh∆∞ng b√°n ch·∫≠m</div>
                                </div>
                                <div style="background: linear-gradient(135deg, #e91e63 0%, #c2185b 100%); color: white; padding: 8px 16px; border-radius: 6px; font-weight: 700; font-size: 14px; white-space: nowrap; margin-left: 15px;">
                                    T·ªìn: ${p.soluong} ${p.donvi || 'sp'}
                                </div>
                            </div>
                        `).join('');
                    }
                }

                // Show/hide empty state
                const emptyState = document.getElementById('notification-empty');
                if (emptyState) {
                    if (lowStockItems.length === 0 && slowMovingItems.length === 0) {
                        emptyState.style.display = 'block';
                        document.getElementById('notification-low-stock').style.display = 'none';
                        document.getElementById('notification-slow-moving').style.display = 'none';
                    } else {
                        emptyState.style.display = 'none';
                        document.getElementById('notification-low-stock').style.display = 'block';
                        document.getElementById('notification-slow-moving').style.display = 'block';
                    }
                }

            } catch (error) {
                console.error('Error loading notification data:', error);
            }
        }

        function updateNotificationBadge() {
            const badge = document.getElementById('notification-badge');
            if (badge) {
                const lowStockItems = products.filter(p => p.soluong < 20 && p.soluong > 0);
                // T√≠nh s·ªë l∆∞·ª£ng h√†ng b√°n ch·∫≠m (c·∫ßn load async, t·∫°m th·ªùi ch·ªâ t√≠nh low stock)
                let totalNotifications = lowStockItems.length;
                
                // C√≥ th·ªÉ th√™m logic t√≠nh slow moving items n·∫øu c·∫ßn
                // T·∫°m th·ªùi ch·ªâ hi·ªÉn th·ªã s·ªë low stock items
                
                if (totalNotifications > 0) {
                    badge.textContent = totalNotifications > 99 ? '99+' : totalNotifications;
                    badge.style.display = 'flex';
                } else {
                    badge.style.display = 'none';
                }
            }
        }

        function renderTopProducts(data) {
            const container = document.getElementById('top-products');
            if (!data.length) {
                container.innerHTML = '<div class="empty-state">Ch∆∞a c√≥ s·∫£n ph·∫©m</div>';
                return;
            }

            container.innerHTML = data.map(p => `
                <div class="product-card">
                    <div class="product-card-name">${p.tenHang}</div>
                    <div class="product-card-code">${p.maHang}</div>
                    <span class="product-card-stock ${getStockClass(p.soluong)}">C√≤n ${p.soluong} ${p.donvi || 'sp'}</span>
                    <div class="product-card-price">${formatCurrency(p.giaban)}</div>
                </div>
            `).join('');
        }

        // ==================== PRODUCTS ====================
        async function renderProducts() {
            const content = document.getElementById('page-content');
            content.innerHTML = `
                <div class="page-header">
                    <div>
                        <h2>Kho H√†ng H√≥a</h2>
                        <p>Xem v√† t√¨m ki·∫øm s·∫£n ph·∫©m trong kho</p>
                    </div>
                </div>
                <div class="search-box">
                    <input type="text" class="search-input" id="search-product" placeholder="T√¨m ki·∫øm theo m√£ ho·∫∑c t√™n s·∫£n ph·∫©m..." oninput="filterProducts()">
                    <button class="btn btn-primary" onclick="filterProducts()">T√¨m ki·∫øm</button>
                    <button class="btn btn-secondary" onclick="loadProducts()">T·∫£i l·∫°i</button>
                </div>
                <div id="products-container" class="table-container">
                    <div class="loading"><div class="spinner"></div><p>ƒêang t·∫£i...</p></div>
                </div>
                <div id="product-stock-warnings"></div>
            `;

            await loadProducts();
        }

        async function loadProducts() {
            try {
                const response = await fetch(`${API_BASE}/hanghoa`);
                const result = await response.json();
                if (result.success) {
                    products = result.data;
                    renderProductsTable(products);
                    renderProductStockWarnings();
                    // Update notification badge if on dashboard
                    if (currentPage === 'dashboard') {
                        updateNotificationBadge();
                    }
                }
            } catch (error) {
                // showToast('L·ªói t·∫£i d·ªØ li·ªáu', 'error');
            }
        }

        function renderProductsTable(data) {
            const container = document.getElementById('products-container');
            if (!data.length) {
                container.innerHTML = '<div class="empty-state">Kh√¥ng c√≥ s·∫£n ph·∫©m</div>';
                return;
            }

            container.innerHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>M√£ H√†ng</th>
                            <th>T√™n S·∫£n Ph·∫©m</th>
                            <th>S·ªë L∆∞·ª£ng</th>
                            <th>Gi√° Nh·∫≠p</th>
                            <th>Gi√° B√°n</th>
                            <th>Tr·∫°ng Th√°i</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${data.map(p => `
                            <tr>
                                <td><strong>${p.maHang}</strong></td>
                                <td>${p.tenHang}</td>
                                <td>${p.soluong}</td>
                            
                                <td>${formatCurrency(p.gianhap)}</td>
                                <td><strong class="value-success">${formatCurrency(p.giaban)}</strong></td>
                                <td>
                                    <span class="badge ${getStockBadge(p.soluong)}">${getStockText(p.soluong)}</span>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function renderProductStockWarnings() {
            const lowStockItems = products.filter(p => p.soluong < 20 && p.soluong > 0);
            const outOfStock = products.filter(p => p.soluong <= 0);
            const container = document.getElementById('product-stock-warnings');
            
            let html = '';
            
            if (outOfStock.length > 0) {
                html += `
                    <div class="stock-warning-list" style="background: #ffe6e6; border-left-color: #e74c3c; margin-top: 20px;">
                        <h4 style="color: #e74c3c;">‚ùå S·∫£n Ph·∫©m H·∫øt H√†ng</h4>
                        ${outOfStock.map(p => `
                            <div class="stock-warning-item">
                                <span><strong>${p.tenHang}</strong> (${p.maHang})</span>
                                <span class="badge badge-danger">H·∫øt h√†ng</span>
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            if (lowStockItems.length > 0) {
                html += `
                    <div class="stock-warning-list" style="margin-top: 20px;">
                        <h4>‚ö†Ô∏è C·∫£nh B√°o S·∫Øp H·∫øt H√†ng (d∆∞·ªõi 10)</h4>
                        ${lowStockItems.map(p => `
                            <div class="stock-warning-item">
                                <span><strong>${p.tenHang}</strong> (${p.maHang})</span>
                                <span class="badge badge-warning">C√≤n ${p.soluong} ${p.donvi || 'sp'}</span>
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            container.innerHTML = html;
        }

        function filterProducts() {
            const keyword = document.getElementById('search-product').value.toLowerCase();
            const filtered = products.filter(p =>
                p.maHang.toLowerCase().includes(keyword) ||
                p.tenHang.toLowerCase().includes(keyword)
            );
            renderProductsTable(filtered);
        }

        // ==================== CREATE ORDER ====================
        async function renderCreateOrder() {
            const content = document.getElementById('page-content');
            content.innerHTML = `
                <div class="page-header">
                    <div>
                        <h2>T·∫°o H√≥a ƒê∆°n M·ªõi</h2>
                        <p>Ch·ªçn s·∫£n ph·∫©m v√† t·∫°o h√≥a ƒë∆°n cho kh√°ch h√†ng</p>
                    </div>
                </div>
                <div class="cart-section">
                    <div class="products-panel">
                        <div class="search-box" style="background: transparent; padding: 0; margin-bottom: 15px;">
                            <input type="text" class="search-input" id="search-order-product" placeholder="T√¨m s·∫£n ph·∫©m..." oninput="filterOrderProducts()">
                            <button class="btn btn-primary" onclick="filterOrderProducts()">T√¨m</button>
                            <button class="btn btn-secondary" onclick="reloadOrderProducts()">T·∫£i l·∫°i</button>
                        </div>
                        <div id="order-products" class="product-grid"></div>
                    </div>
                    <div class="cart-panel">
                        <div class="panel-title">Gi·ªè H√†ng</div>
                        <div id="cart-items"></div>
                        <div id="cart-summary"></div>
                    </div>
                </div>
            `;

            await loadProducts();
            // Load cache d·ªØ li·ªáu b√°n h√†ng cho khuy·∫øn m√£i t·ª± ƒë·ªông
            await loadProductSalesCache();
            renderOrderProducts(products);
            renderCart();
        }

        async function reloadOrderProducts() {
            await loadProducts();
            document.getElementById('search-order-product').value = '';
            renderOrderProducts(products);
            showToast('ƒê√£ t·∫£i l·∫°i danh s√°ch s·∫£n ph·∫©m', 'success');
        }

        function renderOrderProducts(data) {
            const container = document.getElementById('order-products');
            if (!data.length) {
                container.innerHTML = '<div class="empty-state">Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m</div>';
                return;
            }

            container.innerHTML = data.map(p => `
                <div class="product-card" onclick="${p.soluong > 0 ? `addToCart('${p.maHang}')` : ''}">
                    <div class="product-card-name">${p.tenHang}</div>
                    <div class="product-card-code">${p.maHang}</div>
                    <span class="product-card-stock ${getStockClass(p.soluong)}">
                        C√≤n ${p.soluong} ${p.donvi || 'sp'}
                    </span>
                    <div class="product-card-price">${formatCurrency(p.giaban)}</div>
                    <button class="product-card-btn" ${p.soluong <= 0 ? 'disabled' : ''} onclick="event.stopPropagation(); addToCart('${p.maHang}')">
                        ${p.soluong > 0 ? 'Th√™m v√†o gi·ªè' : 'H·∫øt h√†ng'}
                    </button>
                </div>
            `).join('');
        }

        function filterOrderProducts() {
            const keyword = document.getElementById('search-order-product').value.toLowerCase();
            const filtered = products.filter(p =>
                p.maHang.toLowerCase().includes(keyword) ||
                p.tenHang.toLowerCase().includes(keyword)
            );
            renderOrderProducts(filtered);
        }

        function addToCart(maHang) {
            const product = products.find(p => p.maHang === maHang);
            if (!product || product.soluong <= 0) {
                showToast('S·∫£n ph·∫©m ƒë√£ h·∫øt h√†ng', 'error');
                return;
            }

            const existingItem = cart.find(c => c.maHang === maHang);
            if (existingItem) {
                if (existingItem.quantity >= product.soluong) {
                    showToast('S·ªë l∆∞·ª£ng v∆∞·ª£t qu√° t·ªìn kho', 'error');
                    return;
                }
                existingItem.quantity++;
            } else {
                // T√¨m ph√¢n lo·∫°i s·∫£n ph·∫©m
                const phanLoai = phanLoaiSanPhamList.find(pl => pl.id === product.idPLSP);
                cart.push({
                    id: product.id, // L∆∞u id ƒë·ªÉ d√πng khi t·∫°o h√≥a ƒë∆°n
                    maHang: product.maHang,
                    name: product.tenHang,
                    price: product.giaban,
                    originalPrice: product.giaban, // Gi√° g·ªëc tr∆∞·ªõc khuy·∫øn m√£i
                    quantity: 1,
                    maxQty: product.soluong,
                    idPLSP: product.idPLSP, // L∆∞u ph√¢n lo·∫°i s·∫£n ph·∫©m
                    tenPLSP: phanLoai ? phanLoai.tenPLSP : '', // T√™n ph√¢n lo·∫°i
                    soluong: product.soluong, // T·ªìn kho
                    autoDiscounts: [] // Danh s√°ch khuy·∫øn m√£i t·ª± ƒë·ªông √°p d·ª•ng
                });
            }

            // √Åp d·ª•ng khuy·∫øn m√£i t·ª± ƒë·ªông sau khi th√™m v√†o cart
            applyAutoPromotions();
            renderCart();
            showToast(`ƒê√£ th√™m ${product.tenHang}`, 'success');
        }

        function updateCartQty(maHang, delta) {
            const item = cart.find(c => c.maHang === maHang);
            if (!item) return;

            item.quantity += delta;

            if (item.quantity <= 0) {
                cart = cart.filter(c => c.maHang !== maHang);
            } else if (item.quantity > item.maxQty) {
                item.quantity = item.maxQty;
                showToast('S·ªë l∆∞·ª£ng v∆∞·ª£t qu√° t·ªìn kho', 'error');
            }

            renderCart();
        }

        function updateCartQtyInput(maHang, value) {
            const item = cart.find(c => c.maHang === maHang);
            if (!item) return;

            const qty = parseInt(value) || 1;
            
            if (qty <= 0) {
                cart = cart.filter(c => c.maHang !== maHang);
                applyAutoPromotions();
                renderCart();
                return;
            }
            
            if (qty > item.maxQty) {
                item.quantity = item.maxQty;
                showToast('S·ªë l∆∞·ª£ng v∆∞·ª£t qu√° t·ªìn kho', 'error');
            } else {
                item.quantity = qty;
            }

            // √Åp d·ª•ng l·∫°i khuy·∫øn m√£i sau khi thay ƒë·ªïi s·ªë l∆∞·ª£ng
            applyAutoPromotions();
            renderCart();
        }

        function validateCartQty(maHang, input) {
            const item = cart.find(c => c.maHang === maHang);
            if (!item) return;

            const qty = parseInt(input.value) || 1;
            
            if (qty < 1) {
                input.value = 1;
                item.quantity = 1;
            } else if (qty > item.maxQty) {
                input.value = item.maxQty;
                item.quantity = item.maxQty;
                showToast('S·ªë l∆∞·ª£ng v∆∞·ª£t qu√° t·ªìn kho', 'error');
            } else {
                item.quantity = qty;
            }

            renderCart();
        }

        function removeFromCart(maHang) {
            cart = cart.filter(c => c.maHang !== maHang);
            // √Åp d·ª•ng l·∫°i khuy·∫øn m√£i sau khi x√≥a
            applyAutoPromotions();
            renderCart();
        }

        // ==================== H·ªÜ TH·ªêNG KHUY·∫æN M√ÉI T·ª∞ ƒê·ªòNG ====================
        
        // Cache d·ªØ li·ªáu ƒë·ªÉ t√≠nh to√°n khuy·∫øn m√£i
        let productSalesCache = {}; // Cache s·ªë l∆∞·ª£ng b√°n c·ªßa t·ª´ng s·∫£n ph·∫©m
        let bestSellingProductsCache = []; // Cache danh s√°ch s·∫£n ph·∫©m b√°n ch·∫°y
        let slowMovingProductsCache = []; // Cache danh s√°ch s·∫£n ph·∫©m b√°n ch·∫≠m
        
        // Load cache d·ªØ li·ªáu b√°n h√†ng
        async function loadProductSalesCache() {
            try {
                const ordersRes = await fetch(`${API_BASE}/hoadon`);
                const ordersData = await ordersRes.json();
                
                if (ordersData.success && ordersData.data) {
                    productSalesCache = {};
                    const productSales = {};
                    const now = new Date();
                    const ninetyDaysAgo = new Date(now.getTime() - 90 * 24 * 60 * 60 * 1000);
                    
                    // ƒê·∫øm s·ªë l∆∞·ª£ng b√°n c·ªßa t·ª´ng s·∫£n ph·∫©m trong 90 ng√†y g·∫ßn nh·∫•t
                    for (const order of ordersData.data) {
                        if (!order.id || !order.ngayLap) continue;
                        
                        const orderDate = new Date(order.ngayLap);
                        if (orderDate < ninetyDaysAgo) continue; // Skip orders older than 90 days
                        
                        try {
                            const detailRes = await fetch(`${API_BASE}/chitiethd/${order.id}`);
                            const detailResult = await detailRes.json();
                            
                            if (detailResult.success && detailResult.data) {
                                detailResult.data.forEach(item => {
                                    const idHang = item.idHang;
                                    if (!productSales[idHang]) {
                                        productSales[idHang] = 0;
                                    }
                                    productSales[idHang] += parseInt(item.soluong || 0);
                                });
                            }
                        } catch (err) {
                            // Skip errors
                        }
                    }
                    
                    productSalesCache = productSales;
                    
                    // X√°c ƒë·ªãnh s·∫£n ph·∫©m b√°n ch·∫°y (top 20% s·ªë l∆∞·ª£ng b√°n)
                    const sortedProducts = Object.entries(productSales)
                        .sort((a, b) => b[1] - a[1]);
                    const top20Percent = Math.max(1, Math.floor(sortedProducts.length * 0.2));
                    bestSellingProductsCache = sortedProducts.slice(0, top20Percent).map(([id]) => parseInt(id));
                    
                    // X√°c ƒë·ªãnh s·∫£n ph·∫©m b√°n ch·∫≠m:
                    // 1. Sau 30 ng√†y nh·∫≠p h√†ng kh√¥ng sinh b·∫•t c·ª© h√≥a ƒë∆°n n√†o
                    // 2. S·ªë l∆∞·ª£ng b√°n trong 90 ng√†y g·∫ßn nh·∫•t < 5 s·∫£n ph·∫©m
                    slowMovingProductsCache = products
                        .filter(p => {
                            if (!p.ngayNhapCuoi) return false;
                            
                            const ngayNhapCuoi = new Date(p.ngayNhapCuoi);
                            const thirtyDaysAfterImport = new Date(ngayNhapCuoi.getTime() + 30 * 24 * 60 * 60 * 1000);
                            
                            // ƒêi·ªÅu ki·ªán 1: Sau 30 ng√†y nh·∫≠p h√†ng kh√¥ng sinh b·∫•t c·ª© h√≥a ƒë∆°n n√†o
                            const condition1 = now >= thirtyDaysAfterImport;
                            
                            // ƒêi·ªÅu ki·ªán 2: S·ªë l∆∞·ª£ng b√°n trong 90 ng√†y g·∫ßn nh·∫•t < 5
                            const salesIn90Days = productSales[p.id] || 0;
                            const condition2 = salesIn90Days < 5;
                            
                            return condition1 && condition2;
                        })
                        .map(p => p.id);
                }
            } catch (error) {
                console.error('Error loading product sales cache:', error);
            }
        }
        
        // √Åp d·ª•ng t·∫•t c·∫£ khuy·∫øn m√£i t·ª± ƒë·ªông
        function applyAutoPromotions() {
            // Reset gi√° v·ªÅ gi√° g·ªëc tr∆∞·ªõc
            cart.forEach(item => {
                item.price = item.originalPrice || item.price;
                item.autoDiscounts = [];
            });
            
            // 1. Gi·∫£m gi√° h√†ng b√°n ch·∫≠m (10%)
            applySlowMovingDiscount();
            
            // 2. Mua 1 h√†ng b√°n ch·∫°y t·∫∑ng 1 ph·ª• ki·ªán
            applyBestSellerGift();
            
            // 3. Gi·∫£m gi√° theo b·ªô trang ph·ª•c (ƒë∆∞·ª£c t√≠nh ·ªü renderCart)
            
            // 4. Gi·∫£m gi√° cho size kh√≥ b√°n (5-10%)
            applySizeDiscount();
            
            // 5. Gi·∫£m gi√° theo khung gi·ªù (ƒë∆∞·ª£c t√≠nh ·ªü renderCart)
            
            // 6. Gi·∫£m gi√° cho kh√°ch h√†ng th√¢n thi·∫øt (ƒë∆∞·ª£c t√≠nh ·ªü renderCart)
            
            // 7. X·∫£ t·ªìn cu·ªëi th√°ng (15%)
            applyEndOfMonthDiscount();
        }
        
        // 1. Gi·∫£m gi√° h√†ng b√°n ch·∫≠m (10%)
        function applySlowMovingDiscount() {
            cart.forEach(item => {
                const product = products.find(p => p.id === item.id);
                if (!product) return;
                
                // Ki·ªÉm tra xem c√≥ ph·∫£i s·∫£n ph·∫©m b√°n ch·∫≠m kh√¥ng
                if (slowMovingProductsCache.includes(product.id)) {
                    const discountPercent = 10;
                    const discountAmount = (item.originalPrice * discountPercent) / 100;
                    item.price = item.originalPrice - discountAmount;
                    item.autoDiscounts.push({
                        type: 'slow-moving',
                        label: 'B√°n ch·∫≠m -10%',
                        percent: discountPercent,
                        amount: discountAmount * item.quantity
                    });
                }
            });
        }
        
        // 2. Mua 1 h√†ng b√°n ch·∫°y t·∫∑ng 1 TRI √ÇN KH√ÅCH H√ÄNG
        function applyBestSellerGift() {
            // T√¨m s·∫£n ph·∫©m b√°n ch·∫°y trong cart
            const bestSellersInCart = cart.filter(item => {
                const product = products.find(p => p.id === item.id);
                return product && bestSellingProductsCache.includes(product.id);
            });
            
            // T√¨m ph·ª• ki·ªán b√°n ch·∫≠m c√≥ th·ªÉ t·∫∑ng
            const availableGifts = products.filter(p => {
                // Ph·ª• ki·ªán: t√™n ph√¢n lo·∫°i ch·ª©a "ph·ª• ki·ªán", "phu kien", "accessory"
                const tenPLSP = (p.tenPLSP || '').toLowerCase();
                const isPhuKien = tenPLSP.includes('TRI √ÇN KH√ÅCH H√ÄNG') || tenPLSP.includes('TRI √ÇN KH√ÅCH H√ÄNG') || 
                                  tenPLSP.includes('accessory') || tenPLSP.includes('TRI √ÇN KH√ÅCH H√ÄNG');
                return isPhuKien && slowMovingProductsCache.includes(p.id) && p.soluong > 0;
            });
            
            // M·ªói s·∫£n ph·∫©m b√°n ch·∫°y ƒë∆∞·ª£c t·∫∑ng 1 ph·ª• ki·ªán (ch∆∞a c√≥ trong cart)
            bestSellersInCart.forEach(bestSeller => {
                // Ki·ªÉm tra xem ƒë√£ c√≥ ph·ª• ki·ªán t·∫∑ng k√®m ch∆∞a
                const hasGift = cart.some(item => 
                    item.autoDiscounts && item.autoDiscounts.some(d => d.type === 'gift' && d.fromProductId === bestSeller.id)
                );
                
                if (!hasGift && availableGifts.length > 0) {
                    // Ch·ªçn ph·ª• ki·ªán ƒë·∫ßu ti√™n ch∆∞a c√≥ trong cart
                    const giftProduct = availableGifts.find(g => 
                        !cart.some(c => c.maHang === g.maHang)
                    ) || availableGifts[0];
                    
                    if (giftProduct) {
                        // Th√™m ph·ª• ki·ªán v√†o cart v·ªõi gi√° = 0
                        const phanLoai = phanLoaiSanPhamList.find(pl => pl.id === giftProduct.idPLSP);
                        cart.push({
                            id: giftProduct.id,
                            maHang: giftProduct.maHang,
                            name: giftProduct.tenHang,
                            price: 0,
                            originalPrice: giftProduct.giaban,
                            quantity: 1,
                            maxQty: giftProduct.soluong,
                            idPLSP: giftProduct.idPLSP,
                            tenPLSP: phanLoai ? phanLoai.tenPLSP : '',
                            soluong: giftProduct.soluong,
                            autoDiscounts: [{
                                type: 'gift',
                                label: 'Tri √¢n kh√°ch h√†ng',
                                fromProductId: bestSeller.id,
                                fromProductName: bestSeller.name
                            }]
                        });
                    }
                }
            });
        }
        
        // 3. Gi·∫£m gi√° theo b·ªô trang ph·ª•c (√°o + qu·∫ßn + ph·ª• ki·ªán = 10%)
        function calculateComboDiscount() {
            // Ph√¢n lo·∫°i s·∫£n ph·∫©m trong cart
            const aoItems = [];
            const quanItems = [];
            const phuKienItems = [];
            
            cart.forEach(item => {
                const tenPLSP = (item.tenPLSP || '').toLowerCase();
                if (tenPLSP.includes('√°o') || tenPLSP.includes('ao') || tenPLSP.includes('shirt') || tenPLSP.includes('top')) {
                    aoItems.push(item);
                } else if (tenPLSP.includes('qu·∫ßn') || tenPLSP.includes('quan') || tenPLSP.includes('pant') || tenPLSP.includes('bottom')) {
                    quanItems.push(item);
                } else if (tenPLSP.includes('ph·ª• ki·ªán') || tenPLSP.includes('phu kien') || tenPLSP.includes('accessory')) {
                    phuKienItems.push(item);
                }
            });
            
            // N·∫øu c√≥ ƒë·ªß c·∫£ 3 lo·∫°i, √°p d·ª•ng gi·∫£m 10% cho b·ªô r·∫ª nh·∫•t
            if (aoItems.length > 0 && quanItems.length > 0 && phuKienItems.length > 0) {
                // T√¨m b·ªô r·∫ª nh·∫•t (t·ªïng gi√° th·∫•p nh·∫•t)
                let minComboPrice = Infinity;
                let bestCombo = null;
                
                aoItems.forEach(ao => {
                    quanItems.forEach(quan => {
                        phuKienItems.forEach(pk => {
                            const comboPrice = (ao.price * ao.quantity) + (quan.price * quan.quantity) + (pk.price * pk.quantity);
                            if (comboPrice < minComboPrice) {
                                minComboPrice = comboPrice;
                                bestCombo = { ao, quan, pk, price: comboPrice };
                            }
                        });
                    });
                });
                
                if (bestCombo) {
                    const discountPercent = 10;
                    const discountAmount = (bestCombo.price * discountPercent) / 100;
                    
                    // √Åp d·ª•ng gi·∫£m gi√° cho t·ª´ng s·∫£n ph·∫©m trong b·ªô (t·ª∑ l·ªá)
                    const totalPrice = bestCombo.price;
                    bestCombo.ao.autoDiscounts = bestCombo.ao.autoDiscounts || [];
                    bestCombo.quan.autoDiscounts = bestCombo.quan.autoDiscounts || [];
                    bestCombo.pk.autoDiscounts = bestCombo.pk.autoDiscounts || [];
                    
                    const aoDiscount = (bestCombo.ao.price * bestCombo.ao.quantity / totalPrice) * discountAmount;
                    const quanDiscount = (bestCombo.quan.price * bestCombo.quan.quantity / totalPrice) * discountAmount;
                    const pkDiscount = (bestCombo.pk.price * bestCombo.pk.quantity / totalPrice) * discountAmount;
                    
                    bestCombo.ao.price = Math.max(0, bestCombo.ao.price - (aoDiscount / bestCombo.ao.quantity));
                    bestCombo.quan.price = Math.max(0, bestCombo.quan.price - (quanDiscount / bestCombo.quan.quantity));
                    bestCombo.pk.price = Math.max(0, bestCombo.pk.price - (pkDiscount / bestCombo.pk.quantity));
                    
                    bestCombo.ao.autoDiscounts.push({
                        type: 'combo',
                        label: 'B·ªô -10%',
                        percent: discountPercent,
                        amount: aoDiscount
                    });
                    bestCombo.quan.autoDiscounts.push({
                        type: 'combo',
                        label: 'B·ªô -10%',
                        percent: discountPercent,
                        amount: quanDiscount
                    });
                    bestCombo.pk.autoDiscounts.push({
                        type: 'combo',
                        label: 'B·ªô -10%',
                        percent: discountPercent,
                        amount: pkDiscount
                    });
                    
                    return {
                        amount: discountAmount,
                        label: 'Gi·∫£m gi√° b·ªô trang ph·ª•c (√°o + qu·∫ßn + ph·ª• ki·ªán)'
                    };
                }
            }
            
            return { amount: 0, label: '' };
        }
        
        // 4. Gi·∫£m gi√° cho size kh√≥ b√°n (5-10%)
        function applySizeDiscount() {
            cart.forEach(item => {
                const product = products.find(p => p.id === item.id);
                if (!product) return;
                
                // Ki·ªÉm tra size trong t√™n s·∫£n ph·∫©m ho·∫∑c m√£ h√†ng
                const nameLower = (product.tenHang || '').toLowerCase();
                const maHangLower = (product.maHang || '').toLowerCase();
                
                // Size kh√≥ b√°n: XS, XXL, XXXL
                const hardSizes = ['xs', 'xxl', 'xxxl', '2xl', '3xl'];
                const hasHardSize = hardSizes.some(size => 
                    nameLower.includes(size) || maHangLower.includes(size)
                );
                
                if (hasHardSize) {
                    // Gi·∫£m 10% cho XS, 5% cho XXL/XXXL
                    const discountPercent = nameLower.includes('xs') ? 10 : 5;
                    const discountAmount = (item.originalPrice * discountPercent) / 100;
                    item.price = item.originalPrice - discountAmount;
                    item.autoDiscounts.push({
                        type: 'size',
                        label: `Size kh√≥ b√°n -${discountPercent}%`,
                        percent: discountPercent,
                        amount: discountAmount * item.quantity
                    });
                }
            });
        }
        
        // 5. Gi·∫£m gi√° theo khung gi·ªù (13h-15h = 10%)
        function calculateTimeDiscount(subtotal) {
            const now = new Date();
            const hour = now.getHours();
            
            // Khung gi·ªù √≠t kh√°ch: 13h-15h (1PM - 3PM)
            if (hour >= 13 && hour < 15) {
                const discountPercent = 10;
                const discountAmount = (subtotal * discountPercent) / 100;
                return {
                    amount: discountAmount,
                    label: 'Gi·∫£m gi√° khung gi·ªù √≠t kh√°ch (13h-15h)'
                };
            }
            
            return { amount: 0, label: '' };
        }
        
        // 6. Gi·∫£m gi√° cho kh√°ch h√†ng th√¢n thi·∫øt (5%)
        function calculateVIPDiscount(subtotal) {
            if (!selectedCustomer) return { amount: 0, label: '' };
            
            // Kh√°ch h√†ng th√¢n thi·∫øt: ƒëi·ªÉm t√≠ch l≈©y > 100 ho·∫∑c ph√¢n lo·∫°i VIP
            const customerType = customerTypes.find(t => t.id === selectedCustomer.idPLKH);
            const isVIP = (selectedCustomer.diemtichluy || 0) > 100 || 
                         (customerType && (
                             (customerType.tenPLKH || '').toLowerCase().includes('vip') ||
                             (customerType.tenPLKH || '').toLowerCase().includes('th√¢n thi·∫øt') ||
                             (customerType.tenPLKH || '').toLowerCase().includes('than thiet')
                         ));
            
            if (isVIP) {
                const discountPercent = 5;
                const discountAmount = (subtotal * discountPercent) / 100;
                return {
                    amount: discountAmount,
                    label: 'Gi·∫£m gi√° kh√°ch h√†ng th√¢n thi·∫øt/VIP'
                };
            }
            
            return { amount: 0, label: '' };
        }
        
        // 7. X·∫£ t·ªìn cu·ªëi th√°ng (15% cho s·∫£n ph·∫©m t·ªìn kho cao)
        function applyEndOfMonthDiscount() {
            const now = new Date();
            const day = now.getDate();
            const daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
            
            // Cu·ªëi th√°ng: 3 ng√†y cu·ªëi
            const isEndOfMonth = day > (daysInMonth - 3);
            
            if (isEndOfMonth) {
                cart.forEach(item => {
                    const product = products.find(p => p.id === item.id);
                    if (!product) return;
                    
                    // S·∫£n ph·∫©m t·ªìn kho cao: > 100
                    if (product.soluong > 100) {
                        // Ch·ªâ √°p d·ª•ng n·∫øu ch∆∞a c√≥ khuy·∫øn m√£i b√°n ch·∫≠m
                        const hasSlowMoving = item.autoDiscounts && item.autoDiscounts.some(d => d.type === 'slow-moving');
                        
                        if (!hasSlowMoving) {
                            const discountPercent = 15;
                            const discountAmount = (item.originalPrice * discountPercent) / 100;
                            item.price = item.originalPrice - discountAmount;
                            item.autoDiscounts.push({
                                type: 'end-of-month',
                                label: 'X·∫£ t·ªìn -15%',
                                percent: discountPercent,
                                amount: discountAmount * item.quantity
                            });
                        }
                    }
                });
            }
        }

        function renderCart() {
            const itemsContainer = document.getElementById('cart-items');
            const summaryContainer = document.getElementById('cart-summary');

            if (!itemsContainer || !summaryContainer) return;

            if (cart.length === 0) {
                itemsContainer.innerHTML = `<div class="cart-empty"><p>Gi·ªè h√†ng tr·ªëng</p></div>`;
                summaryContainer.innerHTML = '';
                return;
            }

            // √Åp d·ª•ng khuy·∫øn m√£i t·ª± ƒë·ªông tr∆∞·ªõc khi render
            applyAutoPromotions();

            itemsContainer.innerHTML = cart.map(item => {
                const hasDiscount = item.price < item.originalPrice;
                const discountBadges = item.autoDiscounts && item.autoDiscounts.length > 0 
                    ? item.autoDiscounts.map(d => `<span style="background: #ff9800; color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; margin-left: 5px;">${d.label}</span>`).join('')
                    : '';
                return `
                <div class="cart-item">
                    <div class="cart-item-info">
                        <div class="cart-item-name">${item.name} ${discountBadges}</div>
                        <div style="display: flex; align-items: center; gap: 8px; margin-top: 3px;">
                            ${hasDiscount ? `<span style="text-decoration: line-through; color: #999; font-size: 11px;">${formatCurrency(item.originalPrice)}</span>` : ''}
                            <div class="cart-item-price" style="${hasDiscount ? 'color: #00b894; font-weight: 700;' : ''}">${formatCurrency(item.price)}</div>
                        </div>
                    </div>
                    <div class="cart-item-qty">
                        <input type="number" class="qty-input" value="${item.quantity}" min="1" max="${item.maxQty}" 
                               onchange="updateCartQtyInput('${item.maHang}', this.value)" 
                               onblur="validateCartQty('${item.maHang}', this)"
                               style="width: 70px; padding: 8px; text-align: center; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 14px; font-weight: 600;">
                    </div>
                    <button class="cart-item-remove" onclick="removeFromCart('${item.maHang}')">‚úï</button>
                </div>
            `;
            }).join('');

            // T√≠nh subtotal v·ªõi gi√° ƒë√£ √°p d·ª•ng khuy·∫øn m√£i t·ª± ƒë·ªông
            const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const originalSubtotal = cart.reduce((sum, item) => sum + ((item.originalPrice || item.price) * item.quantity), 0);
            const autoDiscountTotal = originalSubtotal - subtotal;
            
            // T√≠nh khuy·∫øn m√£i theo b·ªô (n·∫øu c√≥)
            const comboDiscount = calculateComboDiscount();
            
            // T√≠nh khuy·∫øn m√£i kh√°ch h√†ng th√¢n thi·∫øt
            const vipDiscount = calculateVIPDiscount(originalSubtotal - autoDiscountTotal);
            
            // T√≠nh khuy·∫øn m√£i theo khung gi·ªù
            const timeDiscount = calculateTimeDiscount(originalSubtotal - autoDiscountTotal);
            
            // T·ªïng khuy·∫øn m√£i t·ª± ƒë·ªông
            const totalAutoDiscount = autoDiscountTotal + comboDiscount.amount + vipDiscount.amount + timeDiscount.amount;
            
            // Subtotal sau khuy·∫øn m√£i t·ª± ƒë·ªông
            const subtotalAfterAuto = originalSubtotal - totalAutoDiscount;
            
            // Khuy·∫øn m√£i m√£ gi·∫£m gi√° (n·∫øu c√≥)
            const discountAmount = appliedDiscount ? (subtotalAfterAuto * (appliedDiscount.phantramGiam || appliedDiscount.phantramgiam || 0) / 100) : 0;
            
            // T√≠nh ƒëi·ªÉm c√≥ th·ªÉ d√πng (1 ƒëi·ªÉm = 1000ƒë)
            const customerPoints = selectedCustomer ? (selectedCustomer.diemtichluy || 0) : 0;
            const usePoints = document.getElementById('use-points-checkbox')?.checked || false;
            const pointsValue = usePoints ? Math.min(customerPoints * 1000, subtotalAfterAuto - discountAmount) : 0;
            
            const total = subtotalAfterAuto - discountAmount - pointsValue;
            
            // ƒêi·ªÉm t√≠ch l≈©y: 100000ƒë = 1 ƒëi·ªÉm, t·ªëi thi·ªÉu 1 ƒëi·ªÉm
            const pointsEarned = total > 0 ? Math.max(1, Math.floor(total / 100000)) : 0;

            summaryContainer.innerHTML = `
                <div class="cart-summary">
                    <!-- Customer Section -->
                    <div class="customer-section">
                        <div class="customer-section-title">Th√¥ng Tin Kh√°ch H√†ng</div>
                        ${selectedCustomer ? `
                            <div class="customer-info-box">
                                <p><strong>${selectedCustomer.tenKH}</strong></p>
                                <p>M√£: ${selectedCustomer.maKH} | SƒêT: ${selectedCustomer.sdt || '-'}</p>
                                <p>ƒêi·ªÉm t√≠ch l≈©y: <strong>${customerPoints} ƒëi·ªÉm</strong></p>
                            </div>
                            ${customerPoints > 0 ? `
                                <div class="points-section">
                                    <label>
                                        <input type="checkbox" id="use-points-checkbox" onchange="onPointsCheckboxChange()" ${usePoints ? 'checked' : ''} ${appliedDiscount ? 'disabled' : ''}>
                                        S·ª≠ d·ª•ng ${customerPoints} ƒëi·ªÉm (1 ƒëi·ªÉm = 1.000ƒë, t·ªëi ƒëa ${formatCurrency(customerPoints * 1000)})
                                    </label>
                                    ${appliedDiscount ? '<p style="font-size: 11px; color: #ff9800; margin-top: 5px; margin-bottom: 0;">‚ö†Ô∏è Kh√¥ng th·ªÉ d√πng ƒëi·ªÉm khi ƒë√£ √°p d·ª•ng m√£ gi·∫£m gi√°</p>' : ''}
                                </div>
                            ` : ''}
                            <button class="btn btn-outline btn-sm" style="margin-top: 10px; width: 100%;" onclick="clearCustomer()">ƒê·ªïi kh√°ch h√†ng</button>
                        ` : `
                            <div class="form-row">
                                <div class="form-group" style="margin-bottom: 0;">
                                    <label>H·ªç T√™n</label>
                                    <input type="text" id="guest-name" placeholder="Nh·∫≠p h·ªç t√™n">
                                </div>
                                <div class="form-group" style="margin-bottom: 0;">
                                    <label>S·ªë ƒêi·ªán Tho·∫°i</label>
                                    <input type="text" id="guest-phone" placeholder="0xxxxxxxxx">
                                </div>
                            </div>
                            <div style="display: flex; gap: 8px; margin-top: 10px;">
                                <button class="btn btn-outline btn-sm" style="flex: 1;" onclick="openCustomerModal()">Ch·ªçn KH c√≥ s·∫µn</button>
                                <button class="btn btn-primary btn-sm" style="flex: 1;" onclick="openNewCustomerModal()">Th√™m KH m·ªõi</button>
                            </div>
                        `}
                    </div>

                    <!-- Discount Section -->
                    <div class="form-group">
                        <label>M√£ Gi·∫£m Gi√°</label>
                        ${appliedDiscount ? `
                            <div style="display: flex; align-items: center; justify-content: space-between; background: #e6fff5; padding: 10px; border-radius: 8px;">
                                <span style="color: #00b894; font-weight: 600; font-size: 13px;">‚úì ${appliedDiscount.maKM || appliedDiscount.code} (-${appliedDiscount.phantramGiam || appliedDiscount.phantramgiam}%)</span>
                                <button onclick="removeDiscount()" style="background: none; border: none; color: #e74c3c; cursor: pointer;">‚úï</button>
                            </div>
                            ${usePoints ? '<p style="font-size: 11px; color: #ff9800; margin-top: 5px; margin-bottom: 0;">‚ö†Ô∏è Kh√¥ng th·ªÉ d√πng m√£ gi·∫£m gi√° khi ƒë√£ ch·ªçn s·ª≠ d·ª•ng ƒëi·ªÉm</p>' : ''}
                        ` : `
                            <select id="discount-code" onchange="applyDiscount()" ${usePoints ? 'disabled' : ''}>
                                <option value="">-- Kh√¥ng √°p d·ª•ng --</option>
                                ${discountList.map(d => `
                                    <option value="${d.maKM || d.code || ''}">
                                        ${d.maKM || d.code} - Gi·∫£m ${d.phantramGiam || d.phantramgiam}% ${d.tenKM || d.mota ? '(' + (d.tenKM || d.mota) + ')' : ''}
                                    </option>
                                `).join('')}
                            </select>
                            ${usePoints ? '<p style="font-size: 11px; color: #ff9800; margin-top: 5px; margin-bottom: 0;">‚ö†Ô∏è Kh√¥ng th·ªÉ d√πng m√£ gi·∫£m gi√° khi ƒë√£ ch·ªçn s·ª≠ d·ª•ng ƒëi·ªÉm</p>' : ''}
                            ${discountList.length === 0 ? '<p style="font-size: 11px; color: #999; margin-top: 5px;">Kh√¥ng c√≥ m√£ gi·∫£m gi√° kh·∫£ d·ª•ng</p>' : ''}
                        `}
                    </div>

                    <!-- Employee -->
                    <div class="form-group">
                        <label>Nh√¢n Vi√™n B√°n H√†ng</label>
                        <select id="nhanvien-select">
                            <option value="">-- Ch·ªçn nh√¢n vi√™n --</option>
                            ${(() => {
                                // L·ªçc nh√¢n vi√™n ch·ªâ hi·ªÉn th·ªã nh√¢n vi√™n b√°n h√†ng
                                const banHangNhanVien = nhanvienList.filter(nv => {
                                    const tenVT = (nv.tenVT || '').toLowerCase();
                                    return tenVT.includes('b√°n h√†ng') || tenVT.includes('ban hang') || 
                                           tenVT.includes('seller') || tenVT.includes('sales') ||
                                           tenVT.includes('nh√¢n vi√™n') || tenVT.includes('nhan vien');
                                });
                                return banHangNhanVien.map(nv => `<option value="${nv.id}">${nv.tenNV} (${nv.maNV})</option>`).join('');
                            })()}
                        </select>
                        ${(() => {
                            const banHangNhanVien = nhanvienList.filter(nv => {
                                const tenVT = (nv.tenVT || '').toLowerCase();
                                return tenVT.includes('b√°n h√†ng') || tenVT.includes('ban hang') || 
                                       tenVT.includes('seller') || tenVT.includes('sales') ||
                                       tenVT.includes('nh√¢n vi√™n') || tenVT.includes('nhan vien');
                            });
                            return banHangNhanVien.length === 0 ? '<p style="font-size: 11px; color: #dc2626; margin-top: 5px;">Kh√¥ng c√≥ nh√¢n vi√™n b√°n h√†ng</p>' : '';
                        })()}
                    </div>

                    <!-- Summary -->
                    <div class="cart-summary-row">
                        <span class="label">T·∫°m t√≠nh:</span>
                        <span class="value">${formatCurrency(originalSubtotal)}</span>
                    </div>
                    ${totalAutoDiscount > 0 ? `
                        <div class="cart-summary-row" style="background: #fff3e0; padding: 8px; border-radius: 6px; margin: 5px 0;">
                            <span class="label" style="color: #e65100; font-weight: 600;">üéÅ Khuy·∫øn m√£i t·ª± ƒë·ªông:</span>
                            <span class="value value-success" style="color: #e65100; font-weight: 700;">-${formatCurrency(totalAutoDiscount)}</span>
                        </div>
                        ${autoDiscountTotal > 0 ? `
                            <div style="padding-left: 15px; font-size: 11px; color: #666; margin-bottom: 5px;">
                                ‚Ä¢ Gi·∫£m gi√° s·∫£n ph·∫©m: -${formatCurrency(autoDiscountTotal)}
                            </div>
                        ` : ''}
                        ${comboDiscount.amount > 0 ? `
                            <div style="padding-left: 15px; font-size: 11px; color: #666; margin-bottom: 5px;">
                                ‚Ä¢ ${comboDiscount.label}: -${formatCurrency(comboDiscount.amount)}
                            </div>
                        ` : ''}
                        ${vipDiscount.amount > 0 ? `
                            <div style="padding-left: 15px; font-size: 11px; color: #666; margin-bottom: 5px;">
                                ‚Ä¢ ${vipDiscount.label}: -${formatCurrency(vipDiscount.amount)}
                            </div>
                        ` : ''}
                        ${timeDiscount.amount > 0 ? `
                            <div style="padding-left: 15px; font-size: 11px; color: #666; margin-bottom: 5px;">
                                ‚Ä¢ ${timeDiscount.label}: -${formatCurrency(timeDiscount.amount)}
                            </div>
                        ` : ''}
                    ` : ''}
                    ${discountAmount > 0 ? `
                        <div class="cart-summary-row">
                            <span class="label">Gi·∫£m gi√° (M√£):</span>
                            <span class="value value-success">-${formatCurrency(discountAmount)}</span>
                        </div>
                    ` : ''}
                    ${pointsValue > 0 ? `
                        <div class="cart-summary-row">
                            <span class="label">ƒêi·ªÉm quy ƒë·ªïi:</span>
                            <span class="value value-success">-${formatCurrency(pointsValue)}</span>
                        </div>
                    ` : ''}
                    <div class="cart-summary-row total">
                        <span>T·ªïng c·ªông:</span>
                        <span>${formatCurrency(total)}</span>
                    </div>
                    ${selectedCustomer ? `
                        <p style="font-size: 11px; color: #666; margin-top: 8px; text-align: center;">
                            T√≠ch l≈©y: +${pointsEarned} ƒëi·ªÉm (100.000ƒë = 1 ƒëi·ªÉm, t·ªëi thi·ªÉu 1 ƒëi·ªÉm)
                        </p>
                    ` : ''}
                    
                    <button class="btn btn-success" style="width: 100%; margin-top: 15px;" onclick="createInvoice()">
                        T·∫°o H√≥a ƒê∆°n
                    </button>
                </div>
            `;
        }

        function clearCustomer() {
            selectedCustomer = null;
            renderCart();
        }

        function applyDiscount() {
            const selectElement = document.getElementById('discount-code');
            const code = selectElement.value;
            
            if (!code) {
                appliedDiscount = null;
                renderCart();
                return;
            }

            // N·∫øu ƒëang s·ª≠ d·ª•ng ƒëi·ªÉm, kh√¥ng cho √°p d·ª•ng m√£ gi·∫£m gi√°
            const usePointsCheckbox = document.getElementById('use-points-checkbox');
            if (usePointsCheckbox && usePointsCheckbox.checked) {
                showToast('Kh√¥ng th·ªÉ d√πng m√£ gi·∫£m gi√° khi ƒë√£ ch·ªçn s·ª≠ d·ª•ng ƒëi·ªÉm t√≠ch l≈©y', 'error');
                selectElement.value = '';
                return;
            }

            // T√¨m discount theo maKM (schema m·ªõi) ho·∫∑c code (schema c≈©)
            const discount = discountList.find(d => (d.maKM || d.code) === code);
            if (discount) {
                appliedDiscount = discount;
                // Uncheck checkbox s·ª≠ d·ª•ng ƒëi·ªÉm n·∫øu ƒëang check
                if (usePointsCheckbox) {
                    usePointsCheckbox.checked = false;
                }
                renderCart();
                showToast(`√Åp d·ª•ng khuy·∫øn m√£i ${discount.phantramGiam || discount.phantramgiam}%`, 'success');
            } else {
                showToast('Kh√¥ng t√¨m th·∫•y m√£ gi·∫£m gi√°', 'error');
            }
        }

        function removeDiscount() {
            appliedDiscount = null;
            renderCart();
        }

        function onPointsCheckboxChange() {
            const usePointsCheckbox = document.getElementById('use-points-checkbox');
            const isChecked = usePointsCheckbox.checked;
            
            // N·∫øu check s·ª≠ d·ª•ng ƒëi·ªÉm, x√≥a m√£ gi·∫£m gi√° ƒë√£ √°p d·ª•ng
            if (isChecked && appliedDiscount) {
                appliedDiscount = null;
                showToast('ƒê√£ b·ªè m√£ gi·∫£m gi√° v√¨ ƒë√£ ch·ªçn s·ª≠ d·ª•ng ƒëi·ªÉm t√≠ch l≈©y', 'info');
            }
            
            renderCart();
        }

        function openCustomerModal() {
            const modal = document.getElementById('customer-modal');
            const body = document.getElementById('customer-modal-body');

            body.innerHTML = `
                <div class="search-box" style="background: transparent; padding: 0; margin-bottom: 15px;">
                    <input type="text" class="search-input" id="search-customer" placeholder="T√¨m theo t√™n ho·∫∑c SƒêT..." oninput="filterCustomersModal()">
                </div>
                <div id="customer-list" style="max-height: 350px; overflow-y: auto;">
                    ${renderCustomerList(customers)}
                </div>
            `;

            modal.classList.add('active');
        }

        function renderCustomerList(data) {
            if (!data.length) {
                return '<p style="text-align: center; color: #999; padding: 20px;">Kh√¥ng c√≥ kh√°ch h√†ng</p>';
            }

            return data.map(c => `
                <div style="padding: 12px; border-bottom: 1px solid #f0f0f0; cursor: pointer; transition: background 0.2s;" 
                     onmouseover="this.style.background='#f8f9fa'" 
                     onmouseout="this.style.background='white'"
                     onclick="selectCustomer('${c.maKH}')">
                    <div style="font-weight: 600; color: #1a1a2e; font-size: 13px;">${c.tenKH}</div>
                    <div style="font-size: 11px; color: #888;">M√£: ${c.maKH} | SƒêT: ${c.sdt || '-'} | ƒêi·ªÉm: ${c.diemtichluy || 0}</div>
                </div>
            `).join('');
        }

        function filterCustomersModal() {
            const keyword = document.getElementById('search-customer').value.toLowerCase();
            const filtered = customers.filter(c =>
                c.tenKH.toLowerCase().includes(keyword) ||
                c.maKH.toLowerCase().includes(keyword) ||
                (c.sdt && c.sdt.includes(keyword))
            );
            document.getElementById('customer-list').innerHTML = renderCustomerList(filtered);
        }

        function selectCustomer(maKH) {
            selectedCustomer = customers.find(c => c.maKH === maKH || c.id === parseInt(maKH));
            closeCustomerModal();
            renderCart();
            showToast(`ƒê√£ ch·ªçn kh√°ch h√†ng: ${selectedCustomer.tenKH}`, 'success');
        }

        function closeCustomerModal() {
            document.getElementById('customer-modal').classList.remove('active');
        }

        function openNewCustomerModal() {
            const typeSelect = document.getElementById('new-cust-type');
            
            // T√¨m "Kh√°ch L·∫ª" trong danh s√°ch ph√¢n lo·∫°i
            const khachLe = customerTypes.find(t => 
                t.tenPLKH && (
                    t.tenPLKH.toLowerCase().includes('l·∫ª') || 
                    t.tenPLKH.toLowerCase().includes('le') ||
                    t.maPLKH && t.maPLKH.toLowerCase().includes('khl')
                )
            );
            
            // T√¨m hidden input
            const hiddenInput = document.getElementById('new-cust-type-hidden');
            
            // N·∫øu t√¨m th·∫•y "Kh√°ch L·∫ª", ch·ªçn m·∫∑c ƒë·ªãnh v√† disable
            if (khachLe) {
                typeSelect.innerHTML = customerTypes.map(t => 
                    `<option value="${t.id}" ${t.id === khachLe.id ? 'selected' : ''}>${t.tenPLKH}</option>`
                ).join('');
                typeSelect.value = khachLe.id;
                if (hiddenInput) hiddenInput.value = khachLe.id;
            } else {
                // N·∫øu kh√¥ng t√¨m th·∫•y, ch·ªçn ph·∫ßn t·ª≠ ƒë·∫ßu ti√™n
            typeSelect.innerHTML = customerTypes.map(t => 
                `<option value="${t.id}">${t.tenPLKH}</option>`
            ).join('');
                if (customerTypes.length > 0) {
                    typeSelect.value = customerTypes[0].id;
                    if (hiddenInput) hiddenInput.value = customerTypes[0].id;
                }
            }
            
            // ƒê·∫£m b·∫£o field lu√¥n disabled v√† hi·ªÉn th·ªã "Kh√°ch L·∫ª"
            typeSelect.disabled = true;
            
            document.getElementById('new-customer-modal').classList.add('active');
        }

        function closeNewCustomerModal() {
            document.getElementById('new-customer-modal').classList.remove('active');
            document.getElementById('new-customer-form').reset();
        }

        async function saveNewCustomer(event) {
            event.preventDefault();
            
            // Kh√¥ng c·∫ßn nh·∫≠p m√£ KH, server t·ª± ƒë·ªông sinh
                const data = {
                tenKH: document.getElementById('new-cust-name').value.trim(),
                sdt: document.getElementById('new-cust-phone').value.trim(),
                idPLKH: document.getElementById('new-cust-type-hidden').value || document.getElementById('new-cust-type').value, // D√πng hidden input ho·∫∑c select
                diachi: document.getElementById('new-cust-address').value.trim()
            };

            if (!data.tenKH) {
                showToast('Vui l√≤ng nh·∫≠p t√™n kh√°ch h√†ng', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/khachhang`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (result.success) {
                    // Reload customers
                    const customersRes = await fetch(`${API_BASE}/khachhang`);
                    const customersData = await customersRes.json();
                    if (customersData.success) customers = customersData.data;

                    // Select the new customer (m√£ KH ƒë∆∞·ª£c server tr·∫£ v·ªÅ)
                    selectedCustomer = customers.find(c => c.maKH === result.data.maKH);
                    
                    closeNewCustomerModal();
                    renderCart();
                    showToast('ƒê√£ th√™m kh√°ch h√†ng m·ªõi (m√£: ' + result.data.maKH + ')', 'success');
                } else {
                    showToast(result.message || 'L·ªói th√™m kh√°ch h√†ng', 'error');
                }
            } catch (error) {
                showToast('L·ªói: ' + error.message, 'error');
            }
        }

        async function createInvoice() {
            if (cart.length === 0) {
                showToast('Gi·ªè h√†ng tr·ªëng', 'error');
                return;
            }

            const selectedNVValue = document.getElementById('nhanvien-select').value;
            if (!selectedNVValue) {
                showToast('Vui l√≤ng ch·ªçn nh√¢n vi√™n b√°n h√†ng', 'error');
                return;
            }

            try {
                // T√¨m nh√¢n vi√™n ƒë∆∞·ª£c ch·ªçn ƒë·ªÉ l·∫•y id
                const selectedNV = nhanvienList.find(nv => nv.maNV === selectedNVValue || nv.id === parseInt(selectedNVValue));
                if (!selectedNV || !selectedNV.id) {
                    showToast('Kh√¥ng t√¨m th·∫•y nh√¢n vi√™n', 'error');
                    return;
                }

                // √Åp d·ª•ng l·∫°i khuy·∫øn m√£i t·ª± ƒë·ªông tr∆∞·ªõc khi t√≠nh to√°n
                applyAutoPromotions();
                
                // T√≠nh to√°n v·ªõi khuy·∫øn m√£i t·ª± ƒë·ªông
                const originalSubtotal = cart.reduce((sum, item) => sum + ((item.originalPrice || item.price) * item.quantity), 0);
                const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                const autoDiscountTotal = originalSubtotal - subtotal;
                
                // T√≠nh khuy·∫øn m√£i theo b·ªô, VIP, khung gi·ªù
                const comboDiscount = calculateComboDiscount();
                const vipDiscount = calculateVIPDiscount(originalSubtotal - autoDiscountTotal);
                const timeDiscount = calculateTimeDiscount(originalSubtotal - autoDiscountTotal);
                const totalAutoDiscount = autoDiscountTotal + comboDiscount.amount + vipDiscount.amount + timeDiscount.amount;
                const subtotalAfterAuto = originalSubtotal - totalAutoDiscount;
                
                // Khuy·∫øn m√£i m√£ gi·∫£m gi√°
                const discountAmount = appliedDiscount ? (subtotalAfterAuto * (appliedDiscount.phantramGiam || appliedDiscount.phantramgiam || 0) / 100) : 0;
                
                const usePoints = document.getElementById('use-points-checkbox')?.checked || false;
                const customerPoints = selectedCustomer ? (selectedCustomer.diemtichluy || 0) : 0;
                
                // T√≠nh ƒëi·ªÉm c√≥ th·ªÉ d√πng: d√πng h·∫øt ƒëi·ªÉm n·∫øu c√≥
                const pointsValue = usePoints ? Math.min(customerPoints * 1000, subtotalAfterAuto - discountAmount) : 0;
                const pointsUsed = usePoints ? Math.floor(pointsValue / 1000) : 0;
                
                const total = subtotalAfterAuto - discountAmount - pointsValue;
                
                // ƒêi·ªÉm t√≠ch l≈©y: 100000ƒë = 1 ƒëi·ªÉm, t·ªëi thi·ªÉu 1 ƒëi·ªÉm
                const pointsEarned = total > 0 ? Math.max(1, Math.floor(total / 100000)) : 0;

                // Create invoice (server t·ª± ƒë·ªông sinh maHD)
                // Schema m·ªõi s·ª≠ d·ª•ng id thay v√¨ m√£ cho foreign keys
                // G·ª≠i diemDaDung ƒë·ªÉ server tr·ª´ ƒëi·ªÉm TR∆Ø·ªöC khi t·∫°o h√≥a ƒë∆°n
                console.log('Creating invoice with discount:', appliedDiscount);
                console.log('Points to use:', pointsUsed);
                const invoiceData = {
                    idNV: selectedNV.id, // D√πng id
                    idKH: selectedCustomer ? (selectedCustomer.id || null) : null, // D√πng id
                    idKM: appliedDiscount ? (appliedDiscount.id || null) : null, // D√πng id
                    diemDaDung: pointsUsed // G·ª≠i ƒëi·ªÉm ƒë√£ d√πng ƒë·ªÉ server tr·ª´ v√† l∆∞u
                };
                console.log('Invoice data:', invoiceData);

                const invoiceRes = await fetch(`${API_BASE}/hoadon`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(invoiceData)
                });

                const invoiceResult = await invoiceRes.json();

                if (!invoiceResult.success) {
                    showToast(invoiceResult.message || 'L·ªói t·∫°o h√≥a ƒë∆°n', 'error');
                    return;
                }
                
                // L·∫•y id v√† m√£ HD t·ª´ server
                const idHD = invoiceResult.data.id;
                const maHD = invoiceResult.data.maHD;

                // Add invoice details (server t·ª± ƒë·ªông tr·ª´ h√†ng trong kho)
                // S·ª≠ d·ª•ng gi√° ƒë√£ √°p d·ª•ng khuy·∫øn m√£i t·ª± ƒë·ªông (item.price)
                for (const item of cart) {
                    const product = products.find(p => p.maHang === item.maHang);
                    if (!product || !product.id) {
                        showToast(`Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m ${item.name}`, 'error');
                        continue;
                    }
                    
                    // S·ª≠ d·ª•ng gi√° ƒë√£ √°p d·ª•ng khuy·∫øn m√£i t·ª± ƒë·ªông
                    // N·∫øu item.price = 0 (s·∫£n ph·∫©m t·∫∑ng k√®m), v·∫´n l∆∞u gi√° g·ªëc ƒë·ªÉ tracking
                    const detailData = {
                        idHD: idHD, // D√πng id
                        idHang: product.id, // D√πng id
                        soluong: item.quantity,
                        dongia: item.price || 0 // Gi√° ƒë√£ √°p d·ª•ng khuy·∫øn m√£i t·ª± ƒë·ªông (c√≥ th·ªÉ = 0 n·∫øu l√† qu√† t·∫∑ng)
                    };

                    const detailRes = await fetch(`${API_BASE}/chitiethd`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(detailData)
                    });
                    
                    const detailResult = await detailRes.json();
                    if (!detailResult.success) {
                        showToast(`L·ªói th√™m s·∫£n ph·∫©m ${item.name}: ${detailResult.message}`, 'error');
                        // Rollback: x√≥a h√≥a ƒë∆°n n·∫øu c√≥ l·ªói
                        await fetch(`${API_BASE}/hoadon/${idHD}`, { method: 'DELETE' });
                        return;
                    }
                }
                
                // Recalculate invoice total v·ªõi m√£ gi·∫£m gi√° v√† ƒëi·ªÉm (n·∫øu c√≥)
                // Server ƒë√£ tr·ª´ ƒëi·ªÉm khi t·∫°o h√≥a ƒë∆°n, b√¢y gi·ªù c·∫ßn c·∫≠p nh·∫≠t t·ªïng ti·ªÅn v·ªõi ƒëi·ªÉm
                // G·ªçi PUT ƒë·ªÉ c·∫≠p nh·∫≠t l·∫°i t·ªïng ti·ªÅn sau khi ƒë√£ c√≥ chi ti·∫øt
                if (pointsUsed > 0 || appliedDiscount) {
                    await fetch(`${API_BASE}/hoadon/${idHD}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            idNV: selectedNV.id,
                            idKH: selectedCustomer ? (selectedCustomer.id || null) : null,
                            idKM: appliedDiscount ? (appliedDiscount.id || null) : null,
                            diemDaDung: pointsUsed
                        })
                    });
                }

                // C·ªông ƒëi·ªÉm m·ªõi cho kh√°ch h√†ng (ƒëi·ªÉm ƒë√£ ƒë∆∞·ª£c tr·ª´ khi t·∫°o h√≥a ƒë∆°n)
                if (selectedCustomer && selectedCustomer.id && pointsEarned > 0) {
                    // L·∫•y ƒëi·ªÉm hi·ªán t·∫°i (ƒë√£ b·ªã tr·ª´)
                    const currentCustomerRes = await fetch(`${API_BASE}/khachhang/${selectedCustomer.id}`);
                    const currentCustomerData = await currentCustomerRes.json();
                    const currentPoints = currentCustomerData.success ? (currentCustomerData.data.diemtichluy || 0) : 0;
                    
                    // C·ªông ƒëi·ªÉm m·ªõi
                    const newPoints = currentPoints + pointsEarned;
                    await fetch(`${API_BASE}/khachhang/${selectedCustomer.id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            tenKH: selectedCustomer.tenKH,
                            idPLKH: selectedCustomer.idPLKH,
                            diemtichluy: newPoints,
                            sdt: selectedCustomer.sdt,
                            diachi: selectedCustomer.diachi
                        })
                    });
                }

                // Success
                lastInvoiceId = maHD;

                // T√≠nh to√°n l·∫°i ƒë·ªÉ hi·ªÉn th·ªã ƒë·∫ßy ƒë·ªß
                const subtotalDisplay = subtotal;
                const discountCodeDisplay = discountAmount;
                const discountPointsDisplay = pointsValue;
                const finalTotalDisplay = total;

                document.getElementById('success-message').innerHTML = `
                    <strong>M√£ h√≥a ƒë∆°n: ${maHD}</strong><br>
                    Ng√†y l·∫≠p: ${formatDate(invoiceResult.data.ngayLap)}<br>
                    Nh√¢n vi√™n: ${selectedNV.tenNV || selectedNVValue}<br>
                    ${selectedCustomer ? `Kh√°ch h√†ng: ${selectedCustomer.tenKH}<br>` : ''}
                    <hr style="margin: 10px 0; border: none; border-top: 1px solid #ddd;">
                    <div style="text-align: left; font-size: 12px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span>T·ªïng ti·ªÅn:</span>
                            <strong>${formatCurrency(subtotalDisplay)}</strong>
                        </div>
                        ${discountCodeDisplay > 0 ? `
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px; color: #dc2626;">
                            <span>Gi·∫£m gi√° (M√£):</span>
                            <strong>-${formatCurrency(discountCodeDisplay)}</strong>
                        </div>
                        ` : ''}
                        ${discountPointsDisplay > 0 ? `
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px; color: #059669;">
                            <span>Gi·∫£m gi√° (ƒêi·ªÉm):</span>
                            <strong>-${formatCurrency(discountPointsDisplay)}</strong>
                        </div>
                        ` : ''}
                        <div style="display: flex; justify-content: space-between; margin-top: 8px; padding-top: 8px; border-top: 2px solid #1a1a2e; font-size: 14px;">
                            <strong>Th√†nh ti·ªÅn:</strong>
                            <strong style="color: #00b894; font-size: 16px;">${formatCurrency(finalTotalDisplay)}</strong>
                        </div>
                        ${selectedCustomer ? `<div style="margin-top: 10px; color: #666; font-size: 11px;">ƒêi·ªÉm t√≠ch l≈©y: +${pointsEarned} ƒëi·ªÉm (100.000ƒë = 1 ƒëi·ªÉm, t·ªëi thi·ªÉu 1 ƒëi·ªÉm)</div>` : ''}
                    </div>
                `;
                
                // Hi·ªÉn th·ªã popup th√†nh c√¥ng
                const successModal = document.getElementById('success-modal');
                if (successModal) {
                    successModal.classList.add('active');
                    successModal.style.display = 'flex';
                    successModal.style.zIndex = '10000';
                    console.log('Success modal should be visible now');
                } else {
                    console.error('Success modal not found!');
                }

                // Reset
                cart = [];
                selectedCustomer = null;
                appliedDiscount = null;

                // Reload data
                await loadInitialData();
                renderCart();

            } catch (error) {
                showToast('L·ªói: ' + error.message, 'error');
            }
        }

        function closeSuccessModal() {
            const successModal = document.getElementById('success-modal');
            if (successModal) {
                successModal.classList.remove('active');
                successModal.style.display = 'none';
                successModal.style.zIndex = '';
            }
        }

        async function printInvoice() {
            if (!lastInvoiceId) return;

            try {
                // T√¨m h√≥a ƒë∆°n ƒë·ªÉ l·∫•y id
                const order = ordersList.find(o => o.maHD === lastInvoiceId);
                if (!order) {
                    // N·∫øu kh√¥ng t√¨m th·∫•y trong ordersList, th·ª≠ t√¨m trong API
                    const ordersRes = await fetch(`${API_BASE}/hoadon`);
                    const ordersData = await ordersRes.json();
                    if (ordersData.success) {
                        const foundOrder = ordersData.data.find(o => o.maHD === lastInvoiceId);
                        if (foundOrder && foundOrder.id) {
                            const response = await fetch(`${API_BASE}/hoadon/${foundOrder.id}/pdf`);
                            if (!response.ok) {
                                showToast('L·ªói xu·∫•t h√≥a ƒë∆°n', 'error');
                                return;
                            }
                            const blob = await response.blob();
                            const url = window.URL.createObjectURL(blob);
                            const printWindow = window.open(url, '_blank');
                            if (!printWindow) {
                                const a = document.createElement('a');
                                a.href = url;
                                a.download = `HoaDon_${lastInvoiceId}.pdf`;
                                document.body.appendChild(a);
                                a.click();
                                window.URL.revokeObjectURL(url);
                                document.body.removeChild(a);
                                showToast('ƒê√£ t·∫£i h√≥a ƒë∆°n. Vui l√≤ng m·ªü file ƒë·ªÉ in.', 'info');
                            } else {
                                printWindow.onload = function() {
                                    setTimeout(() => {
                                        printWindow.print();
                                    }, 500);
                                };
                                showToast('ƒêang m·ªü h√≥a ƒë∆°n ƒë·ªÉ in...', 'success');
                            }
                            closeSuccessModal();
                            return;
                        }
                    }
                    showToast('Kh√¥ng t√¨m th·∫•y h√≥a ƒë∆°n', 'error');
                    return;
                }
                
                const idHD = order.id;
                const response = await fetch(`${API_BASE}/hoadon/${idHD}/pdf`);
                if (!response.ok) {
                    showToast('L·ªói xu·∫•t h√≥a ƒë∆°n', 'error');
                    return;
                }

                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                
                // M·ªü PDF trong tab m·ªõi ƒë·ªÉ c√≥ th·ªÉ in tr·ª±c ti·∫øp
                const printWindow = window.open(url, '_blank');
                
                // N·∫øu kh√¥ng m·ªü ƒë∆∞·ª£c (b·ªã ch·∫∑n popup), t·∫£i xu·ªëng
                if (!printWindow) {
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `HoaDon_${lastInvoiceId}.pdf`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    showToast('ƒê√£ t·∫£i h√≥a ƒë∆°n. Vui l√≤ng m·ªü file ƒë·ªÉ in.', 'info');
                } else {
                    // ƒê·ª£i PDF load xong r·ªìi t·ª± ƒë·ªông m·ªü dialog in
                    printWindow.onload = function() {
                        setTimeout(() => {
                            printWindow.print();
                        }, 500);
                    };
                    showToast('ƒêang m·ªü h√≥a ƒë∆°n ƒë·ªÉ in...', 'success');
                }

                closeSuccessModal();
            } catch (error) {
                showToast('L·ªói: ' + error.message, 'error');
            }
        }

        // ==================== ORDERS ====================
        let ordersList = [];

        async function renderOrders() {
            const content = document.getElementById('page-content');
            content.innerHTML = `
                <div class="page-header">
                    <div>
                        <h2>Danh S√°ch H√≥a ƒê∆°n</h2>
                        <p>Xem v√† qu·∫£n l√Ω c√°c h√≥a ƒë∆°n ƒë√£ t·∫°o</p>
                    </div>
                </div>
                <div class="search-box" style="display: flex; flex-wrap: wrap; gap: 10px; align-items: flex-end;">
                    <div style="flex: 2; min-width: 400px;">
                        <input type="text" class="search-input" id="search-order" placeholder="T√¨m theo m√£ h√≥a ƒë∆°n, kh√°ch h√†ng, nh√¢n vi√™n..." oninput="filterOrders()" style="width: 100%;">
                    </div>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                        <select id="filter-time-type" onchange="onTimeFilterChange()" style="padding: 10px 15px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; background: white; cursor: pointer; min-width: 180px;">
                            <option value="all">üìÖ T·∫•t c·∫£ th·ªùi gian</option>
                            <option value="day">üìÜ Ng√†y</option>
                            <option value="month">üìÜ Th√°ng</option>
                            <option value="year">üìÖ NƒÉm</option>
                        </select>
                        <div id="date-input" style="display: none; position: relative;">
                            <label style="position: absolute; top: -20px; left: 0; font-size: 12px; color: #666; font-weight: 500;">Ch·ªçn ng√†y:</label>
                            <input type="date" id="filter-date" onchange="filterOrders()" style="padding: 10px 15px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                        </div>
                        <div id="month-input" style="display: none; position: relative;">
                            <label style="position: absolute; top: -20px; left: 0; font-size: 12px; color: #666; font-weight: 500;">Ch·ªçn th√°ng:</label>
                            <input type="month" id="filter-month" onchange="filterOrders()" style="padding: 10px 15px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                        </div>
                        <div id="year-input" style="display: none; position: relative;">
                            <label style="position: absolute; top: -20px; left: 0; font-size: 12px; color: #666; font-weight: 500;">Ch·ªçn nƒÉm:</label>
                            <select id="filter-year" onchange="filterOrders()" style="padding: 10px 15px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; background: white; cursor: pointer; min-width: 140px;">
                                ${Array.from({length: 10}, (_, i) => {
                                    const year = new Date().getFullYear() - i;
                                    return `<option value="${year}" ${i === 0 ? 'selected' : ''}>NƒÉm ${year}</option>`;
                                }).join('')}
                            </select>
                        </div>
                        <button class="btn btn-primary" onclick="filterOrders()">üîç T√¨m ki·∫øm</button>
                        <button class="btn btn-secondary" onclick="resetOrderFilters()">üîÑ T·∫£i l·∫°i</button>
                    </div>
                </div>
                <div id="orders-container" class="table-container">
                    <div class="loading"><div class="spinner"></div><p>ƒêang t·∫£i...</p></div>
                </div>
            `;

            await loadOrders();
        }

        async function loadOrders() {
            try {
                const keyword = document.getElementById('search-order')?.value || '';
                let url = `${API_BASE}/hoadon`;
                
                // S·ª≠ d·ª•ng API search n·∫øu c√≥ keyword
                if (keyword.trim()) {
                    url = `${API_BASE}/hoadon/search?keyword=${encodeURIComponent(keyword)}`;
                }
                
                const response = await fetch(url);
                const result = await response.json();

                if (result.success) {
                    ordersList = result.data;
                    
                    // T√≠nh to√°n gi·∫£m gi√° t·ª´ m√£ v√† ƒëi·ªÉm t√≠ch l≈©y cho m·ªói h√≥a ƒë∆°n
                    // API ƒë√£ tr·∫£ v·ªÅ subtotal, phantramGiam, n√™n kh√¥ng c·∫ßn fetch chi ti·∫øt n·ªØa
                    for (let order of ordersList) {
                        try {
                            // L·∫•y subtotal t·ª´ API (ƒë√£ ƒë∆∞·ª£c t√≠nh s·∫µn)
                            const subtotal = parseFloat(order.subtotal) || parseFloat(order.tongTien) || 0;
                            
                            // T√≠nh gi·∫£m gi√° t·ª´ m√£ khuy·∫øn m√£i (n·∫øu c√≥)
                            let phantramGiam = 0;
                            if (order.idKM && order.phantramGiam) {
                                phantramGiam = parseFloat(order.phantramGiam) || 0;
                            }
                            const tienGiamGiaCode = phantramGiam > 0 ? (subtotal * phantramGiam / 100) : 0;
                            
                            // T·ªïng ti·ªÅn cu·ªëi c√πng (sau khi gi·∫£m m√£ khuy·∫øn m√£i)
                            const finalTotal = parseFloat(order.tongTien) || 0;
                            
                            // Gi·∫£m gi√° t·ª´ ƒëi·ªÉm t√≠ch l≈©y = subtotal - tienGiamGiaCode - finalTotal
                            // N·∫øu finalTotal ƒë√£ bao g·ªìm c·∫£ gi·∫£m ƒëi·ªÉm, th√¨ pointsDiscount s·∫Ω > 0
                            const pointsDiscount = Math.max(0, subtotal - tienGiamGiaCode - finalTotal);
                            
                            // L∆∞u v√†o order object ƒë·ªÉ hi·ªÉn th·ªã
                            order.subtotal = subtotal;
                            order.tienGiamGiaCode = tienGiamGiaCode;
                            order.pointsDiscount = pointsDiscount;
                            order.phantramGiam = phantramGiam;
                            
                            // L∆∞u th√¥ng tin m√£ gi·∫£m gi√° ƒë·ªÉ hi·ªÉn th·ªã
                            if (order.idKM && order.maKM) {
                                order.maGiamGia = order.maKM;
                            }
                            
                            console.log(`Order ${order.maHD}: subtotal=${subtotal}, tienGiamGiaCode=${tienGiamGiaCode}, pointsDiscount=${pointsDiscount}, finalTotal=${finalTotal}`);
                        } catch (err) {
                            console.error(`Error calculating discount for order ${order.maHD}:`, err);
                            order.pointsDiscount = 0;
                            order.subtotal = parseFloat(order.tongTien) || 0;
                            order.tienGiamGiaCode = 0;
                        }
                    }
                    
                    // Apply filters after loading
                    filterOrders();
                }
            } catch (error) {
                showToast('L·ªói t·∫£i d·ªØ li·ªáu', 'error');
            }
        }

        function renderOrdersTable(data) {
            const container = document.getElementById('orders-container');

            if (!data.length) {
                container.innerHTML = '<div class="empty-state">Ch∆∞a c√≥ h√≥a ƒë∆°n</div>';
                return;
            }

            container.innerHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>M√£ Hƒê</th>
                            <th>Ng√†y L·∫≠p</th>
                            <th>Kh√°ch H√†ng</th>
                            <th>Nh√¢n Vi√™n</th>
                            <th>T·ªïng Ti·ªÅn</th>
                            <th>Gi·∫£m Gi√° (M√£)</th>
                            <th>Gi·∫£m Gi√° (ƒêi·ªÉm)</th>
                            <th>Th√†nh Ti·ªÅn</th>
                            <th>Thao T√°c</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${data.map(o => {
                            const nv = nhanvienList.find(n => n.maNV === o.maNV);
                            const kh = customers.find(c => c.maKH === o.maKH);
                            const pointsDiscount = o.pointsDiscount || 0;
                            let tienGiamGiaCode = o.tienGiamGiaCode || 0;
                            // N·∫øu ch∆∞a c√≥ tienGiamGiaCode, t√≠nh t·ª´ subtotal v√† phantramGiam
                            if (!tienGiamGiaCode && o.idKM && o.phantramGiam && o.subtotal) {
                                tienGiamGiaCode = o.subtotal * (o.phantramGiam / 100);
                            }
                            const finalTotal = parseFloat(o.tongTien) || 0;
                            return `
                                <tr style="cursor: pointer;" onclick="viewInvoiceDetail('${o.maHD}')">
                                    <td><strong>${o.maHD}</strong></td>
                                    <td>${formatDate(o.ngayLap)}</td>
                                    <td>${kh ? kh.tenKH : (o.tenKhachHang || o.maKH || 'Kh√°ch l·∫ª')}</td>
                                    <td>${nv ? nv.tenNV : (o.tenNhanVien || o.maNV)}</td>
                                    <td>${o.subtotal ? formatCurrency(o.subtotal) : formatCurrency(finalTotal)}</td>
                                    <td>${tienGiamGiaCode > 0 ? `<span class="value-danger">-${formatCurrency(tienGiamGiaCode)}</span>` : '-'}</td>
                                    <td>${pointsDiscount > 0 ? `<span class="value-success">-${formatCurrency(pointsDiscount)}</span>` : '-'}</td>
                                    <td><strong class="value-success">${formatCurrency(finalTotal)}</strong></td>
                                    <td onclick="event.stopPropagation();"> 
                                        <button class="btn btn-sm btn-primary" onclick="event.stopPropagation(); event.preventDefault(); viewInvoiceDetail('${o.maHD}'); return false;" title="Xem chi ti·∫øt" style="margin-right: 5px; z-index: 10; position: relative;">üìÑ Xem</button>
                                        <button class="btn btn-sm btn-secondary" onclick="event.stopPropagation(); exportPDF('${o.maHD}')" title="Xu·∫•t PDF" style="margin-right: 5px;">üìÑ Pdf</button>
                                        <button class="btn btn-sm btn-warning" onclick="event.stopPropagation(); openTraHangModal('${o.maHD}')" title="Tr·∫£ h√†ng" style="margin-right: 5px;">‚Ü©Ô∏è Tr·∫£</button>
                                        <button class="btn btn-sm btn-primary" onclick="event.stopPropagation(); openDoiHangModal('${o.maHD}')" title="ƒê·ªïi h√†ng">üîÑ ƒê·ªïi</button>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
        }

        function onTimeFilterChange() {
            const filterType = document.getElementById('filter-time-type').value;
            const dateInput = document.getElementById('date-input');
            const monthInput = document.getElementById('month-input');
            const yearInput = document.getElementById('year-input');
            
            // ·∫®n t·∫•t c·∫£ input tr∆∞·ªõc
            if (dateInput) dateInput.style.display = 'none';
            if (monthInput) monthInput.style.display = 'none';
            if (yearInput) yearInput.style.display = 'none';
            
            // Hi·ªÉn th·ªã input t∆∞∆°ng ·ª©ng
            if (filterType === 'day') {
                if (dateInput) dateInput.style.display = 'block';
            } else if (filterType === 'month') {
                if (monthInput) monthInput.style.display = 'block';
            } else if (filterType === 'year') {
                if (yearInput) yearInput.style.display = 'block';
            }
            
            filterOrders();
        }

        function resetOrderFilters() {
            document.getElementById('search-order').value = '';
            document.getElementById('filter-time-type').value = 'all';
            const dateInput = document.getElementById('date-input');
            const monthInput = document.getElementById('month-input');
            const yearInput = document.getElementById('year-input');
            if (dateInput) {
                dateInput.style.display = 'none';
                document.getElementById('filter-date').value = '';
            }
            if (monthInput) {
                monthInput.style.display = 'none';
                document.getElementById('filter-month').value = '';
            }
            if (yearInput) {
                yearInput.style.display = 'none';
                document.getElementById('filter-year').value = new Date().getFullYear();
            }
            filterOrders();
        }

        function filterOrders() {
            const keyword = document.getElementById('search-order').value.toLowerCase();
            const filterType = document.getElementById('filter-time-type').value;
            const filterDate = document.getElementById('filter-date')?.value || '';
            const filterMonth = document.getElementById('filter-month')?.value || '';
            const filterYear = document.getElementById('filter-year')?.value || '';
            
            // Helper function ƒë·ªÉ parse ng√†y t·ª´ ISO string (gi·ªØ nguy√™n UTC, kh√¥ng convert timezone)
            function parseOrderDate(dateStr) {
                if (!dateStr) return null;
                const dateStrClean = String(dateStr).trim();
                
                // X·ª≠ l√Ω ISO format v·ªõi Z (UTC): "2026-01-06T22:27:56.970Z"
                if (dateStrClean.includes('T') && dateStrClean.endsWith('Z')) {
                    const isoMatch = dateStrClean.match(/^(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2}):(\d{2})(?:\.(\d+))?Z$/);
                    if (isoMatch) {
                        const [, year, month, day] = isoMatch.map(Number);
                        // Tr·∫£ v·ªÅ Date object v·ªõi UTC time, nh∆∞ng ch·ªâ d√πng ƒë·ªÉ so s√°nh ng√†y/th√°ng/nƒÉm
                        return { year, month, day };
                    }
                }
                
                // Fallback: parse nh∆∞ b√¨nh th∆∞·ªùng
                const date = new Date(dateStrClean);
                return {
                    year: date.getFullYear(),
                    month: date.getMonth() + 1,
                    day: date.getDate()
                };
            }
            
            let filtered = ordersList.filter(o => {
                // Filter by keyword
                const nv = nhanvienList.find(n => n.maNV === o.maNV);
                const kh = customers.find(c => c.maKH === o.maKH);
                const matchesKeyword = !keyword || 
                    o.maHD.toLowerCase().includes(keyword) ||
                    (o.maKH && o.maKH.toLowerCase().includes(keyword)) ||
                    (kh && kh.tenKH.toLowerCase().includes(keyword)) ||
                    (nv && nv.tenNV.toLowerCase().includes(keyword)) ||
                    o.maNV.toLowerCase().includes(keyword);
                
                if (!matchesKeyword) return false;
                
                // Filter by time
                if (filterType === 'all') {
                    return true;
                }
                
                const orderDate = parseOrderDate(o.ngayLap);
                if (!orderDate) return true;
                
                switch (filterType) {
                    case 'day':
                        if (!filterDate) return true;
                        // filterDate format: "YYYY-MM-DD"
                        const [filterYearDay, filterMonthDay, filterDay] = filterDate.split('-').map(Number);
                        return orderDate.year === filterYearDay && 
                               orderDate.month === filterMonthDay && 
                               orderDate.day === filterDay;
                    
                    case 'month':
                        if (!filterMonth) return true;
                        // filterMonth format: "YYYY-MM"
                        const [filterYearMonth, filterMonthMonth] = filterMonth.split('-').map(Number);
                        return orderDate.year === filterYearMonth && 
                               orderDate.month === filterMonthMonth;
                    
                    case 'year':
                        if (!filterYear) return true;
                        const filterYearValue = parseInt(filterYear);
                        return orderDate.year === filterYearValue;
                    
                    default:
                        return true;
                }
            });
            
            renderOrdersTable(filtered);
        }

        let currentViewingInvoiceId = null;
        let currentViewingInvoiceMaHD = null;

        async function viewInvoiceDetail(maHD) {
            try {
                console.log('=== viewInvoiceDetail START ===');
                console.log('maHD:', maHD);
                console.log('ordersList length:', ordersList.length);
                
                // T√¨m h√≥a ƒë∆°n trong ordersList
                let order = ordersList.find(o => o.maHD === maHD);
                console.log('Found order in list:', order);
                
                // N·∫øu kh√¥ng t√¨m th·∫•y trong ordersList, th·ª≠ load l·∫°i t·ª´ API
                if (!order || !order.id) {
                    console.log('Order not found, fetching from API...');
                    showToast('ƒêang t·∫£i th√¥ng tin h√≥a ƒë∆°n...', 'info');
                    const ordersRes = await fetch(`${API_BASE}/hoadon`);
                    const ordersData = await ordersRes.json();
                    if (ordersData.success) {
                        order = ordersData.data.find(o => o.maHD === maHD);
                        console.log('Found order from API:', order);
                    }
                }
                
                if (!order || !order.id) {
                    console.error('Order not found!');
                    alert('Kh√¥ng t√¨m th·∫•y h√≥a ƒë∆°n v·ªõi m√£: ' + maHD);
                    showToast('Kh√¥ng t√¨m th·∫•y h√≥a ƒë∆°n v·ªõi m√£: ' + maHD, 'error');
                    return;
                }
                
                console.log('Using order:', order);
                currentViewingInvoiceId = order.id;
                currentViewingInvoiceMaHD = maHD;
                
                await loadInvoiceDetail(order.id);
                console.log('=== viewInvoiceDetail END ===');
            } catch (error) {
                console.error('Error in viewInvoiceDetail:', error);
                alert('L·ªói: ' + error.message);
                showToast('L·ªói: ' + error.message, 'error');
            }
        }
        
        async function loadInvoiceDetail(idHD) {
            try {
                console.log('Loading invoice detail for idHD:', idHD);
                const response = await fetch(`${API_BASE}/hoadon/${idHD}/export?format=json`);
                const result = await response.json();
                
                console.log('API response:', result);
                
                if (!result.success) {
                    showToast('L·ªói t·∫£i chi ti·∫øt h√≥a ƒë∆°n: ' + (result.message || 'Unknown error'), 'error');
                    return;
                }
                
                const invoice = result.data.thongTinHoaDon;
                const details = result.data.chiTietHangHoa;
                
                console.log('Invoice data:', invoice);
                console.log('Details:', details);
                
                const body = document.getElementById('invoice-detail-body');
                if (!body) {
                    console.error('invoice-detail-body element not found!');
                    showToast('L·ªói: Kh√¥ng t√¨m th·∫•y ph·∫ßn t·ª≠ hi·ªÉn th·ªã', 'error');
                    return;
                }
                
                body.innerHTML = `
                    <div style="padding: 0;">
                        <!-- Header Info Card -->
                        <div style="background: linear-gradient(135deg, #fdf4d7 0%, #d4e7e6 35%, #f1bdb5 70%, #d8d3e9 100%); padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                <div style="background: white; padding: 15px; border-radius: 8px;">
                                    <h4 style="margin: 0 0 12px 0; color: #1a2b48; font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px;">Th√¥ng Tin H√≥a ƒê∆°n</h4>
                                    <div style="display: flex; align-items: center; margin-bottom: 8px;">
                                        <span style="font-weight: 600; color: #4a5568; min-width: 100px;">M√£ Hƒê:</span>
                                        <span style="color: #1a2b48; font-size: 16px; font-weight: 700;">${invoice.maHD}</span>
                                    </div>
                                    <div style="display: flex; align-items: center; margin-bottom: 8px;">
                                        <span style="font-weight: 600; color: #4a5568; min-width: 100px;">Ng√†y l·∫≠p:</span>
                                        <span style="color: #1a2b48;">${formatDate(invoice.ngaylap)}</span>
                                    </div>
                                    <div style="display: flex; align-items: center;">
                                        <span style="font-weight: 600; color: #4a5568; min-width: 100px;">Nh√¢n vi√™n:</span>
                                        <span style="color: #1a2b48;">${invoice.nhanVien.tenNV} <span style="color: #666; font-size: 12px;">(${invoice.nhanVien.maNV})</span></span>
                                    </div>
                                </div>
                                <div style="background: white; padding: 15px; border-radius: 8px;">
                                    <h4 style="margin: 0 0 12px 0; color: #1a2b48; font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px;">Th√¥ng Tin Kh√°ch H√†ng</h4>
                                    ${invoice.khachHang ? `
                                        <div style="display: flex; align-items: center; margin-bottom: 8px;">
                                            <span style="font-weight: 600; color: #4a5568; min-width: 100px;">T√™n KH:</span>
                                            <span style="color: #1a2b48;">${invoice.khachHang.tenKH}</span>
                                        </div>
                                        <div style="display: flex; align-items: center; margin-bottom: 8px;">
                                            <span style="font-weight: 600; color: #4a5568; min-width: 100px;">M√£ KH:</span>
                                            <span style="color: #1a2b48; font-weight: 600;">${invoice.khachHang.maKH}</span>
                                        </div>
                                        <div style="display: flex; align-items: center;">
                                            <span style="font-weight: 600; color: #4a5568; min-width: 100px;">SƒêT:</span>
                                            <span style="color: #1a2b48;">${invoice.khachHang.sdt || '-'}</span>
                                        </div>
                                    ` : '<p style="color: #666; margin: 0;">Kh√°ch l·∫ª</p>'}
                                    ${invoice.maGiamGia ? `
                                        <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #e0e0e0;">
                                            <div style="display: flex; align-items: center;">
                                                <span style="font-weight: 600; color: #4a5568; min-width: 100px;">M√£ KM:</span>
                                                <span style="color: #00b894; font-weight: 600;">${invoice.maGiamGia.maKM} <span style="color: #666; font-size: 12px;">(-${invoice.maGiamGia.phantramgiam}%)</span></span>
                                            </div>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                        
                        <!-- Products Table -->
                        <div style="background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 20px;">
                            <div style="background: linear-gradient(135deg, #d4e7e6 0%, #4a90e2 100%); padding: 15px 20px;">
                                <h4 style="margin: 0; color: #1a2b48; font-size: 16px; font-weight: 700;">üì¶ Chi Ti·∫øt S·∫£n Ph·∫©m</h4>
                            </div>
                            <div style="overflow-x: auto;">
                                <table style="width: 100%; border-collapse: collapse;">
                                    <thead>
                                        <tr style="background: #f8f9fa;">
                                            <th style="padding: 12px; text-align: center; border-bottom: 2px solid #e0e0e0; font-weight: 600; color: #1a2b48; font-size: 12px; text-transform: uppercase;">STT</th>
                                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e0e0e0; font-weight: 600; color: #1a2b48; font-size: 12px; text-transform: uppercase;">M√£ H√†ng</th>
                                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e0e0e0; font-weight: 600; color: #1a2b48; font-size: 12px; text-transform: uppercase;">T√™n H√†ng</th>
                                            <th style="padding: 12px; text-align: center; border-bottom: 2px solid #e0e0e0; font-weight: 600; color: #1a2b48; font-size: 12px; text-transform: uppercase;">S·ªë L∆∞·ª£ng</th>
                                            <th style="padding: 12px; text-align: right; border-bottom: 2px solid #e0e0e0; font-weight: 600; color: #1a2b48; font-size: 12px; text-transform: uppercase;">ƒê∆°n Gi√°</th>
                                            <th style="padding: 12px; text-align: right; border-bottom: 2px solid #e0e0e0; font-weight: 600; color: #1a2b48; font-size: 12px; text-transform: uppercase;">Th√†nh Ti·ªÅn</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${details.map((item, index) => `
                                            <tr style="border-bottom: 1px solid #f0f0f0; transition: background 0.2s;" onmouseover="this.style.background='#f8f9fa'" onmouseout="this.style.background='white'">
                                                <td style="padding: 12px; text-align: center; color: #666;">${item.stt}</td>
                                                <td style="padding: 12px; color: #1a2b48; font-weight: 600;">${item.maHang}</td>
                                                <td style="padding: 12px; color: #1a2b48;">${item.tenHang}</td>
                                                <td style="padding: 12px; text-align: center; color: #1a2b48;">
                                                    <span style="background: #e6f7ff; padding: 4px 10px; border-radius: 12px; font-weight: 600; font-size: 13px;">${item.soluong}</span>
                                                </td>
                                                <td style="padding: 12px; text-align: right; color: #1a2b48;">${formatCurrency(item.dongia)}</td>
                                                <td style="padding: 12px; text-align: right; color: #00b894; font-weight: 700; font-size: 14px;">${formatCurrency(item.tongtien)}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- Summary Card -->
                        <div style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
                            <h4 style="margin: 0 0 15px 0; color: #1a2b48; font-size: 16px; font-weight: 700;">üí∞ T·ªïng K·∫øt Thanh To√°n</h4>
                            <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 10px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                    <span style="color: #666; font-size: 14px;">T·ªïng ti·ªÅn h√†ng:</span>
                                    <span style="color: #1a2b48; font-weight: 600; font-size: 15px;">${formatCurrency(invoice.tongTien)}</span>
                                </div>
                                ${invoice.tienGiamGiaCode > 0 ? `
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; padding: 8px; background: #fff3e0; border-radius: 6px;">
                                        <span style="color: #dc2626; font-size: 14px; font-weight: 600;">üí≥ Gi·∫£m gi√° (M√£):</span>
                                        <span style="color: #dc2626; font-weight: 700; font-size: 15px;">-${formatCurrency(invoice.tienGiamGiaCode)}</span>
                                    </div>
                                ` : ''}
                                ${invoice.tienGiamGiaDiem > 0 ? `
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; padding: 8px; background: #e6fff5; border-radius: 6px;">
                                        <span style="color: #059669; font-size: 14px; font-weight: 600;">‚≠ê Gi·∫£m gi√° (ƒêi·ªÉm):</span>
                                        <span style="color: #059669; font-weight: 700; font-size: 15px;">-${formatCurrency(invoice.tienGiamGiaDiem)}</span>
                                    </div>
                                ` : ''}
                            </div>
                            <div style="background: linear-gradient(135deg, #00b894 0%, #00cec9 100%); padding: 18px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 15px rgba(0, 184, 148, 0.3);">
                                <span style="color: white; font-size: 18px; font-weight: 700;">Th√†nh ti·ªÅn:</span>
                                <span style="color: white; font-size: 24px; font-weight: 900;">${formatCurrency(invoice.thanhTien)}</span>
                            </div>
                        </div>
                    </div>
                `;
                
                // Hi·ªÉn th·ªã c√°c n√∫t action
                const printBtn = document.getElementById('print-invoice-btn');
                const exportBtn = document.getElementById('export-pdf-btn');
                if (printBtn) printBtn.style.display = 'inline-flex';
                if (exportBtn) exportBtn.style.display = 'inline-flex';
                
                // Hi·ªÉn th·ªã section thay v√¨ modal
                const section = document.getElementById('invoice-detail-section');
                if (!section) {
                    showToast('Kh√¥ng t√¨m th·∫•y section hi·ªÉn th·ªã', 'error');
                    return;
                }
                section.style.display = 'block';
                section.scrollTop = 0;
            } catch (error) {
                console.error('Error in loadInvoiceDetail:', error);
                showToast('L·ªói: ' + error.message, 'error');
            }
        }
        
        async function printInvoiceFromDetail() {
            if (!currentViewingInvoiceId || !currentViewingInvoiceMaHD) return;
            await printInvoiceFromId(currentViewingInvoiceId, currentViewingInvoiceMaHD);
        }
        
        async function exportPDFFromDetail() {
            if (!currentViewingInvoiceId || !currentViewingInvoiceMaHD) return;
            await exportPDF(currentViewingInvoiceMaHD);
        }
        
        async function printInvoiceFromId(idHD, maHD) {
            try {
                const response = await fetch(`${API_BASE}/hoadon/${idHD}/pdf`);
                if (!response.ok) {
                    showToast('L·ªói xu·∫•t h√≥a ƒë∆°n', 'error');
                    return;
                }

                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const printWindow = window.open(url, '_blank');
                
                if (!printWindow) {
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `HoaDon_${maHD}.pdf`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    showToast('ƒê√£ t·∫£i h√≥a ƒë∆°n. Vui l√≤ng m·ªü file ƒë·ªÉ in.', 'info');
                } else {
                    printWindow.onload = function() {
                        setTimeout(() => {
                            printWindow.print();
                        }, 500);
                    };
                    showToast('ƒêang m·ªü h√≥a ƒë∆°n ƒë·ªÉ in...', 'success');
                }
            } catch (error) {
                showToast('L·ªói: ' + error.message, 'error');
            }
        }

        // Helper function ƒë·ªÉ hi·ªÉn th·ªã modal m·ªôt c√°ch ch·∫Øc ch·∫Øn
        function showModal(modalId) {
            const modal = document.getElementById(modalId);
            if (!modal) {
                console.error(`Modal ${modalId} not found!`);
                return false;
            }
            
            // X√≥a t·∫•t c·∫£ inline styles c≈©
            modal.removeAttribute('style');
            
            // Set inline styles tr·ª±c ti·∫øp
            modal.style.cssText = `
                display: flex !important;
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                width: 100% !important;
                height: 100% !important;
                background: rgba(0, 0, 0, 0.6) !important;
                z-index: 99999 !important;
                justify-content: center !important;
                align-items: center !important;
                backdrop-filter: blur(5px) !important;
            `;
            
            // Th√™m class
            modal.classList.add('active', 'show');
            
            console.log(`Modal ${modalId} displayed`);
            return true;
        }
        
        // Helper function ƒë·ªÉ ·∫©n modal
        function hideModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'none';
                modal.classList.remove('active', 'show');
                console.log(`Modal ${modalId} hidden`);
            }
        }
        
        function closeInvoiceDetailModal() {
            closeInvoiceDetailSection();
        }
        
        function closeInvoiceDetailSection() {
            const section = document.getElementById('invoice-detail-section');
            if (section) {
                section.style.display = 'none';
            }
        }
        
        // ƒê·∫£m b·∫£o section c√≥ th·ªÉ ƒë√≥ng khi click b√™n ngo√†i
        window.addEventListener('load', function() {
            // Invoice detail section
            const invoiceSection = document.getElementById('invoice-detail-section');
            if (invoiceSection) {
                invoiceSection.addEventListener('click', function(e) {
                    if (e.target === invoiceSection) {
                        closeInvoiceDetailSection();
                    }
                });
            }
            
            // Return product section
            const returnSection = document.getElementById('return-product-section');
            if (returnSection) {
                returnSection.addEventListener('click', function(e) {
                    if (e.target === returnSection) {
                        closeReturnProductSection();
                    }
                });
            }
            
            // Exchange product section
            const exchangeSection = document.getElementById('exchange-product-section');
            if (exchangeSection) {
                exchangeSection.addEventListener('click', function(e) {
                    if (e.target === exchangeSection) {
                        closeExchangeProductSection();
                    }
                });
            }
        });

        async function exportPDF(maHD) {
            try {
                // T√¨m h√≥a ƒë∆°n ƒë·ªÉ l·∫•y id
                const order = ordersList.find(o => o.maHD === maHD);
                if (!order || !order.id) {
                    showToast('Kh√¥ng t√¨m th·∫•y h√≥a ƒë∆°n', 'error');
                    return;
                }
                const idHD = order.id;
                const response = await fetch(`${API_BASE}/hoadon/${idHD}/pdf`);
                if (!response.ok) {
                    showToast('L·ªói xu·∫•t PDF', 'error');
                    return;
                }

                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `HoaDon_${maHD}.pdf`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);

                showToast('Xu·∫•t PDF th√†nh c√¥ng', 'success');
            } catch (error) {
                showToast('L·ªói: ' + error.message, 'error');
            }
        }

        async function exportExcel(maHD) {
            try {
                // T√¨m h√≥a ƒë∆°n ƒë·ªÉ l·∫•y id
                const order = ordersList.find(o => o.maHD === maHD);
                if (!order || !order.id) {
                    showToast('Kh√¥ng t√¨m th·∫•y h√≥a ƒë∆°n', 'error');
                    return;
                }
                const idHD = order.id;
                const response = await fetch(`${API_BASE}/hoadon/${idHD}/export?format=excel`);
                if (!response.ok) {
                    showToast('L·ªói xu·∫•t Excel', 'error');
                    return;
                }

                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `HoaDon_${maHD}.xlsx`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);

                showToast('Xu·∫•t Excel th√†nh c√¥ng', 'success');
            } catch (error) {
                showToast('L·ªói: ' + error.message, 'error');
            }
        }

        // ==================== CUSTOMERS ====================
        async function renderCustomers() {
            const content = document.getElementById('page-content');
            content.innerHTML = `
                <div class="page-header">
                    <div>
                        <h2>Danh S√°ch Kh√°ch H√†ng</h2>
                        <p>Xem th√¥ng tin v√† ƒëi·ªÉm t√≠ch l≈©y kh√°ch h√†ng</p>
                    </div>
                </div>
                <div class="search-box">
                    <input type="text" class="search-input" id="search-cust" placeholder="T√¨m theo t√™n, m√£ ho·∫∑c SƒêT..." oninput="filterCustomersList()">
                    <button class="btn btn-primary" onclick="filterCustomersList()">T√¨m ki·∫øm</button>
                    <button class="btn btn-secondary" onclick="loadCustomersList()">T·∫£i l·∫°i</button>
                </div>
                <div id="customers-container" class="table-container">
                    <div class="loading"><div class="spinner"></div><p>ƒêang t·∫£i...</p></div>
                </div>
            `;

            await loadCustomersList();
        }

        async function loadCustomersList() {
            try {
                const response = await fetch(`${API_BASE}/khachhang`);
                const result = await response.json();

                if (result.success) {
                    customers = result.data;
                    renderCustomersTable(customers);
                }
            } catch (error) {
                // showToast('L·ªói t·∫£i d·ªØ li·ªáu', 'error');
            }
        }

        function renderCustomersTable(data) {
            const container = document.getElementById('customers-container');

            if (!data.length) {
                container.innerHTML = '<div class="empty-state">Ch∆∞a c√≥ kh√°ch h√†ng</div>';
                return;
            }

            container.innerHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>M√£ KH</th>
                            <th>T√™n Kh√°ch H√†ng</th>
                            <th>Ph√¢n Lo·∫°i</th>
                            <th>ƒê·ªãa Ch·ªâ</th>
                            <th>SƒêT</th>
                            <th>ƒêi·ªÉm T√≠ch L≈©y</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${data.map(c => {
                            const type = customerTypes.find(t => t.id === c.idPLKH || t.maPLKH === c.maPLKH);
                            return `
                                <tr>
                                    <td><strong>${c.maKH}</strong></td>
                                    <td>${c.tenKH}</td>
                                    <td><span class="badge badge-info">${c.tenPLKH || (type ? type.tenPLKH : c.maPLKH || '-')}</span></td>
                                    <td>${c.diachi || '-'}</td>
                                    <td>${c.sdt || '-'}</td>
                                    <td><strong class="value-success">${c.diemtichluy || 0} ƒëi·ªÉm</strong></td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
        }

        function filterCustomersList() {
            const keyword = document.getElementById('search-cust').value.toLowerCase();
            const filtered = customers.filter(c =>
                c.tenKH.toLowerCase().includes(keyword) ||
                c.maKH.toLowerCase().includes(keyword) ||
                (c.sdt && c.sdt.includes(keyword))
            );
            renderCustomersTable(filtered);
        }

        // ==================== STATISTICS ====================
        async function renderStatistics() {
            const content = document.getElementById('page-content');
            const today = new Date();
            const currentYear = today.getFullYear();
            const currentMonth = today.getMonth() + 1;
            const currentQuarter = Math.floor((currentMonth - 1) / 3) + 1;
            
            content.innerHTML = `
                <div class="page-header">
                    <div>
                        <h2>Th·ªëng K√™ Doanh Thu</h2>
                        <p>Th·ªëng k√™ doanh thu theo nhi·ªÅu ti√™u ch√≠</p>
                    </div>
                </div>
                <div class="search-box">
                    <select id="stat-period" class="search-input" style="max-width: 150px;" onchange="changeStatPeriod()">
                        <option value="day">Theo Ng√†y</option>
                        <option value="week">Theo Tu·∫ßn</option>
                        <option value="month" selected>Theo Th√°ng</option>
                        <option value="quarter">Theo Qu√Ω</option>
                        <option value="year">Theo NƒÉm</option>
                    </select>
                    <div id="stat-date-filters"></div>
                    <select id="stat-nhanvien" class="search-input" style="max-width: 200px;">
                        <option value="">T·∫•t c·∫£ nh√¢n vi√™n</option>
                        ${nhanvienList.map(nv => `<option value="${nv.id}">${nv.tenNV} (${nv.maNV})</option>`).join('')}
                    </select>
                    <button class="btn btn-primary" onclick="loadStatistics()">Xem Th·ªëng K√™</button>
                    <button class="btn btn-success" onclick="exportStatisticsReport('pdf')" title="Xu·∫•t PDF">
                        üìÑ PDF
                    </button>
                    <button class="btn btn-success" onclick="exportStatisticsReport('excel')" title="Xu·∫•t Excel">
                        üìä Excel
                    </button>
                </div>
                <div class="stats-row" id="stat-summary"></div>
                <div id="stat-container" class="table-container">
                    <div class="loading"><div class="spinner"></div><p>ƒêang t·∫£i...</p></div>
                </div>
            `;
            
            changeStatPeriod();
            await loadStatistics();
        }
        
        function changeStatPeriod() {
            const period = document.getElementById('stat-period').value;
            const filtersDiv = document.getElementById('stat-date-filters');
            const today = new Date();
            
            if (period === 'day') {
                const startDate = new Date(today);
                startDate.setDate(startDate.getDate() - 30);
                filtersDiv.innerHTML = `
                    <input type="date" id="stat-start-date" class="search-input" style="max-width: 150px;" 
                           value="${startDate.toISOString().split('T')[0]}">
                    <input type="date" id="stat-end-date" class="search-input" style="max-width: 150px;" 
                           value="${today.toISOString().split('T')[0]}">
                `;
            } else if (period === 'month') {
                filtersDiv.innerHTML = `
                    <select id="stat-month" class="search-input" style="max-width: 150px;">
                        ${Array.from({length: 12}, (_, i) => `<option value="${i+1}" ${today.getMonth() === i ? 'selected' : ''}>Th√°ng ${i+1}</option>`).join('')}
                    </select>
                    <select id="stat-year" class="search-input" style="max-width: 120px;">
                        ${Array.from({length: 5}, (_, i) => {
                            const year = today.getFullYear() - i;
                            return `<option value="${year}" ${i === 0 ? 'selected' : ''}>${year}</option>`;
                        }).join('')}
                    </select>
                `;
            } else if (period === 'quarter') {
                filtersDiv.innerHTML = `
                    <select id="stat-quarter" class="search-input" style="max-width: 120px;">
                        <option value="1" ${Math.floor((today.getMonth()) / 3) === 0 ? 'selected' : ''}>Qu√Ω 1</option>
                        <option value="2" ${Math.floor((today.getMonth()) / 3) === 1 ? 'selected' : ''}>Qu√Ω 2</option>
                        <option value="3" ${Math.floor((today.getMonth()) / 3) === 2 ? 'selected' : ''}>Qu√Ω 3</option>
                        <option value="4" ${Math.floor((today.getMonth()) / 3) === 3 ? 'selected' : ''}>Qu√Ω 4</option>
                    </select>
                    <select id="stat-year" class="search-input" style="max-width: 120px;">
                        ${Array.from({length: 5}, (_, i) => {
                            const year = today.getFullYear() - i;
                            return `<option value="${year}" ${i === 0 ? 'selected' : ''}>${year}</option>`;
                        }).join('')}
                    </select>
                `;
            } else if (period === 'year') {
                filtersDiv.innerHTML = `
                    <select id="stat-year" class="search-input" style="max-width: 120px;">
                        ${Array.from({length: 5}, (_, i) => {
                            const year = today.getFullYear() - i;
                            return `<option value="${year}" ${i === 0 ? 'selected' : ''}>${year}</option>`;
                        }).join('')}
                    </select>
                `;
            } else {
                filtersDiv.innerHTML = '';
            }
        }

        async function loadStatistics() {
            try {
                const period = document.getElementById('stat-period').value;
                const idNV = document.getElementById('stat-nhanvien')?.value || '';
                let url = `${API_BASE}/thongke/doanhthu?period=${period}`;
                
                if (idNV) {
                    url += `&idNV=${idNV}`;
                }
                
                if (period === 'day') {
                    const startDate = document.getElementById('stat-start-date').value;
                    const endDate = document.getElementById('stat-end-date').value;
                    url += `&startDate=${startDate}&endDate=${endDate}`;
                } else if (period === 'month') {
                    const month = document.getElementById('stat-month').value;
                    const year = document.getElementById('stat-year').value;
                    // T√≠nh startDate v√† endDate cho th√°ng
                    const startDate = `${year}-${String(month).padStart(2, '0')}-01`;
                    const lastDay = new Date(year, month, 0).getDate();
                    const endDate = `${year}-${String(month).padStart(2, '0')}-${lastDay}`;
                    url += `&startDate=${startDate}&endDate=${endDate}`;
                } else if (period === 'quarter') {
                    const quarter = document.getElementById('stat-quarter').value;
                    const year = document.getElementById('stat-year').value;
                    const startMonth = (parseInt(quarter) - 1) * 3 + 1;
                    const endMonth = parseInt(quarter) * 3;
                    const startDate = `${year}-${String(startMonth).padStart(2, '0')}-01`;
                    const lastDay = new Date(year, endMonth, 0).getDate();
                    const endDate = `${year}-${String(endMonth).padStart(2, '0')}-${lastDay}`;
                    url += `&startDate=${startDate}&endDate=${endDate}`;
                } else if (period === 'year') {
                    const year = document.getElementById('stat-year').value;
                    const startDate = `${year}-01-01`;
                    const endDate = `${year}-12-31`;
                    url += `&startDate=${startDate}&endDate=${endDate}`;
                }
                
                const response = await fetch(url);
                const result = await response.json();

                if (result.success) {
                    const stats = result.data;
                    
                    // T√≠nh t·ªïng
                    const totalRevenue = stats.reduce((sum, s) => sum + (parseFloat(s.tongDoanhThu) || 0), 0);
                    const totalOrders = stats.reduce((sum, s) => sum + (parseInt(s.soHoaDon) || 0), 0);
                    
                    // Hi·ªÉn th·ªã summary
                    document.getElementById('stat-summary').innerHTML = `
                        <div class="stat-card green">
                            <h3>${formatCurrency(totalRevenue)}</h3>
                            <p>T·ªïng doanh thu</p>
                        </div>
                        <div class="stat-card blue">
                            <h3>${totalOrders}</h3>
                            <p>T·ªïng s·ªë h√≥a ƒë∆°n</p>
                        </div>
                        <div class="stat-card purple">
                            <h3>${stats.length}</h3>
                            <p>S·ªë ${period === 'day' ? 'ng√†y' : period === 'week' ? 'tu·∫ßn' : period === 'month' ? 'th√°ng' : period === 'quarter' ? 'qu√Ω' : 'nƒÉm'}</p>
                        </div>
                        <div class="stat-card orange">
                            <h3>${totalOrders > 0 ? formatCurrency(totalRevenue / totalOrders) : '0ƒë'}</h3>
                            <p>Trung b√¨nh m·ªói h√≥a ƒë∆°n</p>
                        </div>
                    `;
                    
                    renderStatisticsTable(stats, period);
                } else {
                    showToast('L·ªói t·∫£i th·ªëng k√™', 'error');
                }
            } catch (error) {
                showToast('L·ªói t·∫£i th·ªëng k√™: ' + error.message, 'error');
            }
        }
        
        function renderStatisticsTable(data, period) {
            const container = document.getElementById('stat-container');

            if (!data.length) {
                container.innerHTML = `<div class="empty-state">Kh√¥ng c√≥ d·ªØ li·ªáu</div>`;
                return;
            }

            let headers = '';
            let rows = '';
            
            // Ki·ªÉm tra xem c√≥ d·ªØ li·ªáu nh√¢n vi√™n kh√¥ng (n·∫øu API tr·∫£ v·ªÅ)
            const hasNhanVien = data[0] && (data[0].maNV || data[0].tenNhanVien || data[0].idNV);
            
            if (period === 'day') {
                headers = hasNhanVien ? '<th>Ng√†y</th><th>Nh√¢n Vi√™n</th><th>S·ªë H√≥a ƒê∆°n</th><th>T·ªïng Doanh Thu</th>' : '<th>Ng√†y</th><th>S·ªë H√≥a ƒê∆°n</th><th>T·ªïng Doanh Thu</th>';
                rows = data.map(s => {
                    const nv = hasNhanVien ? (nhanvienList.find(n => n.id === s.idNV || n.maNV === s.maNV) || { tenNV: s.tenNhanVien || s.maNV || '-', maNV: s.maNV || '-' }) : null;
                    return `
                    <tr>
                        <td><strong>${formatDate(s.ngay)}</strong></td>
                        ${hasNhanVien ? `<td>${nv ? `${nv.tenNV} (${nv.maNV})` : '-'}</td>` : ''}
                        <td>${s.soHoaDon}</td>
                        <td><strong class="value-success">${formatCurrency(s.tongDoanhThu)}</strong></td>
                    </tr>
                `;
                }).join('');
            } else if (period === 'week') {
                headers = hasNhanVien ? '<th>NƒÉm</th><th>Tu·∫ßn</th><th>Nh√¢n Vi√™n</th><th>S·ªë H√≥a ƒê∆°n</th><th>T·ªïng Doanh Thu</th>' : '<th>NƒÉm</th><th>Tu·∫ßn</th><th>S·ªë H√≥a ƒê∆°n</th><th>T·ªïng Doanh Thu</th>';
                rows = data.map(s => {
                    const nv = hasNhanVien ? (nhanvienList.find(n => n.id === s.idNV || n.maNV === s.maNV) || { tenNV: s.tenNhanVien || s.maNV || '-', maNV: s.maNV || '-' }) : null;
                    return `
                    <tr>
                        <td><strong>${s.nam}</strong></td>
                        <td>Tu·∫ßn ${s.tuan}</td>
                        ${hasNhanVien ? `<td>${nv ? `${nv.tenNV} (${nv.maNV})` : '-'}</td>` : ''}
                        <td>${s.soHoaDon}</td>
                        <td><strong class="value-success">${formatCurrency(s.tongDoanhThu)}</strong></td>
                    </tr>
                `;
                }).join('');
            } else if (period === 'month') {
                headers = hasNhanVien ? '<th>NƒÉm</th><th>Th√°ng</th><th>Nh√¢n Vi√™n</th><th>S·ªë H√≥a ƒê∆°n</th><th>T·ªïng Doanh Thu</th>' : '<th>NƒÉm</th><th>Th√°ng</th><th>S·ªë H√≥a ƒê∆°n</th><th>T·ªïng Doanh Thu</th>';
                rows = data.map(s => {
                    const nv = hasNhanVien ? (nhanvienList.find(n => n.id === s.idNV || n.maNV === s.maNV) || { tenNV: s.tenNhanVien || s.maNV || '-', maNV: s.maNV || '-' }) : null;
                    return `
                    <tr>
                        <td><strong>${s.nam}</strong></td>
                        <td>Th√°ng ${s.thang}</td>
                        ${hasNhanVien ? `<td>${nv ? `${nv.tenNV} (${nv.maNV})` : '-'}</td>` : ''}
                        <td>${s.soHoaDon}</td>
                        <td><strong class="value-success">${formatCurrency(s.tongDoanhThu)}</strong></td>
                    </tr>
                `;
                }).join('');
            } else if (period === 'quarter') {
                headers = hasNhanVien ? '<th>NƒÉm</th><th>Qu√Ω</th><th>Nh√¢n Vi√™n</th><th>S·ªë H√≥a ƒê∆°n</th><th>T·ªïng Doanh Thu</th>' : '<th>NƒÉm</th><th>Qu√Ω</th><th>S·ªë H√≥a ƒê∆°n</th><th>T·ªïng Doanh Thu</th>';
                rows = data.map(s => {
                    const nv = hasNhanVien ? (nhanvienList.find(n => n.id === s.idNV || n.maNV === s.maNV) || { tenNV: s.tenNhanVien || s.maNV || '-', maNV: s.maNV || '-' }) : null;
                    return `
                    <tr>
                        <td><strong>${s.nam}</strong></td>
                        <td>Qu√Ω ${s.quy}</td>
                        ${hasNhanVien ? `<td>${nv ? `${nv.tenNV} (${nv.maNV})` : '-'}</td>` : ''}
                        <td>${s.soHoaDon}</td>
                        <td><strong class="value-success">${formatCurrency(s.tongDoanhThu)}</strong></td>
                    </tr>
                `;
                }).join('');
            } else if (period === 'year') {
                headers = hasNhanVien ? '<th>NƒÉm</th><th>Nh√¢n Vi√™n</th><th>S·ªë H√≥a ƒê∆°n</th><th>T·ªïng Doanh Thu</th>' : '<th>NƒÉm</th><th>S·ªë H√≥a ƒê∆°n</th><th>T·ªïng Doanh Thu</th>';
                rows = data.map(s => {
                    const nv = hasNhanVien ? (nhanvienList.find(n => n.id === s.idNV || n.maNV === s.maNV) || { tenNV: s.tenNhanVien || s.maNV || '-', maNV: s.maNV || '-' }) : null;
                    return `
                    <tr>
                        <td><strong>${s.nam}</strong></td>
                        ${hasNhanVien ? `<td>${nv ? `${nv.tenNV} (${nv.maNV})` : '-'}</td>` : ''}
                        <td>${s.soHoaDon}</td>
                        <td><strong class="value-success">${formatCurrency(s.tongDoanhThu)}</strong></td>
                    </tr>
                `;
                }).join('');
            }

            container.innerHTML = `
                <table>
                    <thead>
                        <tr>
                            ${headers}
                        </tr>
                    </thead>
                    <tbody>
                        ${rows}
                    </tbody>
                </table>
            `;
        }

        // ==================== L·ªäCH S·ª¨ HO·∫†T ƒê·ªòNG ====================
        let lichSuData = [];
        let lichSuFilteredData = [];

        async function renderLichSu() {
            const content = document.getElementById('page-content');
            content.innerHTML = `
                <div class="page-header">
                    <div>
                        <h2>üìã L·ªãch S·ª≠ Ho·∫°t ƒê·ªông</h2>
                        <p>Xem l·∫°i c√°c ho·∫°t ƒë·ªông ƒë√£ th·ª±c hi·ªán trong h·ªá th·ªëng</p>
                    </div>
                </div>
                <div class="search-box" style="margin-bottom: 20px;">
                    <select id="lichsu-filter-loai" class="search-input" style="max-width: 200px;" onchange="loadLichSuData()">
                        <option value="">T·∫•t c·∫£ lo·∫°i</option>
                        <option value="T·∫°o h√≥a ƒë∆°n">T·∫°o h√≥a ƒë∆°n</option>
                        <option value="S·ª≠a h√≥a ƒë∆°n">S·ª≠a h√≥a ƒë∆°n</option>
                        <option value="X√≥a h√≥a ƒë∆°n">X√≥a h√≥a ƒë∆°n</option>
                        <option value="T·∫°o phi·∫øu nh·∫≠p">T·∫°o phi·∫øu nh·∫≠p</option>
                        <option value="S·ª≠a phi·∫øu nh·∫≠p">S·ª≠a phi·∫øu nh·∫≠p</option>
                        <option value="X√≥a phi·∫øu nh·∫≠p">X√≥a phi·∫øu nh·∫≠p</option>
                    </select>
                    <input type="text" 
                           id="lichsu-search-input" 
                           class="search-input"
                           placeholder="üîç T√¨m ki·∫øm theo m√¥ t·∫£, nh√¢n vi√™n, m√£ tham chi·∫øu..." 
                           style="flex: 1; max-width: 500px;"
                           oninput="filterLichSuData()"
                           onkeyup="if(event.key === 'Enter') filterLichSuData()">
                    <button class="btn btn-secondary" onclick="clearLichSuSearch()">‚úï X√≥a</button>
                    <button class="btn btn-primary" onclick="loadLichSuData()">üîÑ T·∫£i L·∫°i</button>
                    <button class="btn btn-success" onclick="exportLichSuReport('pdf')" title="Xu·∫•t PDF">
                        üìÑ PDF
                    </button>
                    <button class="btn btn-success" onclick="exportLichSuReport('excel')" title="Xu·∫•t Excel">
                        üìä Excel
                    </button>
                </div>
                <div id="lichsu-container" class="table-container">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>ƒêang t·∫£i l·ªãch s·ª≠...</p>
                    </div>
                </div>
            `;
            
            await loadLichSuData();
        }

        async function loadLichSuData() {
            try {
                const loaiHoatDong = document.getElementById('lichsu-filter-loai')?.value || '';
                
                let url = `${API_BASE}/lichsu?limit=200`;
                if (loaiHoatDong) {
                    url += `&loaiHoatDong=${encodeURIComponent(loaiHoatDong)}`;
                }
                
                const response = await fetch(url);
                const result = await response.json();
                
                if (result.success) {
                    lichSuData = result.data || [];
                    lichSuFilteredData = [...lichSuData];
                    renderLichSuTable();
                } else {
                    showToast(result.message || 'L·ªói t·∫£i l·ªãch s·ª≠', 'error');
                }
            } catch (error) {
                showToast('L·ªói: ' + error.message, 'error');
            }
        }

        function renderLichSuTable() {
            const container = document.getElementById('lichsu-container');
            
            if (lichSuFilteredData.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px; color: #999;">
                        <div style="font-size: 64px; margin-bottom: 15px;">üìã</div>
                        <h3 style="color: #666; margin-bottom: 10px;">Ch∆∞a c√≥ l·ªãch s·ª≠ ho·∫°t ƒë·ªông</h3>
                        <p>Ch∆∞a c√≥ ho·∫°t ƒë·ªông n√†o ƒë∆∞·ª£c ghi l·∫°i trong h·ªá th·ªëng.</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th style="width: 150px;">Th·ªùi Gian</th>
                            <th style="width: 150px;">Nh√¢n Vi√™n</th>
                            <th style="width: 150px;">Lo·∫°i Ho·∫°t ƒê·ªông</th>
                            <th>M√¥ T·∫£</th>
                            <th style="width: 120px;">Tham Chi·∫øu</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${lichSuFilteredData.map(item => {
                            // S·ª≠ d·ª•ng formatDateTime ƒë·ªÉ hi·ªÉn th·ªã ƒë√∫ng th·ªùi gian t·ª´ database (c√≥ c·∫£ gi√¢y)
                            const thoiGian = formatDateTime(item.thoiGian);
                            
                            const loaiIcon = {
                                'T·∫°o h√≥a ƒë∆°n': '‚úÖ',
                                'S·ª≠a h√≥a ƒë∆°n': '‚úèÔ∏è',
                                'X√≥a h√≥a ƒë∆°n': '‚ùå',
                                'T·∫°o phi·∫øu nh·∫≠p': 'üì•',
                                'S·ª≠a phi·∫øu nh·∫≠p': '‚úèÔ∏è',
                                'X√≥a phi·∫øu nh·∫≠p': '‚ùå',
                                'T·∫°o kh√°ch h√†ng': 'üë§',
                                'S·ª≠a kh√°ch h√†ng': '‚úèÔ∏è',
                                'T·∫°o h√†ng h√≥a': 'üì¶',
                                'S·ª≠a h√†ng h√≥a': '‚úèÔ∏è'
                            }[item.loaiHoatDong] || 'üìã';
                            
                            return `
                                <tr>
                                    <td>${thoiGian}</td>
                                    <td>${item.tenNhanVien || item.maNV || 'N/A'}</td>
                                    <td>
                                        <span style="display: inline-flex; align-items: center; gap: 5px;">
                                            ${loaiIcon} ${item.loaiHoatDong}
                                        </span>
                                    </td>
                                    <td>${item.moTa || '-'}</td>
                                    <td>
                                        ${item.thamChieu ? `
                                            <span style="color: #4a90e2; font-weight: 600;">${item.thamChieu}</span>
                                        ` : '-'}
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
                <div style="margin-top: 15px; color: #666; font-size: 14px;">
                    Hi·ªÉn th·ªã <strong>${lichSuFilteredData.length}</strong> / ${lichSuData.length} ho·∫°t ƒë·ªông
                </div>
            `;
        }

        function filterLichSuData() {
            const searchTerm = document.getElementById('lichsu-search-input')?.value.toLowerCase() || '';
            
            if (!searchTerm) {
                lichSuFilteredData = [...lichSuData];
            } else {
                lichSuFilteredData = lichSuData.filter(item => {
                    const moTa = (item.moTa || '').toLowerCase();
                    const loaiHoatDong = (item.loaiHoatDong || '').toLowerCase();
                    const tenNhanVien = (item.tenNhanVien || item.maNV || '').toLowerCase();
                    const thamChieu = (item.thamChieu || '').toLowerCase();
                    
                    return moTa.includes(searchTerm) || 
                           loaiHoatDong.includes(searchTerm) || 
                           tenNhanVien.includes(searchTerm) ||
                           thamChieu.includes(searchTerm);
                });
            }
            
            renderLichSuTable();
        }

        function clearLichSuSearch() {
            const searchInput = document.getElementById('lichsu-search-input');
            if (searchInput) {
                searchInput.value = '';
            }
            const filterSelect = document.getElementById('lichsu-filter-loai');
            if (filterSelect) {
                filterSelect.value = '';
            }
            lichSuFilteredData = [...lichSuData];
            renderLichSuTable();
        }

        // Xu·∫•t b√°o c√°o th·ªëng k√™
        async function exportStatisticsReport(format) {
            try {
                const period = document.getElementById('stat-period').value;
                const idNV = document.getElementById('stat-nhanvien')?.value || '';
                let url = `${API_BASE}/thongke/doanhthu/export?period=${period}&format=${format}`;
                
                if (period === 'day') {
                    const startDate = document.getElementById('stat-start-date').value;
                    const endDate = document.getElementById('stat-end-date').value;
                    if (!startDate || !endDate) {
                        showToast('Vui l√≤ng ch·ªçn kho·∫£ng th·ªùi gian', 'error');
                        return;
                    }
                    url += `&startDate=${startDate}&endDate=${endDate}`;
                } else if (period === 'month') {
                    const month = document.getElementById('stat-month').value;
                    const year = document.getElementById('stat-year').value;
                    const startDate = `${year}-${String(month).padStart(2, '0')}-01`;
                    const lastDay = new Date(year, month, 0).getDate();
                    const endDate = `${year}-${String(month).padStart(2, '0')}-${lastDay}`;
                    url += `&startDate=${startDate}&endDate=${endDate}`;
                } else if (period === 'quarter') {
                    const quarter = document.getElementById('stat-quarter').value;
                    const year = document.getElementById('stat-year').value;
                    const startMonth = (parseInt(quarter) - 1) * 3 + 1;
                    const endMonth = parseInt(quarter) * 3;
                    const startDate = `${year}-${String(startMonth).padStart(2, '0')}-01`;
                    const lastDay = new Date(year, endMonth, 0).getDate();
                    const endDate = `${year}-${String(endMonth).padStart(2, '0')}-${lastDay}`;
                    url += `&startDate=${startDate}&endDate=${endDate}`;
                } else if (period === 'year') {
                    const year = document.getElementById('stat-year').value;
                    const startDate = `${year}-01-01`;
                    const endDate = `${year}-12-31`;
                    url += `&startDate=${startDate}&endDate=${endDate}`;
                }
                
                if (idNV) {
                    url += `&idNV=${idNV}`;
                }
                
                showToast('ƒêang xu·∫•t b√°o c√°o...', 'info');
                
                const response = await fetch(url);
                if (!response.ok) {
                    const error = await response.json();
                    showToast(error.message || 'L·ªói xu·∫•t b√°o c√°o', 'error');
                    return;
                }
                
                const blob = await response.blob();
                const downloadUrl = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = downloadUrl;
                a.download = `BaoCaoDoanhThu_${period}_${new Date().toISOString().split('T')[0]}.${format === 'excel' ? 'xlsx' : 'pdf'}`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(downloadUrl);
                document.body.removeChild(a);
                
                showToast('Xu·∫•t b√°o c√°o th√†nh c√¥ng!', 'success');
            } catch (error) {
                showToast('L·ªói: ' + error.message, 'error');
            }
        }

        // Xu·∫•t b√°o c√°o l·ªãch s·ª≠
        async function exportLichSuReport(format) {
            try {
                const loaiHoatDong = document.getElementById('lichsu-filter-loai')?.value || '';
                let url = `${API_BASE}/lichsu/export?format=${format}`;
                
                if (loaiHoatDong) {
                    url += `&loaiHoatDong=${encodeURIComponent(loaiHoatDong)}`;
                }
                
                showToast('ƒêang xu·∫•t b√°o c√°o...', 'info');
                
                const response = await fetch(url);
                if (!response.ok) {
                    const error = await response.json();
                    showToast(error.message || 'L·ªói xu·∫•t b√°o c√°o', 'error');
                    return;
                }
                
                const blob = await response.blob();
                const downloadUrl = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = downloadUrl;
                a.download = `BaoCaoLichSu_${new Date().toISOString().split('T')[0]}.${format === 'excel' ? 'xlsx' : 'pdf'}`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(downloadUrl);
                document.body.removeChild(a);
                
                showToast('Xu·∫•t b√°o c√°o th√†nh c√¥ng!', 'success');
            } catch (error) {
                showToast('L·ªói: ' + error.message, 'error');
            }
        }

        // ==================== PHI·∫æU NH·∫¨P ====================
        let phieuNhapList = [];
        let phieuNhapCart = []; // Gi·ªè h√†ng cho phi·∫øu nh·∫≠p
        let currentViewingPhieuNhap = null; // L∆∞u phi·∫øu nh·∫≠p ƒëang xem

        // Ki·ªÉm tra quy·ªÅn t·∫°o phi·∫øu nh·∫≠p
        function canCreatePhieuNhap() {
            if (!currentUserNhanVien) {
                // N·∫øu ch∆∞a c√≥ th√¥ng tin nh√¢n vi√™n, th·ª≠ t√¨m l·∫°i
                if (currentUser && currentUser.idNV) {
                    currentUserNhanVien = nhanvienList.find(nv => nv.id === currentUser.idNV);
                }
            }
            
            if (!currentUserNhanVien || !currentUserNhanVien.tenVT) {
                return false;
            }
            
            const tenVT = (currentUserNhanVien.tenVT || '').toLowerCase();
            return tenVT.includes('qu·∫£n l√Ω') || tenVT.includes('quan ly') || 
                   tenVT.includes('th·ªß kho') || tenVT.includes('thu kho') ||
                   tenVT.includes('warehouse') || tenVT.includes('manager');
        }

        async function renderPhieuNhap() {
            // Clear cart v√† danh s√°ch h√†ng h√≥a m·ªõi khi quay l·∫°i trang danh s√°ch
            phieuNhapCart = [];
            newProductsList = [];
            
            const content = document.getElementById('page-content');
            content.innerHTML = `
                <div class="page-header">
                    <div>
                        <h2>Qu·∫£n L√Ω Phi·∫øu Nh·∫≠p H√†ng</h2>
                        <p>Qu·∫£n l√Ω c√°c phi·∫øu nh·∫≠p h√†ng v√†o kho</p>
                    </div>
                    <button class="btn btn-success" onclick="renderCreatePhieuNhap()">‚ûï T·∫°o Phi·∫øu Nh·∫≠p M·ªõi</button>
                </div>
                <div class="search-box">
                    <input type="text" class="search-input" id="search-phieunhap" placeholder="T√¨m theo m√£ phi·∫øu, nh√¢n vi√™n..." oninput="filterPhieuNhap()">
                    <button class="btn btn-primary" onclick="filterPhieuNhap()">T√¨m ki·∫øm</button>
                    <button class="btn btn-secondary" onclick="loadPhieuNhap()">T·∫£i l·∫°i</button>
                </div>
                <div id="phieunhap-container" class="table-container">
                    <div class="loading"><div class="spinner"></div><p>ƒêang t·∫£i...</p></div>
                </div>
            `;

            await loadPhieuNhap();
        }

        // T·∫°o phi·∫øu nh·∫≠p m·ªõi - hi·ªÉn th·ªã tr·ª±c ti·∫øp tr√™n trang
        async function renderCreatePhieuNhap(keepCart = false) {
            const content = document.getElementById('page-content');
            // Ch·ªâ reset cart n·∫øu kh√¥ng ph·∫£i quay l·∫°i t·ª´ trang th√™m h√†ng h√≥a m·ªõi
            if (!keepCart) {
                phieuNhapCart = [];
                newProductsList = [];
            }
            
            content.innerHTML = `
                <div class="page-header">
                    <div>
                        <h2>‚ûï T·∫°o Phi·∫øu Nh·∫≠p H√†ng M·ªõi</h2>
                        <p>Ch·ªçn ho·∫∑c th√™m h√†ng h√≥a v√†o phi·∫øu nh·∫≠p</p>
                    </div>
                    <button class="btn btn-outline" onclick="renderPhieuNhap()">‚Üê Quay l·∫°i danh s√°ch</button>
                </div>
                <div class="cart-section">
                    <div class="products-panel">
                        <div class="search-box" style="background: transparent; padding: 0; margin-bottom: 15px;">
                            <input type="text" class="search-input" id="search-phieunhap-product" placeholder="T√¨m s·∫£n ph·∫©m..." oninput="filterPhieuNhapProducts()">
                            <button class="btn btn-primary" onclick="filterPhieuNhapProducts()">T√¨m</button>
                            <button class="btn btn-secondary" onclick="reloadPhieuNhapProducts()">T·∫£i l·∫°i</button>
                            <button class="btn btn-success" onclick="renderAddNewProducts()">‚ûï Th√™m H√†ng H√≥a M·ªõi</button>
                        </div>
                        <div id="phieunhap-products" class="product-grid"></div>
                    </div>
                    <div class="cart-panel">
                        <div class="panel-title">Danh S√°ch Nh·∫≠p</div>
                        <div id="phieunhap-cart-items"></div>
                        <div id="phieunhap-cart-summary"></div>
                    </div>
                </div>
            `;

            await loadProducts();
            renderPhieuNhapProducts(products);
            // ƒê·∫£m b·∫£o DOM ƒë√£ ƒë∆∞·ª£c render tr∆∞·ªõc khi g·ªçi renderPhieuNhapCart
            setTimeout(() => {
                renderPhieuNhapCart();
            }, 100);
        }
        
        // View th√™m nhi·ªÅu h√†ng h√≥a m·ªõi v√†o phi·∫øu nh·∫≠p (ch∆∞a t·∫°o trong database)
        let newProductsList = []; // Danh s√°ch h√†ng h√≥a m·ªõi t·∫°m th·ªùi
        
        function renderAddNewProducts() {
            const content = document.getElementById('page-content');
            newProductsList = []; // Reset danh s√°ch
            
            content.innerHTML = `
                <div class="page-header">
                    <div>
                        <h2>‚ûï Th√™m H√†ng H√≥a M·ªõi V√†o Phi·∫øu Nh·∫≠p</h2>
                        <p>Th√™m h√†ng h√≥a m·ªõi v√†o phi·∫øu nh·∫≠p (s·∫Ω ƒë∆∞·ª£c t·∫°o khi l∆∞u phi·∫øu nh·∫≠p)</p>
                    </div>
                    <button class="btn btn-outline" onclick="renderCreatePhieuNhap()">‚Üê Quay l·∫°i</button>
                </div>
                
                <div style="background: white; border-radius: 12px; padding: 25px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                    <div style="background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #ff9800;">
                        <p style="margin: 0; color: #e65100; font-size: 13px;">
                            <strong>‚ÑπÔ∏è L∆∞u √Ω:</strong> H√†ng h√≥a m·ªõi s·∫Ω ƒë∆∞·ª£c th√™m v√†o phi·∫øu nh·∫≠p v√† t·ª± ƒë·ªông t·∫°o trong h·ªá th·ªëng khi b·∫°n l∆∞u phi·∫øu nh·∫≠p.
                        </p>
                    </div>
                    
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="margin: 0; color: #1a2b48;">Danh S√°ch H√†ng H√≥a M·ªõi</h3>
                        <button class="btn btn-primary" onclick="addNewProductRow()">‚ûï Th√™m D√≤ng</button>
                    </div>
                    
                    <div id="new-products-list" style="margin-bottom: 20px;">
                        <!-- Danh s√°ch h√†ng h√≥a s·∫Ω ƒë∆∞·ª£c th√™m v√†o ƒë√¢y -->
                    </div>
                    
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-weight: 600; color: #1a2b48;">T·ªïng s·ªë h√†ng h√≥a:</span>
                            <span id="total-products-count" style="font-size: 18px; font-weight: 700; color: #1976d2;">0</span>
                        </div>
                    </div>
                    
                    <div class="form-actions" style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button class="btn btn-outline" onclick="renderCreatePhieuNhap()">H·ªßy</button>
                        <button class="btn btn-success" onclick="addNewProductsToPhieuNhap()" id="add-to-phieunhap-btn" disabled>
                            ‚ûï Th√™m V√†o Phi·∫øu Nh·∫≠p (<span id="add-count">0</span>)
                        </button>
                    </div>
                </div>
            `;
            
            // Th√™m d√≤ng ƒë·∫ßu ti√™n
            addNewProductRow();
        }
        
        function addNewProductRow() {
            const listContainer = document.getElementById('new-products-list');
            if (!listContainer) return;
            
            const rowId = 'product-row-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
            const productData = {
                id: rowId,
                tenHang: '',
                idPLSP: '',
                gianhap: 0,
                giaban: 0,
                soluong: 0,
                tonKhoToiThieu: 10
            };
            
            newProductsList.push(productData);
            
            const rowHTML = `
                <div class="product-form-row" id="${rowId}" style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 15px; border: 2px solid #e0e0e0;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h4 style="margin: 0; color: #1a2b48;">H√†ng H√≥a #${newProductsList.length}</h4>
                        <button class="btn btn-danger btn-sm" onclick="removeProductRow('${rowId}')" style="padding: 6px 12px; font-size: 12px;">üóëÔ∏è X√≥a</button>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group" style="flex: 2;">
                            <label>T√™n H√†ng *</label>
                            <input type="text" class="product-input" data-id="${rowId}" data-field="tenHang" required placeholder="Nh·∫≠p t√™n h√†ng h√≥a" onchange="updateProductData('${rowId}')">
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label>Ph√¢n Lo·∫°i *</label>
                            <select class="product-input" data-id="${rowId}" data-field="idPLSP" required onchange="updateProductData('${rowId}')">
                                <option value="">-- Ch·ªçn --</option>
                                ${phanLoaiSanPhamList.map(pl => `<option value="${pl.id}">${pl.tenPLSP}</option>`).join('')}
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Gi√° Nh·∫≠p *</label>
                            <input type="number" class="product-input" data-id="${rowId}" data-field="gianhap" required min="0" step="1000" placeholder="0" onchange="updateProductData('${rowId}')">
                        </div>
                        <div class="form-group">
                            <label>Gi√° B√°n *</label>
                            <input type="number" class="product-input" data-id="${rowId}" data-field="giaban" required min="0" step="1000" placeholder="0" onchange="updateProductData('${rowId}')">
                        </div>
                        <div class="form-group">
                            <label>S·ªë L∆∞·ª£ng</label>
                            <input type="number" class="product-input" data-id="${rowId}" data-field="soluong" min="0" value="0" placeholder="0" onchange="updateProductData('${rowId}')">
                        </div>
                        <div class="form-group">
                            <label>T·ªìn Kho T·ªëi Thi·ªÉu</label>
                            <input type="number" class="product-input" data-id="${rowId}" data-field="tonKhoToiThieu" min="0" value="10" placeholder="10" onchange="updateProductData('${rowId}')">
                        </div>
                    </div>
                </div>
            `;
            
            listContainer.insertAdjacentHTML('beforeend', rowHTML);
            updateSaveButton();
        }
        
        function removeProductRow(rowId) {
            // X√≥a kh·ªèi danh s√°ch
            newProductsList = newProductsList.filter(p => p.id !== rowId);
            
            // X√≥a kh·ªèi DOM
            const rowElement = document.getElementById(rowId);
            if (rowElement) {
                rowElement.remove();
            }
            
            // C·∫≠p nh·∫≠t s·ªë th·ª© t·ª± v√† n√∫t l∆∞u
            updateRowNumbers();
            updateSaveButton();
        }
        
        function updateRowNumbers() {
            const rows = document.querySelectorAll('.product-form-row');
            rows.forEach((row, index) => {
                const header = row.querySelector('h4');
                if (header) {
                    header.textContent = `H√†ng H√≥a #${index + 1}`;
                }
            });
        }
        
        function updateProductData(rowId) {
            const product = newProductsList.find(p => p.id === rowId);
            if (!product) {
                console.warn('Product not found for rowId:', rowId);
                return;
            }
            
            const inputs = document.querySelectorAll(`[data-id="${rowId}"]`);
            inputs.forEach(input => {
                const field = input.dataset.field;
                if (field) {
                    if (input.type === 'number') {
                        product[field] = parseFloat(input.value) || 0;
                    } else if (input.tagName === 'SELECT') {
                        product[field] = input.value; // Gi·ªØ nguy√™n string cho select
                    } else {
                        product[field] = input.value.trim();
                    }
                }
            });
            
            console.log('Updated product data:', product);
            updateSaveButton();
        }
        
        function updateSaveButton() {
            const totalCount = newProductsList.length;
            const validCount = newProductsList.filter(p => 
                p.tenHang && p.idPLSP && p.gianhap > 0 && p.giaban > 0
            ).length;
            
            const countElement = document.getElementById('total-products-count');
            const addCountElement = document.getElementById('add-count');
            const addButton = document.getElementById('add-to-phieunhap-btn');
            
            if (countElement) countElement.textContent = totalCount;
            if (addCountElement) addCountElement.textContent = validCount;
            if (addButton) {
                addButton.disabled = validCount === 0;
            }
        }
        
        // Th√™m h√†ng h√≥a m·ªõi v√†o gi·ªè h√†ng phi·∫øu nh·∫≠p (ch∆∞a t·∫°o trong database)
        async function addNewProductsToPhieuNhap() {
            // C·∫≠p nh·∫≠t l·∫°i d·ªØ li·ªáu t·ª´ form tr∆∞·ªõc khi filter (ƒë·∫£m b·∫£o d·ªØ li·ªáu m·ªõi nh·∫•t)
            newProductsList.forEach(product => {
                const inputs = document.querySelectorAll(`[data-id="${product.id}"]`);
                inputs.forEach(input => {
                    const field = input.dataset.field;
                    if (field) {
                        if (input.type === 'number') {
                            product[field] = parseFloat(input.value) || 0;
                        } else if (input.tagName === 'SELECT') {
                            product[field] = input.value;
                        } else {
                            product[field] = input.value.trim();
                        }
                    }
                });
            });
            
            const validProducts = newProductsList.filter(p => 
                p.tenHang && p.tenHang.trim() && p.idPLSP && parseInt(p.idPLSP) > 0 && p.gianhap > 0 && p.giaban > 0
            );
            
            if (validProducts.length === 0) {
                showToast('Kh√¥ng c√≥ h√†ng h√≥a h·ª£p l·ªá ƒë·ªÉ th√™m. Vui l√≤ng ki·ªÉm tra l·∫°i: T√™n h√†ng, Ph√¢n lo·∫°i, Gi√° nh·∫≠p, Gi√° b√°n', 'error');
                return;
            }
            
            // Th√™m v√†o gi·ªè h√†ng phi·∫øu nh·∫≠p v·ªõi flag l√† h√†ng h√≥a m·ªõi
            validProducts.forEach(product => {
                // T·∫°o m√£ t·∫°m th·ªùi cho h√†ng h√≥a m·ªõi
                const tempId = 'NEW-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
                
                phieuNhapCart.push({
                    id: null, // Ch∆∞a c√≥ id v√¨ ch∆∞a t·∫°o trong database
                    tempId: tempId, // ID t·∫°m th·ªùi
                    maHang: 'M·ªöI', // ƒê√°nh d·∫•u l√† h√†ng m·ªõi
                    name: product.tenHang,
                    price: product.gianhap, // Gi√° nh·∫≠p
                    quantity: product.soluong || 1, // S·ªë l∆∞·ª£ng nh·∫≠p
                    isNew: true, // Flag ƒë√°nh d·∫•u l√† h√†ng h√≥a m·ªõi
                    newProductData: {
                        tenHang: product.tenHang,
                        idPLSP: parseInt(product.idPLSP),
                        gianhap: product.gianhap,
                        giaban: product.giaban,
                        soluong: 0, // Set = 0 v√¨ trigger s·∫Ω c·ªông s·ªë l∆∞·ª£ng khi t·∫°o chi ti·∫øt phi·∫øu nh·∫≠p
                        tonKhoToiThieu: product.tonKhoToiThieu || 10
                    }
                });
            });
            
            showToast(`ƒê√£ th√™m ${validProducts.length} h√†ng h√≥a m·ªõi v√†o phi·∫øu nh·∫≠p`, 'success');
            
            // Quay l·∫°i trang t·∫°o phi·∫øu nh·∫≠p v√† reload danh s√°ch s·∫£n ph·∫©m
            // Gi·ªØ l·∫°i cart khi quay l·∫°i t·ª´ trang th√™m h√†ng h√≥a m·ªõi
            await loadProducts(); // Reload ƒë·ªÉ c·∫≠p nh·∫≠t danh s√°ch
            renderCreatePhieuNhap(true); // true = keepCart
        }

        async function loadPhieuNhap() {
            try {
                const response = await fetch(`${API_BASE}/phieunhap`);
                const result = await response.json();
                
                if (result.success) {
                    phieuNhapList = result.data;
                    renderPhieuNhapTable(phieuNhapList);
                } else {
                    showToast('L·ªói t·∫£i d·ªØ li·ªáu phi·∫øu nh·∫≠p', 'error');
                }
            } catch (error) {
                console.error('Error loading phieu nhap:', error);
                showToast('L·ªói k·∫øt n·ªëi server', 'error');
            }
        }

        function renderPhieuNhapTable(data) {
            const container = document.getElementById('phieunhap-container');
            if (!data || data.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>Ch∆∞a c√≥ phi·∫øu nh·∫≠p n√†o</p></div>';
                return;
            }

            container.innerHTML = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>M√£ Phi·∫øu</th>
                            <th>Ng√†y Nh·∫≠p</th>
                            <th>Nh√¢n Vi√™n</th>
                            <th>Nh√† Cung C·∫•p</th>
                            <th>T·ªïng Ti·ªÅn</th>
                            <th>Thao T√°c</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${data.map(p => `
                            <tr>
                                <td><strong>${p.maPN}</strong></td>
                                <td>${formatDate(p.ngayNhap)}</td>
                                <td>${p.tenNhanVien || '-'} (${p.maNV || '-'})</td>
                                <td>${p.tenNhaCungCap ? `${p.tenNhaCungCap} (${p.maNCC || ''})` : '<span style="color: #999;">-</span>'}</td>
                                <td><strong class="value-success">${formatCurrency(p.tongTien || 0)}</strong></td>
                                <td>
                                    <button class="btn btn-sm btn-primary" onclick="viewPhieuNhapDetail('${p.maPN}')" title="Xem chi ti·∫øt">üìÑ Xem</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function filterPhieuNhap() {
            const keyword = document.getElementById('search-phieunhap').value.toLowerCase();
            const filtered = phieuNhapList.filter(p =>
                (p.maPN && p.maPN.toLowerCase().includes(keyword)) ||
                (p.tenNhanVien && p.tenNhanVien.toLowerCase().includes(keyword)) ||
                (p.maNV && p.maNV.toLowerCase().includes(keyword))
            );
            renderPhieuNhapTable(filtered);
        }

        async function viewPhieuNhapDetail(maPN) {
            try {
                const phieuNhap = phieuNhapList.find(p => p.maPN === maPN);
                if (!phieuNhap || !phieuNhap.id) {
                    showToast('Kh√¥ng t√¨m th·∫•y phi·∫øu nh·∫≠p', 'error');
                    return;
                }

                const response = await fetch(`${API_BASE}/chitietphieunhap/${phieuNhap.id}`);
                const result = await response.json();

                if (!result.success || !result.data || result.data.length === 0) {
                    showToast('Kh√¥ng c√≥ chi ti·∫øt phi·∫øu nh·∫≠p', 'error');
                    return;
                }

                const details = result.data;
                currentViewingPhieuNhap = phieuNhap;
                
                // T√≠nh t·ªïng ti·ªÅn t·ª´ chi ti·∫øt
                const tongTien = details.reduce((sum, item) => sum + (parseFloat(item.thanhTien) || 0), 0);

                // Hi·ªÉn th·ªã tr·ª±c ti·∫øp trong page-content
                const content = document.getElementById('page-content');
                content.innerHTML = `
                    <div class="page-header">
                        <div>
                            <h2>üìã Chi Ti·∫øt Phi·∫øu Nh·∫≠p H√†ng</h2>
                            <p>M√£ phi·∫øu: ${maPN} | Ng√†y nh·∫≠p: ${formatDate(phieuNhap.ngayNhap)}</p>
                        </div>
                        <button class="btn btn-outline" onclick="renderPhieuNhap()">‚Üê Quay l·∫°i danh s√°ch</button>
                    </div>
                    <div style="padding: 0;">
                        <!-- Header Card -->
                        <div style="background: linear-gradient(135deg, #1976d2 0%, #1565c0 100%); padding: 25px; border-radius: 12px; color: white; box-shadow: 0 4px 15px rgba(25, 118, 210, 0.3); margin-bottom: 25px;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">
                                <div>
                                    <h2 style="margin: 0 0 10px 0; font-size: 28px; font-weight: 900; text-shadow: 2px 2px 4px rgba(0,0,0,0.2);">
                                        üìã PHI·∫æU NH·∫¨P H√ÄNG
                                    </h2>
                                    <div style="background: rgba(255,255,255,0.2); padding: 8px 15px; border-radius: 6px; display: inline-block; font-size: 16px; font-weight: 700;">
                                        ${maPN}
                                    </div>
                                </div>
                                <div style="text-align: right; background: rgba(255,255,255,0.15); padding: 12px 18px; border-radius: 8px; backdrop-filter: blur(10px);">
                                    <div style="font-size: 12px; opacity: 0.9; margin-bottom: 5px;">Ng√†y nh·∫≠p</div>
                                    <div style="font-size: 18px; font-weight: 700;">${formatDate(phieuNhap.ngayNhap)}</div>
                                </div>
                            </div>
                        </div>

                        <!-- Info Cards -->
                        <div style="padding: 25px; background: #f8f9fa;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-bottom: 25px;">
                                <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border-left: 4px solid #1976d2;">
                                    <div style="font-size: 12px; color: #666; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px;">Nh√¢n vi√™n nh·∫≠p</div>
                                    <div style="font-size: 18px; font-weight: 700; color: #1a2b48;">${phieuNhap.tenNhanVien || '-'}</div>
                                    <div style="font-size: 13px; color: #888; margin-top: 5px;">${phieuNhap.maNV || '-'}</div>
                                </div>
                                ${phieuNhap.tenNhaCungCap ? `
                                <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border-left: 4px solid #ff9800;">
                                    <div style="font-size: 12px; color: #666; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px;">Nh√† cung c·∫•p</div>
                                    <div style="font-size: 18px; font-weight: 700; color: #1a2b48;">${phieuNhap.tenNhaCungCap}</div>
                                    <div style="font-size: 13px; color: #888; margin-top: 5px;">${phieuNhap.maNCC || '-'}</div>
                                </div>
                                ` : ''}
                                <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border-left: 4px solid #00b894;">
                                    <div style="font-size: 12px; color: #666; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px;">S·ªë l∆∞·ª£ng s·∫£n ph·∫©m</div>
                                    <div style="font-size: 24px; font-weight: 900; color: #00b894;">${details.length}</div>
                                    <div style="font-size: 13px; color: #888; margin-top: 5px;">m·∫∑t h√†ng</div>
                                </div>
                            </div>

                            <!-- Products Table -->
                            <div style="background: white; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); overflow: hidden; margin-bottom: 20px;">
                                <div style="background: linear-gradient(135deg, #f5f5f5 0%, #e0e0e0 100%); padding: 15px 20px; border-bottom: 2px solid #1976d2;">
                                    <h3 style="margin: 0; color: #1a2b48; font-size: 18px; font-weight: 700;">üì¶ Chi Ti·∫øt H√†ng H√≥a</h3>
                                </div>
                                <div style="overflow-x: auto;">
                                    <table style="width: 100%; border-collapse: collapse;">
                                        <thead>
                                            <tr style="background: #f8f9fa;">
                                                <th style="padding: 15px; text-align: left; font-weight: 700; color: #1a2b48; border-bottom: 2px solid #dee2e6; font-size: 13px; text-transform: uppercase;">STT</th>
                                                <th style="padding: 15px; text-align: left; font-weight: 700; color: #1a2b48; border-bottom: 2px solid #dee2e6; font-size: 13px; text-transform: uppercase;">M√£ H√†ng</th>
                                                <th style="padding: 15px; text-align: left; font-weight: 700; color: #1a2b48; border-bottom: 2px solid #dee2e6; font-size: 13px; text-transform: uppercase;">T√™n H√†ng</th>
                                                <th style="padding: 15px; text-align: center; font-weight: 700; color: #1a2b48; border-bottom: 2px solid #dee2e6; font-size: 13px; text-transform: uppercase;">S·ªë L∆∞·ª£ng</th>
                                                <th style="padding: 15px; text-align: right; font-weight: 700; color: #1a2b48; border-bottom: 2px solid #dee2e6; font-size: 13px; text-transform: uppercase;">ƒê∆°n Gi√°</th>
                                                <th style="padding: 15px; text-align: right; font-weight: 700; color: #1a2b48; border-bottom: 2px solid #dee2e6; font-size: 13px; text-transform: uppercase;">Th√†nh Ti·ªÅn</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${details.map((item, index) => `
                                                <tr style="border-bottom: 1px solid #f0f0f0; transition: background 0.2s;" onmouseover="this.style.background='#f8f9fa'" onmouseout="this.style.background='white'">
                                                    <td style="padding: 15px; color: #666; font-weight: 600;">${index + 1}</td>
                                                    <td style="padding: 15px;">
                                                        <span style="background: #e3f2fd; color: #1976d2; padding: 5px 12px; border-radius: 6px; font-weight: 700; font-size: 13px;">${item.maHang}</span>
                                                    </td>
                                                    <td style="padding: 15px; color: #1a2b48; font-weight: 600;">${item.tenHang}</td>
                                                    <td style="padding: 15px; text-align: center; color: #1a2b48; font-weight: 600;">${item.soluong}</td>
                                                    <td style="padding: 15px; text-align: right; color: #666;">${formatCurrency(item.dongia)}</td>
                                                    <td style="padding: 15px; text-align: right; color: #1976d2; font-weight: 700; font-size: 15px;">${formatCurrency(item.thanhTien)}</td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            
                            <!-- Summary Card -->
                            <div style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
                                <h4 style="margin: 0 0 15px 0; color: #1a2b48; font-size: 16px; font-weight: 700;">üí∞ T·ªïng K·∫øt</h4>
                                <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 10px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                        <span style="color: #666; font-size: 14px;">T·ªïng s·ªë l∆∞·ª£ng:</span>
                                        <span style="color: #1a2b48; font-weight: 600; font-size: 15px;">${details.reduce((sum, item) => sum + (parseInt(item.soluong) || 0), 0)} s·∫£n ph·∫©m</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                        <span style="color: #666; font-size: 14px;">S·ªë m·∫∑t h√†ng:</span>
                                        <span style="color: #1a2b48; font-weight: 600; font-size: 15px;">${details.length} lo·∫°i</span>
                                    </div>
                                </div>
                                <div style="background: linear-gradient(135deg, #1976d2 0%, #1565c0 100%); padding: 18px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 15px rgba(25, 118, 210, 0.3);">
                                    <span style="color: white; font-size: 18px; font-weight: 700;">T·ªïng ti·ªÅn:</span>
                                    <span style="color: white; font-size: 24px; font-weight: 900;">${formatCurrency(phieuNhap.tongTien || tongTien)}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('L·ªói th·ª±c thi:', error);
                showToast('Kh√¥ng th·ªÉ xem chi ti·∫øt phi·∫øu nh·∫≠p!', 'error');
            }
        }

        async function reloadPhieuNhapProducts() {
            await loadProducts();
            document.getElementById('search-phieunhap-product').value = '';
            renderPhieuNhapProducts(products);
            showToast('ƒê√£ t·∫£i l·∫°i danh s√°ch s·∫£n ph·∫©m', 'success');
        }

        function renderPhieuNhapProducts(data) {
            const container = document.getElementById('phieunhap-products');
            if (!container) return;

            if (!data || data.length === 0) {
                container.innerHTML = '<div class="empty-state">Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m</div>';
                return;
            }

            container.innerHTML = data.map(p => `
                <div class="product-card" onclick="addToPhieuNhapCart('${p.maHang}')">
                    <div class="product-card-name">${p.tenHang}</div>
                    <div class="product-card-code">${p.maHang}</div>
                    <span class="product-card-stock ${getStockClass(p.soluong)}">
                        T·ªìn kho: ${p.soluong} sp
                    </span>
                    <div class="product-card-price">Gi√° nh·∫≠p: ${formatCurrency(p.gianhap || 0)}</div>
                    <div class="product-card-price">Gi√° b√°n: ${formatCurrency(p.giaban || 0)}</div>
                    <button class="product-card-btn" onclick="event.stopPropagation(); addToPhieuNhapCart('${p.maHang}')">
                        Th√™m v√†o phi·∫øu
                    </button>
                </div>
            `).join('');
        }

        function filterPhieuNhapProducts() {
            const keyword = document.getElementById('search-phieunhap-product').value.toLowerCase();
            const filtered = products.filter(p =>
                p.maHang.toLowerCase().includes(keyword) ||
                p.tenHang.toLowerCase().includes(keyword)
            );
            renderPhieuNhapProducts(filtered);
        }

        function addToPhieuNhapCart(maHang) {
            const product = products.find(p => p.maHang === maHang);
            if (!product) {
                showToast('Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m', 'error');
                return;
            }

            const existingItem = phieuNhapCart.find(c => c.maHang === maHang);
            if (existingItem) {
                existingItem.quantity++;
            } else {
                phieuNhapCart.push({
                    id: product.id,
                    maHang: product.maHang,
                    name: product.tenHang,
                    price: product.gianhap || 0, // Gi√° nh·∫≠p
                    quantity: 1
                });
            }

            renderPhieuNhapCart();
            showToast(`ƒê√£ th√™m ${product.tenHang}`, 'success');
        }

        function updatePhieuNhapCartQty(key, delta) {
            const item = phieuNhapCart.find(c => (c.isNew ? c.tempId : c.maHang) === key);
            if (!item) return;

            item.quantity += delta;

            if (item.quantity <= 0) {
                if (item.isNew) {
                    phieuNhapCart = phieuNhapCart.filter(c => c.tempId !== key);
                } else {
                    phieuNhapCart = phieuNhapCart.filter(c => c.maHang !== key);
                }
            }

            renderPhieuNhapCart();
        }

        function updatePhieuNhapCartQtyInput(key, value) {
            const item = phieuNhapCart.find(c => (c.isNew ? c.tempId : c.maHang) === key);
            if (!item) return;

            const qty = parseInt(value) || 1;
            
            if (qty <= 0) {
                if (item.isNew) {
                    phieuNhapCart = phieuNhapCart.filter(c => c.tempId !== key);
                } else {
                    phieuNhapCart = phieuNhapCart.filter(c => c.maHang !== key);
                }
                renderPhieuNhapCart();
                return;
            }
            
            item.quantity = qty;
            renderPhieuNhapCart();
        }

        function validatePhieuNhapCartQty(key, input) {
            const item = phieuNhapCart.find(c => (c.isNew ? c.tempId : c.maHang) === key);
            if (!item) return;

            const qty = parseInt(input.value) || 1;
            
            if (qty < 1) {
                input.value = 1;
                item.quantity = 1;
            } else {
                item.quantity = qty;
            }

            renderPhieuNhapCart();
        }

        function removeFromPhieuNhapCart(key) {
            const item = phieuNhapCart.find(c => (c.isNew ? c.tempId : c.maHang) === key);
            if (item && item.isNew) {
                phieuNhapCart = phieuNhapCart.filter(c => c.tempId !== key);
            } else {
                phieuNhapCart = phieuNhapCart.filter(c => c.maHang !== key);
            }
            renderPhieuNhapCart();
        }

        function renderPhieuNhapCart() {
            const itemsContainer = document.getElementById('phieunhap-cart-items');
            const summaryContainer = document.getElementById('phieunhap-cart-summary');

            if (!itemsContainer || !summaryContainer) {
                console.warn('Cart containers not found, retrying...');
                // Retry sau 100ms n·∫øu element ch∆∞a t·ªìn t·∫°i
                setTimeout(() => renderPhieuNhapCart(), 100);
                return;
            }

            if (phieuNhapCart.length === 0) {
                itemsContainer.innerHTML = `<div class="cart-empty"><p>Ch∆∞a c√≥ s·∫£n ph·∫©m</p></div>`;
                summaryContainer.innerHTML = '';
                return;
            }

            itemsContainer.innerHTML = phieuNhapCart.map(item => {
                const itemKey = item.isNew ? item.tempId : item.maHang;
                const isNewBadge = item.isNew ? '<span style="background: #ff9800; color: white; padding: 2px 8px; border-radius: 4px; font-size: 10px; margin-left: 5px;">M·ªöI</span>' : '';
                // Escape c√°c k√Ω t·ª± ƒë·∫∑c bi·ªát trong t√™n s·∫£n ph·∫©m v√† key
                const safeName = (item.name || '').replace(/'/g, "&#39;").replace(/"/g, "&quot;");
                const safeKey = (itemKey || '').replace(/'/g, "&#39;").replace(/"/g, "&quot;");
                return `
                <div class="cart-item">
                    <div class="cart-item-info">
                        <div class="cart-item-name">${safeName} ${isNewBadge}</div>
                        <div class="cart-item-price">${formatCurrency(item.price)}</div>
                    </div>
                    <div class="cart-item-qty">
                        <input type="number" class="qty-input" value="${item.quantity}" min="1" 
                               onchange="updatePhieuNhapCartQtyInput('${safeKey}', this.value)" 
                               onblur="validatePhieuNhapCartQty('${safeKey}', this)"
                               style="width: 70px; padding: 8px; text-align: center; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 14px; font-weight: 600;">
                    </div>
                    <button class="cart-item-remove" onclick="removeFromPhieuNhapCart('${safeKey}')">‚úï</button>
                </div>
            `;
            }).join('');

            const subtotal = phieuNhapCart.reduce((sum, item) => sum + (item.price * item.quantity), 0);

            // L·ªçc nh√¢n vi√™n ch·ªâ hi·ªÉn th·ªã th·ªß kho v√† qu·∫£n l√Ω
            const allowedNhanVien = nhanvienList.filter(nv => {
                const tenVT = (nv.tenVT || '').toLowerCase();
                return tenVT.includes('qu·∫£n l√Ω') || tenVT.includes('quan ly') || 
                       tenVT.includes('th·ªß kho') || tenVT.includes('thu kho') ||
                       tenVT.includes('warehouse') || tenVT.includes('manager');
            });

            summaryContainer.innerHTML = `
                <div class="cart-summary">
                    <div class="form-group">
                        <label>Ng∆∞·ªùi Nh·∫≠p</label>
                        <select id="phieunhap-nhanvien-select">
                            <option value="">-- Ch·ªçn nh√¢n vi√™n --</option>
                            ${allowedNhanVien.map(nv => `<option value="${nv.id}">${nv.tenNV} (${nv.maNV})</option>`).join('')}
                        </select>
                        ${allowedNhanVien.length === 0 ? '<p style="font-size: 11px; color: #dc2626; margin-top: 5px;">Kh√¥ng c√≥ nh√¢n vi√™n th·ªß kho/qu·∫£n l√Ω</p>' : ''}
                    </div>

                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 6px;">
                            <span>üè¢</span>
                            <span>Nh√† Cung C·∫•p</span>
                        </label>
                        <div style="display: flex; gap: 8px;">
                            <select id="phieunhap-nhacungcap-select" style="flex: 1; padding: 10px 14px; border: 2px solid #e8e8e8; border-radius: 8px; font-size: 13px; transition: all 0.3s ease;"
                                    onfocus="this.style.borderColor='#ff9800'; this.style.boxShadow='0 0 0 3px rgba(255, 152, 0, 0.1)'"
                                    onblur="this.style.borderColor='#e8e8e8'; this.style.boxShadow='none'">
                                <option value="">-- Kh√¥ng ch·ªçn --</option>
                                ${nhacungcapList.map(ncc => `<option value="${ncc.id}">${ncc.tenNCC} (${ncc.maNCC})</option>`).join('')}
                            </select>
                            <button class="btn btn-primary btn-sm" onclick="openNewSupplierModal()" 
                                    style="padding: 10px 16px; font-size: 13px; font-weight: 600; background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); border: none; border-radius: 8px; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(255, 152, 0, 0.3);"
                                    onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(255, 152, 0, 0.4)'"
                                    onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(255, 152, 0, 0.3)'"
                                    title="Th√™m nh√† cung c·∫•p m·ªõi">
                                <span style="font-size: 16px; margin-right: 4px;">‚ûï</span>
                                <span>Th√™m</span>
                            </button>
                        </div>
                        <p style="font-size: 11px; color: #999; margin-top: 5px; display: flex; align-items: center; gap: 4px;">
                            <span>üí°</span>
                            <span>C√≥ th·ªÉ ƒë·ªÉ tr·ªëng n·∫øu kh√¥ng c√≥ nh√† cung c·∫•p</span>
                        </p>
                    </div>

                    <div class="cart-summary-row">
                        <span class="label">T·∫°m t√≠nh:</span>
                        <span class="value">${formatCurrency(subtotal)}</span>
                    </div>
                    <div class="cart-summary-row total">
                        <span>T·ªïng c·ªông:</span>
                        <span>${formatCurrency(subtotal)}</span>
                    </div>
                    
                    <button class="btn btn-success" style="width: 100%; margin-top: 15px;" onclick="createPhieuNhap()">
                        T·∫°o Phi·∫øu Nh·∫≠p
                    </button>
                    <button class="btn btn-outline" style="width: 100%; margin-top: 10px;" onclick="closeNewPhieuNhapSection()">
                        H·ªßy
                    </button>
                </div>
            `;
        }

        async function createPhieuNhap() {
            if (phieuNhapCart.length === 0) {
                showToast('Ch∆∞a c√≥ s·∫£n ph·∫©m n√†o trong phi·∫øu nh·∫≠p', 'error');
                return;
            }

            const selectedNVValue = document.getElementById('phieunhap-nhanvien-select').value;
            if (!selectedNVValue) {
                showToast('Vui l√≤ng ch·ªçn ng∆∞·ªùi nh·∫≠p', 'error');
                return;
            }

            try {
                const selectedNV = nhanvienList.find(nv => nv.id === parseInt(selectedNVValue));
                if (!selectedNV || !selectedNV.id) {
                    showToast('Kh√¥ng t√¨m th·∫•y nh√¢n vi√™n', 'error');
                    return;
                }

                // L·∫•y nh√† cung c·∫•p (n·∫øu c√≥)
                const selectedNCCValue = document.getElementById('phieunhap-nhacungcap-select')?.value || '';
                const idNCC = selectedNCCValue ? parseInt(selectedNCCValue) : null;

                // T·∫°o phi·∫øu nh·∫≠p
                const phieuNhapRes = await fetch(`${API_BASE}/phieunhap`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        idNV: selectedNV.id,
                        idNCC: idNCC
                    })
                });

                const phieuNhapResult = await phieuNhapRes.json();

                if (!phieuNhapResult.success) {
                    showToast(phieuNhapResult.message || 'L·ªói t·∫°o phi·∫øu nh·∫≠p', 'error');
                    return;
                }

                const idPN = phieuNhapResult.data.id;
                const maPN = phieuNhapResult.data.maPN;

                // T√°ch h√†ng h√≥a m·ªõi v√† h√†ng h√≥a c√≥ s·∫µn
                const newProducts = phieuNhapCart.filter(item => item.isNew === true);
                const existingProducts = phieuNhapCart.filter(item => !item.isNew);

                // 1. T·∫°o h√†ng h√≥a m·ªõi tr∆∞·ªõc (n·∫øu c√≥)
                if (newProducts.length > 0) {
                    showToast(`ƒêang t·∫°o ${newProducts.length} h√†ng h√≥a m·ªõi...`, 'info');
                    
                    for (const newItem of newProducts) {
                        try {
                            // T·∫°o h√†ng h√≥a m·ªõi
                            const createProductRes = await fetch(`${API_BASE}/hanghoa`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(newItem.newProductData)
                            });

                            const createProductResult = await createProductRes.json();

                            if (!createProductResult.success) {
                                throw new Error(createProductResult.message || 'L·ªói t·∫°o h√†ng h√≥a');
                            }

                            const newProduct = createProductResult.data;

                            // Th√™m v√†o chi ti·∫øt phi·∫øu nh·∫≠p
                            const detailData = {
                                idPN: idPN,
                                idHang: newProduct.id,
                                soluong: newItem.quantity,
                                dongia: newItem.price
                            };

                            const detailRes = await fetch(`${API_BASE}/chitietphieunhap`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(detailData)
                            });

                            const detailResult = await detailRes.json();
                            if (!detailResult.success) {
                                throw new Error(`L·ªói th√™m s·∫£n ph·∫©m ${newItem.name}: ${detailResult.message}`);
                            }
                        } catch (error) {
                            console.error('L·ªói t·∫°o h√†ng h√≥a m·ªõi:', error);
                            // Rollback: x√≥a phi·∫øu nh·∫≠p n·∫øu c√≥ l·ªói
                            await fetch(`${API_BASE}/phieunhap/${idPN}`, { method: 'DELETE' });
                            showToast(`L·ªói: ${error.message}`, 'error');
                            return;
                        }
                    }
                }

                // 2. Th√™m h√†ng h√≥a c√≥ s·∫µn v√†o phi·∫øu nh·∫≠p
                for (const item of existingProducts) {
                    const detailData = {
                        idPN: idPN,
                        idHang: item.id,
                        soluong: item.quantity,
                        dongia: item.price
                    };

                    const detailRes = await fetch(`${API_BASE}/chitietphieunhap`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(detailData)
                    });

                    const detailResult = await detailRes.json();
                    if (!detailResult.success) {
                        showToast(`L·ªói th√™m s·∫£n ph·∫©m ${item.name}: ${detailResult.message}`, 'error');
                        // Rollback: x√≥a phi·∫øu nh·∫≠p n·∫øu c√≥ l·ªói
                        await fetch(`${API_BASE}/phieunhap/${idPN}`, { method: 'DELETE' });
                        return;
                    }
                }

                // Reload danh s√°ch phi·∫øu nh·∫≠p v√† quay l·∫°i trang danh s√°ch
                await loadProducts(); // Reload ƒë·ªÉ c·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng
                showToast(`T·∫°o phi·∫øu nh·∫≠p ${maPN} th√†nh c√¥ng! ${newProducts.length > 0 ? `ƒê√£ t·∫°o ${newProducts.length} h√†ng h√≥a m·ªõi.` : ''}`, 'success');
                
                // Clear d·ªØ li·ªáu cart v√† danh s√°ch h√†ng h√≥a m·ªõi
                phieuNhapCart = [];
                newProductsList = [];
                
                // Quay l·∫°i trang danh s√°ch phi·∫øu nh·∫≠p
                renderPhieuNhap();
            } catch (error) {
                console.error('Error creating phieu nhap:', error);
                showToast('L·ªói: ' + error.message, 'error');
            }
        }

        // ==================== T·∫†O H√ÄNG H√ìA M·ªöI ====================
        function openNewProductModal() {
            const modal = document.getElementById('new-product-modal');
            const typeSelect = document.getElementById('new-product-type');
            
            if (!modal) {
                console.error('Modal kh√¥ng t·ªìn t·∫°i');
                showToast('L·ªói: Kh√¥ng t√¨m th·∫•y modal', 'error');
                return;
            }
            
            if (!typeSelect) {
                console.error('Select kh√¥ng t·ªìn t·∫°i');
                showToast('L·ªói: Kh√¥ng t√¨m th·∫•y select ph√¢n lo·∫°i', 'error');
                return;
            }
            
            // C·∫≠p nh·∫≠t danh s√°ch ph√¢n lo·∫°i s·∫£n ph·∫©m
            if (phanLoaiSanPhamList && phanLoaiSanPhamList.length > 0) {
                typeSelect.innerHTML = '<option value="">-- Ch·ªçn ph√¢n lo·∫°i --</option>' +
                    phanLoaiSanPhamList.map(pl => `<option value="${pl.id}">${pl.tenPLSP}</option>`).join('');
            } else {
                typeSelect.innerHTML = '<option value="">-- ƒêang t·∫£i ph√¢n lo·∫°i --</option>';
                showToast('ƒêang t·∫£i danh s√°ch ph√¢n lo·∫°i s·∫£n ph·∫©m...', 'info');
                // Th·ª≠ load l·∫°i ph√¢n lo·∫°i s·∫£n ph·∫©m
                loadPhanLoaiSanPham();
            }
            
            modal.classList.add('active');
            console.log('Modal ƒë√£ m·ªü, ph√¢n lo·∫°i:', phanLoaiSanPhamList.length);
        }
        
        async function loadPhanLoaiSanPham() {
            try {
                const response = await fetch(`${API_BASE}/phanloaisanpham`);
                const result = await response.json();
                if (result.success) {
                    phanLoaiSanPhamList = result.data;
                    const typeSelect = document.getElementById('new-product-type');
                    if (typeSelect) {
                        typeSelect.innerHTML = '<option value="">-- Ch·ªçn ph√¢n lo·∫°i --</option>' +
                            phanLoaiSanPhamList.map(pl => `<option value="${pl.id}">${pl.tenPLSP}</option>`).join('');
                    }
                }
            } catch (error) {
                console.error('L·ªói load ph√¢n lo·∫°i s·∫£n ph·∫©m:', error);
            }
        }

        function closeNewProductModal() {
            const modal = document.getElementById('new-product-modal');
            if (modal) {
                modal.classList.remove('active');
                const form = document.getElementById('new-product-form');
                if (form) form.reset();
            }
        }

        async function saveNewProduct(event) {
            event.preventDefault();
            console.log('B·∫Øt ƒë·∫ßu l∆∞u h√†ng h√≥a m·ªõi');
            
            const tenHang = document.getElementById('new-product-name')?.value.trim();
            const idPLSP = document.getElementById('new-product-type')?.value;
            const gianhap = parseFloat(document.getElementById('new-product-gianhap')?.value) || 0;
            const giaban = parseFloat(document.getElementById('new-product-giaban')?.value) || 0;
            const soluong = parseInt(document.getElementById('new-product-soluong')?.value) || 0;
            const tonKhoToiThieu = parseInt(document.getElementById('new-product-tonkho')?.value) || 10;

            console.log('D·ªØ li·ªáu form:', { tenHang, idPLSP, gianhap, giaban, soluong, tonKhoToiThieu });

            if (!tenHang || !idPLSP) {
                showToast('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin b·∫Øt bu·ªôc (T√™n h√†ng v√† Ph√¢n lo·∫°i)', 'error');
                return;
            }

            if (gianhap <= 0 || giaban <= 0) {
                showToast('Gi√° nh·∫≠p v√† gi√° b√°n ph·∫£i l·ªõn h∆°n 0', 'error');
                return;
            }

            try {
                const productData = {
                    tenHang,
                    idPLSP: parseInt(idPLSP),
                    gianhap,
                    giaban,
                    soluong,
                    tonKhoToiThieu
                };
                
                console.log('G·ª≠i d·ªØ li·ªáu:', productData);
                
                const response = await fetch(`${API_BASE}/hanghoa`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(productData)
                });

                console.log('Response status:', response.status);
                const result = await response.json();
                console.log('Response data:', result);

                if (result.success) {
                    // Reload products
                    await loadProducts();
                    
                    // N·∫øu ƒëang ·ªü trang t·∫°o phi·∫øu nh·∫≠p, reload l·∫°i danh s√°ch s·∫£n ph·∫©m
                    if (currentPage === 'create-phieunhap') {
                        renderPhieuNhapProducts(products);
                    }
                    
                    closeNewProductModal();
                    showToast(`ƒê√£ th√™m h√†ng h√≥a m·ªõi: ${result.data.maHang}`, 'success');
                    
                    // T·ª± ƒë·ªông th√™m v√†o gi·ªè h√†ng phi·∫øu nh·∫≠p n·∫øu ƒëang ·ªü trang t·∫°o phi·∫øu nh·∫≠p
                    if (currentPage === 'create-phieunhap' && result.data) {
                        const newProduct = result.data;
                        // ƒê·ª£i m·ªôt ch√∫t ƒë·ªÉ ƒë·∫£m b·∫£o products ƒë√£ ƒë∆∞·ª£c reload
                        setTimeout(() => {
                            addToPhieuNhapCart(newProduct.maHang);
                        }, 500);
                    }
                } else {
                    showToast(result.message || 'L·ªói th√™m h√†ng h√≥a', 'error');
                    console.error('L·ªói t·ª´ server:', result);
                }
            } catch (error) {
                console.error('L·ªói khi g·ªçi API:', error);
                showToast('L·ªói: ' + error.message, 'error');
            }
        }

        // ==================== TR·∫¢ H√ÄNG ====================
        async function openTraHangModal(maHD) {
            try {
                // 1. Ki·ªÉm tra d·ªØ li·ªáu ƒë·∫ßu v√†o
                const order = ordersList.find(o => o.maHD === maHD);
                if (!order || !order.id) {
                    showToast('Kh√¥ng t√¨m th·∫•y h√≥a ƒë∆°n: ' + maHD, 'error');
                    return;
                }

                // 2. Ki·ªÉm tra ph·∫ßn t·ª≠ HTML c√≥ t·ªìn t·∫°i kh√¥ng
                const modal = document.getElementById('return-product-modal');
                const body = document.getElementById('return-product-body');
                
                if (!modal || !body) {
                    console.error('L·ªói: Thi·∫øu ID return-product-modal ho·∫∑c return-product-body trong HTML');
                    showToast('L·ªói giao di·ªán h·ªá th·ªëng!', 'error');
                    return;
                }

                // 3. G·ªçi API l·∫•y chi ti·∫øt h√≥a ƒë∆°n
                const response = await fetch(`${API_BASE}/chitiethd/${order.id}`);
                const result = await response.json();

                if (!result.success || !result.data || result.data.length === 0) {
                    showToast('Kh√¥ng c√≥ s·∫£n ph·∫©m n√†o c√≥ th·ªÉ tr·∫£!', 'error');
                    return;
                }

                const details = result.data;

                // 4. Render giao di·ªán v√†o Modal
                body.innerHTML = `
                    <div style="padding: 20px;">
                        <div style="background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                            <h4 style="margin: 0; color: #e65100; font-size: 16px;">üì¶ Tr·∫£ H√†ng - H√≥a ƒê∆°n: ${maHD}</h4>
                            <p style="margin: 5px 0 0 0; color: #666; font-size: 12px;">Nh·∫≠p s·ªë l∆∞·ª£ng s·∫£n ph·∫©m kh√°ch mu·ªën tr·∫£ l·∫°i</p>
                        </div>
                        
                        <div id="return-items-list" style="max-height: 400px; overflow-y: auto; margin-bottom: 20px;">
                            ${details.map((item, index) => {
                                const maxQty = item.soluong;
                                const itemID = item.idHang;
                                const tenHang = item.tenHang || 'S·∫£n ph·∫©m ' + (index + 1);
                                
                                return `
                                <div class="return-item-card" style="padding: 15px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 10px; background: #fff;">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div style="flex: 1;">
                                            <strong style="display: block; color: #1a2b48;">${tenHang}</strong>
                                            <small style="color: #666;">ƒê√£ mua: <b>${maxQty}</b> | ƒê∆°n gi√°: ${formatCurrency(item.dongia)}</small>
                                        </div>
                                        <div style="display: flex; align-items: center; gap: 8px;">
                                            <input type="number" 
                                                class="input-return-qty" 
                                                data-idhang="${itemID}" 
                                                data-max="${maxQty}" 
                                                data-price="${item.dongia}"
                                                value="0" min="0" max="${maxQty}"
                                                style="width: 70px; padding: 5px; border: 2px solid #ff9800; border-radius: 4px; text-align: center;">
                                            <span style="font-size: 12px; color: #999;">/ ${maxQty}</span>
                                        </div>
                                    </div>
                                </div>`;
                            }).join('')}
                        </div>

                        <div style="background: #f9f9f9; padding: 15px; border-radius: 8px; border-left: 4px solid #ff9800;">
                            <div style="display: flex; justify-content: space-between;">
                                <span>T·ªïng ti·ªÅn ho√†n l·∫°i:</span>
                                <strong id="display-total-refund" style="color: #e65100; font-size: 18px;">0ƒë</strong>
                            </div>
                        </div>

                        <div class="form-actions" style="margin-top: 20px; display: flex; justify-content: flex-end; gap: 10px;">
                            <button type="button" class="btn btn-outline" onclick="closeReturnProductModal()">ƒê√≥ng</button>
                            <button type="button" class="btn btn-warning" id="submit-return-btn" disabled onclick="submitReturnProduct('${maHD}')">
                                X√°c nh·∫≠n tr·∫£ h√†ng
                            </button>
                        </div>
                    </div>
                `;

                // 5. Hi·ªÉn th·ªã Section ngay l·∫≠p t·ª©c
                const section = document.getElementById('return-product-section');
                if (!section) {
                    showToast('Kh√¥ng t√¨m th·∫•y section tr·∫£ h√†ng', 'error');
                    return;
                }
                section.style.display = 'block';
                section.scrollTop = 0;

                // 6. G√°n s·ª± ki·ªán t√≠nh to√°n t·ª± ƒë·ªông khi nh·∫≠p s·ªë l∆∞·ª£ng
                const returnInputs = body.querySelectorAll('.input-return-qty');
                returnInputs.forEach(input => {
                    input.addEventListener('input', () => {
                        let totalRefund = 0;
                        let totalQty = 0;

                        returnInputs.forEach(inp => {
                            const qty = parseInt(inp.value) || 0;
                            const price = parseFloat(inp.dataset.price) || 0;
                            totalRefund += qty * price;
                            totalQty += qty;
                        });

                        // C·∫≠p nh·∫≠t giao di·ªán
                        document.getElementById('display-total-refund').innerText = formatCurrency(totalRefund);
                        document.getElementById('submit-return-btn').disabled = (totalQty <= 0);
                    });
                });

            } catch (error) {
                console.error('L·ªói th·ª±c thi:', error);
                showToast('Kh√¥ng th·ªÉ m·ªü ch·ª©c nƒÉng tr·∫£ h√†ng!', 'error');
            }
        }

        function closeReturnProductModal() {
            closeReturnProductSection();
        }
        
        function closeReturnProductSection() {
            const section = document.getElementById('return-product-section');
            if (section) {
                section.style.display = 'none';
            }
        }
        
        function updateReturnQty(idHang, maxQty, value) {
            const qty = parseInt(value) || 0;
            if (qty < 0) {
                document.getElementById(`return-qty-${idHang}`).value = 0;
                return;
            }
            if (qty > maxQty) {
                document.getElementById(`return-qty-${idHang}`).value = maxQty;
                return;
            }
            
            // L·∫•y th√¥ng tin s·∫£n ph·∫©m ƒë·ªÉ t√≠nh ti·ªÅn
            const detail = window.currentReturnDetails ? window.currentReturnDetails.find(d => d.idHang === idHang) : null;
            if (detail) {
                const infoDiv = document.getElementById(`return-info-${idHang}`);
                const qtyDisplay = document.getElementById(`return-qty-display-${idHang}`);
                const amountDisplay = document.getElementById(`return-amount-${idHang}`);
                
                if (qty > 0) {
                    infoDiv.style.display = 'block';
                    qtyDisplay.textContent = qty;
                    const amount = qty * parseFloat(detail.dongia || 0);
                    amountDisplay.textContent = formatCurrency(amount);
                } else {
                    infoDiv.style.display = 'none';
                }
            }
            
            // C·∫≠p nh·∫≠t t·ªïng s·ªë l∆∞·ª£ng tr·∫£
            updateTotalReturnQty();
        }
        
        function updateTotalReturnQty() {
            const details = window.currentReturnDetails || [];
            let totalQty = 0;
            let hasReturn = false;
            
            details.forEach(item => {
                const input = document.getElementById(`return-qty-${item.idHang}`);
                if (input) {
                    const qty = parseInt(input.value) || 0;
                    if (qty > 0) {
                        totalQty += qty;
                        hasReturn = true;
                    }
                }
            });
            
            const totalQtyEl = document.getElementById('total-return-qty');
            if (totalQtyEl) {
                totalQtyEl.textContent = totalQty;
            }
            
            const submitBtn = document.getElementById('submit-return-btn');
            if (submitBtn) {
                submitBtn.disabled = !hasReturn;
                if (hasReturn) {
                    submitBtn.style.opacity = '1';
                    submitBtn.style.cursor = 'pointer';
                } else {
                    submitBtn.style.opacity = '0.5';
                    submitBtn.style.cursor = 'not-allowed';
                }
            }
        }

        async function submitReturnProduct(maHD) {
            try {
                const order = ordersList.find(o => o.maHD === maHD);
                if (!order || !order.id) {
                    showToast('Kh√¥ng t√¨m th·∫•y h√≥a ƒë∆°n', 'error');
                    return;
                }
                
                const idHD = order.id;
                const body = document.getElementById('return-product-body');
                if (!body) {
                    showToast('L·ªói: Kh√¥ng t√¨m th·∫•y form tr·∫£ h√†ng', 'error');
                    return;
                }
                
                // L·∫•y t·∫•t c·∫£ input c√≥ class .input-return-qty
                const returnInputs = body.querySelectorAll('.input-return-qty');
                const items = [];
                
                returnInputs.forEach(input => {
                    const qty = parseInt(input.value) || 0;
                    const idHang = parseInt(input.dataset.idhang);
                    const maxQty = parseInt(input.dataset.max) || 0;
                    
                    if (qty > 0) {
                        if (qty > maxQty) {
                            showToast(`S·ªë l∆∞·ª£ng tr·∫£ (${qty}) v∆∞·ª£t qu√° s·ªë l∆∞·ª£ng ƒë√£ mua (${maxQty})`, 'error');
                            return;
                        }
                        items.push({
                            idHang: idHang,
                            soluong: qty
                        });
                    }
                });
                
                if (items.length === 0) {
                    showToast('Vui l√≤ng nh·∫≠p s·ªë l∆∞·ª£ng s·∫£n ph·∫©m c·∫ßn tr·∫£', 'error');
                    return;
                }
                
                // X√°c nh·∫≠n tr∆∞·ªõc khi tr·∫£
                const confirmMsg = `X√°c nh·∫≠n tr·∫£ ${items.length} lo·∫°i s·∫£n ph·∫©m?\n\n` +
                    items.map(item => {
                        // T√¨m t√™n s·∫£n ph·∫©m t·ª´ input
                        const input = Array.from(returnInputs).find(inp => parseInt(inp.dataset.idhang) === item.idHang);
                        const card = input ? input.closest('.return-item-card') : null;
                        const productName = card ? card.querySelector('strong').textContent : `S·∫£n ph·∫©m ID ${item.idHang}`;
                        return `- ${productName}: ${item.soluong} s·∫£n ph·∫©m`;
                    }).join('\n');
                
                if (!confirm(confirmMsg)) {
                    return;
                }
                
                showToast('ƒêang x·ª≠ l√Ω tr·∫£ h√†ng...', 'info');
                
                const returnRes = await fetch(`${API_BASE}/hoadon/${idHD}/tra-hang`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ items })
                });
                
                const returnResult = await returnRes.json();
                
                if (returnResult.success) {
                    showToast('Tr·∫£ h√†ng th√†nh c√¥ng! S·ªë l∆∞·ª£ng ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t v√†o kho.', 'success');
                    closeReturnProductModal();
                    await loadOrders();
                    await loadProducts(); // Reload s·∫£n ph·∫©m ƒë·ªÉ c·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng trong kho
                } else {
                    showToast(returnResult.message || 'L·ªói tr·∫£ h√†ng', 'error');
                }
            } catch (error) {
                console.error('L·ªói submitReturnProduct:', error);
                showToast('L·ªói: ' + error.message, 'error');
            }
        }

        // ==================== ƒê·ªîI H√ÄNG ====================
        async function openDoiHangModal(maHD) {
            try {
                const order = ordersList.find(o => o.maHD === maHD);
                if (!order || !order.id) {
                    showToast('Kh√¥ng t√¨m th·∫•y h√≥a ƒë∆°n', 'error');
                    return;
                }
                
                const idHD = order.id;
                const response = await fetch(`${API_BASE}/chitiethd/${idHD}`);
                const result = await response.json();
                
                if (!result.success || !result.data.length) {
                    showToast('Kh√¥ng c√≥ chi ti·∫øt h√≥a ƒë∆°n', 'error');
                    return;
                }
                
                const details = result.data;
                const body = document.getElementById('exchange-product-body');
                if (!body) {
                    console.error('exchange-product-body element not found!');
                    showToast('L·ªói: Kh√¥ng t√¨m th·∫•y ph·∫ßn t·ª≠ hi·ªÉn th·ªã ƒë·ªïi h√†ng', 'error');
                    return;
                }
                console.log('Setting exchange-product-body innerHTML, details count:', details.length);
                
                try {
                    body.innerHTML = `
                        <div style="padding: 20px;">
                            <div style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                                <h4 style="margin: 0; color: #1976d2; font-size: 16px;">üîÑ ƒê·ªïi H√†ng - H√≥a ƒê∆°n: ${maHD}</h4>
                                <p style="margin: 5px 0 0 0; color: #666; font-size: 12px;">Ch·ªçn s·∫£n ph·∫©m c·∫ßn ƒë·ªïi v√† s·∫£n ph·∫©m thay th·∫ø</p>
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 20px;">
                                <label style="font-weight: 600; color: #1a2b48; margin-bottom: 8px; display: block;">üì¶ Ch·ªçn s·∫£n ph·∫©m c·∫ßn ƒë·ªïi:</label>
                                <select id="exchange-old-product" class="form-group" style="width: 100%; padding: 12px; border: 2px solid #e8e8e8; border-radius: 8px; font-size: 14px;" onchange="loadExchangeNewProduct()">
                                    <option value="">-- Ch·ªçn s·∫£n ph·∫©m c·∫ßn ƒë·ªïi --</option>
                                    ${details.map(item => {
                                        const tenHang = (item.tenHang || item.maHang || '').replace(/'/g, "&#39;").replace(/"/g, "&quot;");
                                        const maHang = (item.maHang || '').replace(/'/g, "&#39;").replace(/"/g, "&quot;");
                                        const dongia = parseFloat(item.dongia) || 0;
                                        const soluong = parseInt(item.soluong) || 0;
                                        return `
                                    <option value="${item.idHang}" data-qty="${soluong}" data-name="${tenHang}" data-price="${dongia}">
                                        ${tenHang} (${maHang}) - ƒê√£ b√°n: ${soluong} - Gi√°: ${formatCurrency(dongia)}
                                    </option>
                                `;
                                    }).join('')}
                                </select>
                            </div>
                        
                        <div id="old-product-info" style="display: none; padding: 15px; background: #fff3e0; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #ff9800;">
                            <p style="margin: 0; font-size: 13px; color: #e65100;">
                                <strong>S·∫£n ph·∫©m c≈©:</strong> <span id="old-product-name"></span><br>
                                <strong>S·ªë l∆∞·ª£ng c√≥ th·ªÉ ƒë·ªïi:</strong> <span id="old-product-max-qty"></span>
                            </p>
                        </div>
                        
                        <div class="form-group" style="margin-bottom: 20px;">
                            <label style="font-weight: 600; color: #1a2b48; margin-bottom: 8px; display: block;">üî¢ S·ªë l∆∞·ª£ng ƒë·ªïi:</label>
                            <input type="number" id="exchange-qty" min="1" value="1" 
                                   style="width: 100%; padding: 12px; border: 2px solid #e8e8e8; border-radius: 8px; font-size: 14px; text-align: center;"
                                   onchange="updateExchangeQty()">
                            <p style="font-size: 11px; color: #666; margin: 5px 0 0 0;">T·ªëi ƒëa: <span id="exchange-max-qty">1</span> s·∫£n ph·∫©m</p>
                        </div>
                        
                        <div class="form-group" style="margin-bottom: 20px;">
                            <label style="font-weight: 600; color: #1a2b48; margin-bottom: 8px; display: block;">‚ú® Ch·ªçn s·∫£n ph·∫©m m·ªõi:</label>
                            <select id="exchange-new-product" class="form-group" style="width: 100%; padding: 12px; border: 2px solid #e8e8e8; border-radius: 8px; font-size: 14px;" onchange="updateExchangeNewProduct()">
                                <option value="">-- Ch·ªçn s·∫£n ph·∫©m m·ªõi --</option>
                                ${products.filter(p => p.soluong > 0).map(p => `
                                    <option value="${p.id}" data-name="${p.tenHang}" data-stock="${p.soluong}" data-price="${p.giaban || p.gianhap || 0}">
                                        ${p.tenHang} (${p.maHang}) - C√≤n: ${p.soluong} - Gi√°: ${formatCurrency(p.giaban || p.gianhap || 0)}
                                    </option>
                                `).join('')}
                            </select>
                        </div>
                        
                        <div id="new-product-info" style="display: none; padding: 15px; background: #e8f5e9; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #4caf50;">
                            <p style="margin: 0; font-size: 13px; color: #2e7d32;">
                                <strong>S·∫£n ph·∫©m m·ªõi:</strong> <span id="new-product-name"></span><br>
                                <strong>T·ªìn kho:</strong> <span id="new-product-stock"></span> s·∫£n ph·∫©m<br>
                                <strong>Gi√°:</strong> <span id="new-product-price"></span>
                            </p>
                        </div>
                        
                        <div id="exchange-summary" style="display: none; padding: 15px; background: #f5f5f5; border-radius: 8px; margin-bottom: 15px;">
                            <h5 style="margin: 0 0 10px 0; color: #1a2b48; font-size: 14px;">üìä T√≥m t·∫Øt ƒë·ªïi h√†ng:</h5>
                            <div style="font-size: 12px; color: #666;">
                                <p style="margin: 5px 0;"><strong>Tr·∫£ v·ªÅ kho:</strong> <span id="summary-return"></span></p>
                                <p style="margin: 5px 0;"><strong>L·∫•y t·ª´ kho:</strong> <span id="summary-take"></span></p>
                                <p style="margin: 5px 0;"><strong>Ch√™nh l·ªách gi√°:</strong> <span id="summary-diff"></span></p>
                            </div>
                        </div>
                        
                        <div class="form-actions">
                            <button type="button" class="btn btn-outline" onclick="closeExchangeProductModal()">H·ªßy</button>
                            <button type="button" class="btn btn-primary" onclick="submitExchangeProduct('${maHD}')" id="submit-exchange-btn" disabled>
                                <span style="margin-right: 5px;">üîÑ</span>X√°c nh·∫≠n ƒë·ªïi h√†ng
                            </button>
                        </div>
                    </div>
                `;
                    console.log('Exchange product body innerHTML set successfully');
                } catch (innerError) {
                    console.error('Error setting exchange-product-body innerHTML:', innerError);
                    showToast('L·ªói khi t·∫°o giao di·ªán ƒë·ªïi h√†ng: ' + innerError.message, 'error');
                    return;
                }
                
                // Hi·ªÉn th·ªã Section
                const section = document.getElementById('exchange-product-section');
                if (!section) {
                    showToast('Kh√¥ng t√¨m th·∫•y section ƒë·ªïi h√†ng', 'error');
                    return;
                }
                section.style.display = 'block';
                section.scrollTop = 0;
            } catch (error) {
                console.error('Error in openDoiHangModal:', error);
                showToast('L·ªói: ' + error.message, 'error');
            }
        }

        function loadExchangeNewProduct() {
            const oldProductSelect = document.getElementById('exchange-old-product');
            const qtyInput = document.getElementById('exchange-qty');
            const maxQtyEl = document.getElementById('exchange-max-qty');
            const oldProductInfo = document.getElementById('old-product-info');
            const oldProductName = document.getElementById('old-product-name');
            const oldProductMaxQty = document.getElementById('old-product-max-qty');
            
            if (oldProductSelect && qtyInput) {
                const selectedOption = oldProductSelect.options[oldProductSelect.selectedIndex];
                if (selectedOption && selectedOption.value) {
                    const maxQty = parseInt(selectedOption.dataset.qty) || 1;
                    const productName = selectedOption.dataset.name || '';
                    
                    qtyInput.max = maxQty;
                    qtyInput.value = Math.min(parseInt(qtyInput.value) || 1, maxQty);
                    if (maxQtyEl) maxQtyEl.textContent = maxQty;
                    
                    if (oldProductInfo) {
                        oldProductInfo.style.display = 'block';
                        if (oldProductName) oldProductName.textContent = productName;
                        if (oldProductMaxQty) oldProductMaxQty.textContent = maxQty + ' s·∫£n ph·∫©m';
                    }
                } else {
                    if (oldProductInfo) oldProductInfo.style.display = 'none';
                }
            }
            updateExchangeSummary();
        }
        
        function updateExchangeNewProduct() {
            const newProductSelect = document.getElementById('exchange-new-product');
            const newProductInfo = document.getElementById('new-product-info');
            const newProductName = document.getElementById('new-product-name');
            const newProductStock = document.getElementById('new-product-stock');
            const newProductPrice = document.getElementById('new-product-price');
            
            if (newProductSelect) {
                const selectedOption = newProductSelect.options[newProductSelect.selectedIndex];
                if (selectedOption && selectedOption.value) {
                    const productName = selectedOption.dataset.name || '';
                    const stock = parseInt(selectedOption.dataset.stock) || 0;
                    const price = parseFloat(selectedOption.dataset.price) || 0;
                    
                    if (newProductInfo) {
                        newProductInfo.style.display = 'block';
                        if (newProductName) newProductName.textContent = productName;
                        if (newProductStock) newProductStock.textContent = stock + ' s·∫£n ph·∫©m';
                        if (newProductPrice) newProductPrice.textContent = formatCurrency(price);
                    }
                } else {
                    if (newProductInfo) newProductInfo.style.display = 'none';
                }
            }
            updateExchangeSummary();
        }
        
        function updateExchangeQty() {
            const qtyInput = document.getElementById('exchange-qty');
            const oldProductSelect = document.getElementById('exchange-old-product');
            
            if (qtyInput && oldProductSelect) {
                const selectedOption = oldProductSelect.options[oldProductSelect.selectedIndex];
                if (selectedOption && selectedOption.value) {
                    const maxQty = parseInt(selectedOption.dataset.qty) || 1;
                    const qty = parseInt(qtyInput.value) || 1;
                    
                    if (qty > maxQty) {
                        qtyInput.value = maxQty;
                        showToast(`S·ªë l∆∞·ª£ng t·ªëi ƒëa l√† ${maxQty}`, 'warning');
                    }
                    if (qty < 1) {
                        qtyInput.value = 1;
                    }
                }
            }
            updateExchangeSummary();
        }
        
        function updateExchangeSummary() {
            const oldProductSelect = document.getElementById('exchange-old-product');
            const newProductSelect = document.getElementById('exchange-new-product');
            const qtyInput = document.getElementById('exchange-qty');
            const summaryDiv = document.getElementById('exchange-summary');
            const submitBtn = document.getElementById('submit-exchange-btn');
            
            if (!oldProductSelect || !newProductSelect || !qtyInput) return;
            
            const oldOption = oldProductSelect.options[oldProductSelect.selectedIndex];
            const newOption = newProductSelect.options[newProductSelect.selectedIndex];
            const qty = parseInt(qtyInput.value) || 0;
            
            if (oldOption && oldOption.value && newOption && newOption.value && qty > 0) {
                const oldName = oldOption.dataset.name || '';
                const oldPrice = parseFloat(oldOption.dataset.price) || 0;
                const newName = newOption.dataset.name || '';
                const newPrice = parseFloat(newOption.dataset.price) || 0;
                const newStock = parseInt(newOption.dataset.stock) || 0;
                
                // Ki·ªÉm tra t·ªìn kho
                if (qty > newStock) {
                    if (summaryDiv) summaryDiv.style.display = 'none';
                    if (submitBtn) {
                        submitBtn.disabled = true;
                        submitBtn.style.opacity = '0.5';
                    }
                    showToast(`S·∫£n ph·∫©m m·ªõi ch·ªâ c√≤n ${newStock} s·∫£n ph·∫©m trong kho`, 'error');
                    return;
                }
                
                if (summaryDiv) {
                    summaryDiv.style.display = 'block';
                    const summaryReturn = document.getElementById('summary-return');
                    const summaryTake = document.getElementById('summary-take');
                    const summaryDiff = document.getElementById('summary-diff');
                    
                    if (summaryReturn) summaryReturn.textContent = `${qty} x ${oldName} (${formatCurrency(oldPrice)})`;
                    if (summaryTake) summaryTake.textContent = `${qty} x ${newName} (${formatCurrency(newPrice)})`;
                    
                    const diff = (newPrice - oldPrice) * qty;
                    if (summaryDiff) {
                        summaryDiff.textContent = formatCurrency(Math.abs(diff));
                        summaryDiff.style.color = diff >= 0 ? '#dc2626' : '#059669';
                    }
                }
                
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.style.opacity = '1';
                    submitBtn.style.cursor = 'pointer';
                }
            } else {
                if (summaryDiv) summaryDiv.style.display = 'none';
                if (submitBtn) {
                    submitBtn.disabled = true;
                    submitBtn.style.opacity = '0.5';
                }
            }
        }

        function closeExchangeProductModal() {
            closeExchangeProductSection();
        }
        
        function closeExchangeProductSection() {
            const section = document.getElementById('exchange-product-section');
            if (section) {
                section.style.display = 'none';
            }
        }

        async function submitExchangeProduct(maHD) {
            try {
                const order = ordersList.find(o => o.maHD === maHD);
                if (!order || !order.id) {
                    showToast('Kh√¥ng t√¨m th·∫•y h√≥a ƒë∆°n', 'error');
                    return;
                }
                
                const idHD = order.id;
                const idHangCu = document.getElementById('exchange-old-product').value;
                const idHangMoi = document.getElementById('exchange-new-product').value;
                const soluong = parseInt(document.getElementById('exchange-qty').value);
                
                if (!idHangCu || !idHangMoi || !soluong || soluong <= 0) {
                    showToast('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin', 'error');
                    return;
                }
                
                // L·∫•y th√¥ng tin s·∫£n ph·∫©m ƒë·ªÉ hi·ªÉn th·ªã x√°c nh·∫≠n
                const oldOption = document.getElementById('exchange-old-product').options[document.getElementById('exchange-old-product').selectedIndex];
                const newOption = document.getElementById('exchange-new-product').options[document.getElementById('exchange-new-product').selectedIndex];
                const oldName = oldOption.dataset.name || '';
                const newName = newOption.dataset.name || '';
                const newStock = parseInt(newOption.dataset.stock) || 0;
                
                if (soluong > newStock) {
                    showToast(`S·∫£n ph·∫©m m·ªõi ch·ªâ c√≤n ${newStock} s·∫£n ph·∫©m trong kho`, 'error');
                    return;
                }
                
                // X√°c nh·∫≠n tr∆∞·ªõc khi ƒë·ªïi
                const confirmMsg = `X√°c nh·∫≠n ƒë·ªïi h√†ng?\n\n` +
                    `S·∫£n ph·∫©m c≈©: ${oldName}\n` +
                    `S·∫£n ph·∫©m m·ªõi: ${newName}\n` +
                    `S·ªë l∆∞·ª£ng: ${soluong} s·∫£n ph·∫©m\n\n` +
                    `H·ªá th·ªëng s·∫Ω:\n` +
                    `- Tr·∫£ ${soluong} s·∫£n ph·∫©m c≈© v√†o kho\n` +
                    `- L·∫•y ${soluong} s·∫£n ph·∫©m m·ªõi t·ª´ kho\n` +
                    `- C·∫≠p nh·∫≠t h√≥a ƒë∆°n`;
                
                if (!confirm(confirmMsg)) {
                    return;
                }
                
                showToast('ƒêang x·ª≠ l√Ω ƒë·ªïi h√†ng...', 'info');
                
                const exchangeRes = await fetch(`${API_BASE}/hoadon/${idHD}/doi-hang`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ idHangCu: parseInt(idHangCu), idHangMoi: parseInt(idHangMoi), soluong })
                });
                
                const exchangeResult = await exchangeRes.json();
                
                if (exchangeResult.success) {
                    showToast('ƒê·ªïi h√†ng th√†nh c√¥ng! H√≥a ƒë∆°n v√† s·ªë l∆∞·ª£ng kho ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t.', 'success');
                    closeExchangeProductModal();
                    await loadOrders();
                    await loadProducts(); // Reload s·∫£n ph·∫©m ƒë·ªÉ c·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng trong kho
                } else {
                    showToast(exchangeResult.message || 'L·ªói ƒë·ªïi h√†ng', 'error');
                }
            } catch (error) {
                showToast('L·ªói: ' + error.message, 'error');
            }
        }

        // ==================== NH√Ä CUNG C·∫§P ====================
        function openNewSupplierModal() {
            // M·ªü section popup thay v√¨ modal
            openNewSupplierSection();
        }
        
        function openNewSupplierSection() {
            const section = document.getElementById('new-supplier-section');
            if (section) {
                section.style.display = 'block';
                section.scrollTop = 0;
                // Auto focus v√†o input ƒë·∫ßu ti√™n
                setTimeout(() => {
                    const firstInput = document.getElementById('new-supplier-name-section');
                    if (firstInput) {
                        firstInput.focus();
                    }
                }, 300);
            }
        }

        function closeNewSupplierModal() {
            closeNewSupplierSection();
        }
        
        function closeNewSupplierSection() {
            const section = document.getElementById('new-supplier-section');
            const form = document.getElementById('new-supplier-form-section');
            if (section) {
                section.style.display = 'none';
            }
            if (form) {
                form.reset();
                // Reset validation states
                const inputs = form.querySelectorAll('input, textarea');
                inputs.forEach(input => {
                    input.style.borderColor = '';
                    input.style.boxShadow = '';
                });
            }
        }

        async function saveNewSupplierFromSection(event) {
            event.preventDefault();
            
            // L·∫•y v√† validate d·ªØ li·ªáu t·ª´ section
            const tenNCC = document.getElementById('new-supplier-name-section')?.value.trim() || '';
            const sdt = document.getElementById('new-supplier-phone-section')?.value.trim() || '';
            const email = document.getElementById('new-supplier-email-section')?.value.trim() || '';
            const diachi = document.getElementById('new-supplier-address-section')?.value.trim() || '';
            const ghiChu = document.getElementById('new-supplier-note-section')?.value.trim() || '';
            
            await saveSupplierData(tenNCC, sdt, email, diachi, ghiChu, 'section');
        }
        
        async function saveNewSupplier(event) {
            event.preventDefault();
            
            // L·∫•y v√† validate d·ªØ li·ªáu t·ª´ modal (n·∫øu v·∫´n d√πng modal c≈©)
            const tenNCC = document.getElementById('new-supplier-name')?.value.trim() || '';
            const sdt = document.getElementById('new-supplier-phone')?.value.trim() || '';
            const email = document.getElementById('new-supplier-email')?.value.trim() || '';
            const diachi = document.getElementById('new-supplier-address')?.value.trim() || '';
            const ghiChu = document.getElementById('new-supplier-note')?.value.trim() || '';
            
            await saveSupplierData(tenNCC, sdt, email, diachi, ghiChu, 'modal');
        }
        
        async function saveSupplierData(tenNCC, sdt, email, diachi, ghiChu, source) {
            // X√°c ƒë·ªãnh ID input d·ª±a v√†o source
            const nameInputId = source === 'section' ? 'new-supplier-name-section' : 'new-supplier-name';
            const phoneInputId = source === 'section' ? 'new-supplier-phone-section' : 'new-supplier-phone';
            const emailInputId = source === 'section' ? 'new-supplier-email-section' : 'new-supplier-email';
            const submitBtnId = source === 'section' ? 'new-supplier-form-section' : 'new-supplier-form';

            // Validation
            if (!tenNCC) {
                showToast('‚ö†Ô∏è Vui l√≤ng nh·∫≠p t√™n nh√† cung c·∫•p', 'error');
                const nameInput = document.getElementById(nameInputId);
                if (nameInput) nameInput.focus();
                return;
            }

            if (tenNCC.length < 3) {
                showToast('‚ö†Ô∏è T√™n nh√† cung c·∫•p ph·∫£i c√≥ √≠t nh·∫•t 3 k√Ω t·ª±', 'error');
                const nameInput = document.getElementById(nameInputId);
                if (nameInput) nameInput.focus();
                return;
            }

            // Validate s·ªë ƒëi·ªán tho·∫°i n·∫øu c√≥
            if (sdt && !/^[0-9]{10,11}$/.test(sdt.replace(/\s/g, ''))) {
                showToast('‚ö†Ô∏è S·ªë ƒëi·ªán tho·∫°i kh√¥ng h·ª£p l·ªá. Vui l√≤ng nh·∫≠p 10-11 ch·ªØ s·ªë', 'error');
                const phoneInput = document.getElementById(phoneInputId);
                if (phoneInput) phoneInput.focus();
                return;
            }

            // Validate email n·∫øu c√≥
            if (email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                showToast('‚ö†Ô∏è Email kh√¥ng h·ª£p l·ªá. Vui l√≤ng ki·ªÉm tra l·∫°i', 'error');
                const emailInput = document.getElementById(emailInputId);
                if (emailInput) emailInput.focus();
                return;
            }

            const data = {
                tenNCC: tenNCC,
                sdt: sdt || null,
                email: email || null,
                diachi: diachi || null,
                ghiChu: ghiChu || null
            };

            // Disable button ƒë·ªÉ tr√°nh submit nhi·ªÅu l·∫ßn
            const formId = source === 'section' ? 'new-supplier-form-section' : 'new-supplier-form';
            const form = document.getElementById(formId);
            const submitBtn = form ? form.querySelector('button[type="submit"]') : null;
            const originalText = submitBtn ? submitBtn.innerHTML : '';
            
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<span style="margin-right: 5px;">‚è≥</span> ƒêang l∆∞u...';
            }

            try {
                const response = await fetch(`${API_BASE}/nhacungcap`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (result.success) {
                    // Reload suppliers
                    const suppliersRes = await fetch(`${API_BASE}/nhacungcap`);
                    const suppliersData = await suppliersRes.json();
                    if (suppliersData.success) {
                        nhacungcapList = suppliersData.data;
                        
                        // C·∫≠p nh·∫≠t select box
                        const selectBox = document.getElementById('phieunhap-nhacungcap-select');
                        if (selectBox) {
                            selectBox.innerHTML = `
                                <option value="">-- Kh√¥ng ch·ªçn --</option>
                                ${nhacungcapList.map(ncc => `<option value="${ncc.id}">${ncc.tenNCC} (${ncc.maNCC})</option>`).join('')}
                            `;
                            // Ch·ªçn nh√† cung c·∫•p v·ª´a t·∫°o
                            const newSupplier = nhacungcapList.find(ncc => ncc.maNCC === result.data.maNCC);
                            if (newSupplier) {
                                selectBox.value = newSupplier.id;
                                // Highlight option v·ª´a ch·ªçn
                                selectBox.style.borderColor = '#00b894';
                                selectBox.style.boxShadow = '0 0 0 3px rgba(0, 184, 148, 0.1)';
                                setTimeout(() => {
                                    selectBox.style.borderColor = '';
                                    selectBox.style.boxShadow = '';
                                }, 2000);
                            }
                        }
                    }
                    
                    showToast(`‚úÖ ƒê√£ th√™m nh√† cung c·∫•p "${tenNCC}" (M√£: ${result.data.maNCC})`, 'success');
                    
                    // ƒê√≥ng section/modal sau 1 gi√¢y ƒë·ªÉ ng∆∞·ªùi d√πng th·∫•y th√¥ng b√°o
                    setTimeout(() => {
                        if (source === 'section') {
                            closeNewSupplierSection();
                        } else {
                            closeNewSupplierModal();
                        }
                    }, 1000);
                } else {
                    showToast('‚ùå ' + (result.message || 'L·ªói th√™m nh√† cung c·∫•p'), 'error');
                    if (submitBtn) {
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = originalText;
                    }
                }
            } catch (error) {
                showToast('‚ùå L·ªói k·∫øt n·ªëi: ' + error.message, 'error');
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalText;
                }
            }
        }

        // ==================== UTILITIES ====================
        function formatCurrency(value) {
            if (!value) return '0ƒë';
            return new Intl.NumberFormat('vi-VN').format(value) + 'ƒë';
        }

        function formatDate(dateStr) {
            if (!dateStr) return '-';
            
            const dateStrClean = String(dateStr).trim();
            
            // Ki·ªÉm tra xem c√≥ ph·∫ßn gi·ªù kh√¥ng
            const dateStrLower = dateStrClean.toLowerCase();
            const hasTime = dateStrLower.includes('t') || 
                           (dateStrLower.includes(' ') && dateStrLower.match(/\d{1,2}:\d{2}/)) ||
                           dateStrClean.length > 10; // DATE ch·ªâ c√≥ 10 k√Ω t·ª± (YYYY-MM-DD)
            
            if (hasTime) {
                let date;
                
                // X·ª≠ l√Ω ISO format v·ªõi Z (UTC): "2026-01-06T22:27:56.970Z"
                // Parse tr·ª±c ti·∫øp t·ª´ string ƒë·ªÉ gi·ªØ nguy√™n gi·ªù UTC, kh√¥ng convert timezone
                if (dateStrClean.includes('T') && dateStrClean.endsWith('Z')) {
                    // ISO UTC format: "2026-01-06T22:27:56.970Z"
                    // Extract date v√† time t·ª´ string, parse tr·ª±c ti·∫øp kh√¥ng qua Date constructor ƒë·ªÉ tr√°nh timezone conversion
                    const isoMatch = dateStrClean.match(/^(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2}):(\d{2})(?:\.(\d+))?Z$/);
                    if (isoMatch) {
                        const [, year, month, day, hour, minute, second] = isoMatch.map(Number);
                        // T·∫°o Date object v·ªõi UTC time, nh∆∞ng hi·ªÉn th·ªã nh∆∞ local (gi·ªØ nguy√™n gi·ªù)
                        date = new Date(Date.UTC(year, month - 1, day, hour, minute, second || 0));
                        // Format tr·ª±c ti·∫øp t·ª´ UTC components ƒë·ªÉ gi·ªØ nguy√™n gi·ªù
                        const dayStr = String(day).padStart(2, '0');
                        const monthStr = String(month).padStart(2, '0');
                        const hourStr = String(hour).padStart(2, '0');
                        const minuteStr = String(minute).padStart(2, '0');
                        return `${dayStr}/${monthStr}/${year} ${hourStr}:${minuteStr}`;
                    }
                } else if (dateStrClean.match(/^\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}/)) {
                    // SQL Server format: "YYYY-MM-DD HH:mm:ss"
                    // Parse tr·ª±c ti·∫øp ƒë·ªÉ gi·ªØ nguy√™n gi·ªù
                    const [datePart, timePart] = dateStrClean.split(' ');
                    const [year, month, day] = datePart.split('-').map(Number);
                    const [hour, minute, second] = timePart.split(':').map(Number);
                    date = new Date(year, month - 1, day, hour, minute, second || 0);
                } else if (dateStrClean.includes('T')) {
                    // ISO format kh√°c (kh√¥ng c√≥ Z)
                    date = new Date(dateStrClean);
                } else {
                    date = new Date(dateStrClean);
                }
                
                // Hi·ªÉn th·ªã c·∫£ ng√†y v√† gi·ªù
                return date.toLocaleDateString('vi-VN') + ' ' + date.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
            } else {
                // DATE: ch·ªâ hi·ªÉn th·ªã ng√†y
                const date = new Date(dateStrClean);
                return date.toLocaleDateString('vi-VN');
            }
        }

        // Format datetime v·ªõi ƒë·∫ßy ƒë·ªß gi·ªù:ph√∫t:gi√¢y (d√πng cho l·ªãch s·ª≠ ho·∫°t ƒë·ªông)
        function formatDateTime(dateStr) {
            if (!dateStr) return '-';
            
            const dateStrClean = String(dateStr).trim();
            
            // X·ª≠ l√Ω ISO format v·ªõi Z (UTC): "2026-01-06T22:27:56.970Z"
            if (dateStrClean.includes('T') && dateStrClean.endsWith('Z')) {
                const isoMatch = dateStrClean.match(/^(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2}):(\d{2})(?:\.(\d+))?Z$/);
                if (isoMatch) {
                    const [, year, month, day, hour, minute, second] = isoMatch.map(Number);
                    // Format tr·ª±c ti·∫øp t·ª´ UTC components ƒë·ªÉ gi·ªØ nguy√™n gi·ªù
                    const dayStr = String(day).padStart(2, '0');
                    const monthStr = String(month).padStart(2, '0');
                    const hourStr = String(hour).padStart(2, '0');
                    const minuteStr = String(minute).padStart(2, '0');
                    const secondStr = String(second || 0).padStart(2, '0');
                    return `${dayStr}/${monthStr}/${year} ${hourStr}:${minuteStr}:${secondStr}`;
                }
            } else if (dateStrClean.match(/^\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}/)) {
                // SQL Server format: "YYYY-MM-DD HH:mm:ss"
                const [datePart, timePart] = dateStrClean.split(' ');
                const [year, month, day] = datePart.split('-').map(Number);
                const [hour, minute, second] = timePart.split(':').map(Number);
                const dayStr = String(day).padStart(2, '0');
                const monthStr = String(month).padStart(2, '0');
                const hourStr = String(hour).padStart(2, '0');
                const minuteStr = String(minute).padStart(2, '0');
                const secondStr = String(second || 0).padStart(2, '0');
                return `${dayStr}/${monthStr}/${year} ${hourStr}:${minuteStr}:${secondStr}`;
            }
            
            // Fallback: d√πng Date object
            const date = new Date(dateStrClean);
            return date.toLocaleDateString('vi-VN') + ' ' + date.toLocaleTimeString('vi-VN', { 
                hour: '2-digit', 
                minute: '2-digit',
                second: '2-digit'
            });
        }

        function getStockClass(qty) {
            if (qty <= 0) return 'stock-danger';
            if (qty < 10) return 'stock-warning';
            return 'stock-ok';
        }

        function getStockBadge(qty) {
            if (qty <= 0) return 'badge-danger';
            if (qty < 10) return 'badge-warning';
            return 'badge-success';
        }

        function getStockText(qty) {
            if (qty <= 0) return 'H·∫øt h√†ng';
            if (qty <= 10) return 'S·∫Øp h·∫øt';
            return 'C√≤n h√†ng';
        }

        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            if (!container) return;

            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;

            let title = 'Th√¥ng b√°o';
            if (type === 'success') title = 'Th√†nh c√¥ng';
            else if (type === 'error') title = 'L·ªói';

            toast.innerHTML = `
                <div class="toast-content">
                    <div class="toast-title">${title}</div>
                    <div class="toast-message">${message}</div>
                </div>
                <button class="toast-close" onclick="this.parentElement.remove()">√ó</button>
            `;

            container.appendChild(toast);

            setTimeout(() => {
                if (toast.parentElement) toast.remove();
            }, 3000);
        }

        // Close modals when clicking outside
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', function (e) {
                if (e.target === this) {
                    this.classList.remove('active');
                    // ƒê·∫∑c bi·ªát x·ª≠ l√Ω success-modal
                    if (this.id === 'success-modal') {
                        this.style.display = 'none';
                        this.style.zIndex = '';
                    }
                }
            });
        });
    </script>
</body>

</html>

