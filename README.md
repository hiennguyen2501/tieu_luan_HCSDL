# üè™ H·ªá Th·ªëng Qu·∫£n L√Ω C·ª≠a H√†ng FMSTYLE

H·ªá th·ªëng qu·∫£n l√Ω c·ª≠a h√†ng th·ªùi trang FMSTYLE - Gi·∫£i ph√°p qu·∫£n l√Ω to√†n di·ªán cho c·ª≠a h√†ng b√°n l·∫ª v·ªõi ƒë·∫ßy ƒë·ªß t√≠nh nƒÉng t·ª´ qu·∫£n l√Ω kho, b√°n h√†ng, ƒë·∫øn th·ªëng k√™ doanh thu.

## üìã M·ª•c L·ª•c

- [Gi·ªõi thi·ªáu](#gi·ªõi-thi·ªáu)
- [T√≠nh nƒÉng](#t√≠nh-nƒÉng)
- [C√¥ng ngh·ªá s·ª≠ d·ª•ng](#c√¥ng-ngh·ªá-s·ª≠-d·ª•ng)
- [C√†i ƒë·∫∑t](#c√†i-ƒë·∫∑t)
- [C·∫•u tr√∫c d·ª± √°n](#c·∫•u-tr√∫c-d·ª±-√°n)
- [H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng](#h∆∞·ªõng-d·∫´n-s·ª≠-d·ª•ng)
- [API Documentation](#api-documentation)
- [Database Schema](#database-schema)
- [T√°c gi·∫£](#t√°c-gi·∫£)

## üéØ Gi·ªõi thi·ªáu

H·ªá th·ªëng Qu·∫£n L√Ω C·ª≠a H√†ng FMSTYLE l√† m·ªôt ·ª©ng d·ª•ng web to√†n di·ªán ƒë∆∞·ª£c thi·∫øt k·∫ø ƒë·ªÉ qu·∫£n l√Ω m·ªçi kh√≠a c·∫°nh c·ªßa m·ªôt c·ª≠a h√†ng b√°n l·∫ª th·ªùi trang. H·ªá th·ªëng h·ªó tr·ª£ hai lo·∫°i ng∆∞·ªùi d√πng ch√≠nh:

- **Admin**: Qu·∫£n l√Ω to√†n b·ªô h·ªá th·ªëng, nh√¢n vi√™n, kh√°ch h√†ng, h√†ng h√≥a, v√† c√°c c·∫•u h√¨nh
- **Staff**: Nh√¢n vi√™n b√°n h√†ng v·ªõi c√°c ch·ª©c nƒÉng b√°n h√†ng, t·∫°o h√≥a ƒë∆°n, v√† qu·∫£n l√Ω phi·∫øu nh·∫≠p h√†ng

## ‚ú® T√≠nh nƒÉng

### üë®‚Äçüíº Qu·∫£n l√Ω Admin
- ‚úÖ Qu·∫£n l√Ω v·ªã tr√≠ nh√¢n vi√™n, ph√¢n lo·∫°i kh√°ch h√†ng, ph√¢n lo·∫°i s·∫£n ph·∫©m
- ‚úÖ Qu·∫£n l√Ω khuy·∫øn m√£i v√† m√£ gi·∫£m gi√°
- ‚úÖ Qu·∫£n l√Ω nh√¢n vi√™n (th√™m, s·ª≠a, x√≥a, ph√¢n quy·ªÅn)
- ‚úÖ Qu·∫£n l√Ω kh√°ch h√†ng v√† ƒëi·ªÉm t√≠ch l≈©y
- ‚úÖ Qu·∫£n l√Ω h√†ng h√≥a (th√™m, s·ª≠a, x√≥a, theo d√µi t·ªìn kho)
- ‚úÖ Qu·∫£n l√Ω h√≥a ƒë∆°n v√† chi ti·∫øt h√≥a ƒë∆°n
- ‚úÖ Qu·∫£n l√Ω phi·∫øu nh·∫≠p h√†ng v·ªõi giao di·ªán t∆∞∆°ng t·ª± b√°n h√†ng
- ‚úÖ Xem chi ti·∫øt phi·∫øu nh·∫≠p h√†ng

### üíº Qu·∫£n l√Ω Staff (Nh√¢n vi√™n b√°n h√†ng)
- ‚úÖ **Dashboard**: T·ªïng quan h·ªá th·ªëng, th·ªëng k√™ nhanh
- ‚úÖ **Kho H√†ng H√≥a**: Xem v√† t√¨m ki·∫øm s·∫£n ph·∫©m, c·∫£nh b√°o t·ªìn kho th·∫•p
- ‚úÖ **T·∫°o H√≥a ƒê∆°n**: 
  - Ch·ªçn s·∫£n ph·∫©m t·ª´ kho
  - Qu·∫£n l√Ω gi·ªè h√†ng
  - Ch·ªçn/Th√™m kh√°ch h√†ng m·ªõi
  - √Åp d·ª•ng m√£ gi·∫£m gi√°
  - S·ª≠ d·ª•ng ƒëi·ªÉm t√≠ch l≈©y (1 ƒëi·ªÉm = 1.000ƒë)
  - Ch·ªçn nh√¢n vi√™n b√°n h√†ng
  - T·ª± ƒë·ªông tr·ª´ kho v√† t√≠ch ƒëi·ªÉm
  - In h√≥a ƒë∆°n, xu·∫•t PDF
- ‚úÖ **Danh S√°ch H√≥a ƒê∆°n**: Xem, t√¨m ki·∫øm, xem chi ti·∫øt, xu·∫•t PDF
- ‚úÖ **Kh√°ch H√†ng**: Xem danh s√°ch, ƒëi·ªÉm t√≠ch l≈©y
- ‚úÖ **Th·ªëng K√™ Doanh Thu**: 
  - Theo ng√†y, tu·∫ßn, th√°ng, qu√Ω, nƒÉm
  - L·ªçc theo nh√¢n vi√™n
  - S·∫Øp x·∫øp theo doanh thu t·ª´ cao ƒë·∫øn th·∫•p
- ‚úÖ **Phi·∫øu Nh·∫≠p H√†ng**:
  - T·∫°o phi·∫øu nh·∫≠p m·ªõi
  - Ch·ªçn h√†ng h√≥a c√≥ s·∫µn ho·∫∑c th√™m h√†ng h√≥a m·ªõi
  - Qu·∫£n l√Ω gi·ªè h√†ng nh·∫≠p
  - T·ª± ƒë·ªông c·ªông h√†ng v√†o kho khi t·∫°o phi·∫øu nh·∫≠p
  - Xem chi ti·∫øt phi·∫øu nh·∫≠p
- ‚úÖ **Tr·∫£ H√†ng**: Tr·∫£ h√†ng t·ª´ h√≥a ƒë∆°n, t·ª± ƒë·ªông c·ªông l·∫°i v√†o kho
- ‚úÖ **ƒê·ªïi H√†ng**: ƒê·ªïi s·∫£n ph·∫©m trong h√≥a ƒë∆°n, t·ª± ƒë·ªông c·∫≠p nh·∫≠t kho

### üîê B·∫£o m·∫≠t & Ph√¢n quy·ªÅn
- ‚úÖ ƒêƒÉng nh·∫≠p v·ªõi m√£ h√≥a SHA-256
- ‚úÖ Ph√¢n quy·ªÅn theo role (admin, user, seller, warehouse)
- ‚úÖ Ki·ªÉm tra quy·ªÅn truy c·∫≠p c√°c ch·ª©c nƒÉng
- ‚úÖ Session management

### üìä T·ª± ƒë·ªông h√≥a
- ‚úÖ Trigger t·ª± ƒë·ªông tr·ª´ kho khi b√°n h√†ng
- ‚úÖ Trigger t·ª± ƒë·ªông c·ªông kho khi nh·∫≠p h√†ng
- ‚úÖ Trigger t·ª± ƒë·ªông t√≠ch ƒëi·ªÉm cho kh√°ch h√†ng (100.000ƒë = 1 ƒëi·ªÉm, t·ªëi thi·ªÉu 1 ƒëi·ªÉm)
- ‚úÖ Trigger t·ª± ƒë·ªông c·∫≠p nh·∫≠t t·ªïng ti·ªÅn h√≥a ƒë∆°n/phi·∫øu nh·∫≠p
- ‚úÖ T·ª± ƒë·ªông sinh m√£ (HD, PN, KH, NV, SP)

## üõ†Ô∏è C√¥ng ngh·ªá s·ª≠ d·ª•ng

### Backend
- **Node.js** - Runtime environment
- **Express.js** - Web framework
- **SQL Server** - Database
- **mssql** - SQL Server driver
- **PDFKit** - T·∫°o PDF h√≥a ƒë∆°n
- **ExcelJS** - Xu·∫•t Excel

### Frontend
- **HTML5** - C·∫•u tr√∫c
- **CSS3** - Styling v·ªõi gradient, animations
- **Vanilla JavaScript** - Logic v√† t∆∞∆°ng t√°c
- **Fetch API** - Giao ti·∫øp v·ªõi backend

### Database
- **Microsoft SQL Server** - H·ªá qu·∫£n tr·ªã c∆° s·ªü d·ªØ li·ªáu
- **Triggers** - T·ª± ƒë·ªông c·∫≠p nh·∫≠t kho, ƒëi·ªÉm t√≠ch l≈©y
- **Computed Columns** - T·ª± ƒë·ªông t√≠nh to√°n (m√£, th√†nh ti·ªÅn)

## üì¶ C√†i ƒë·∫∑t

### Y√™u c·∫ßu h·ªá th·ªëng
- Node.js >= 14.x
- SQL Server >= 2016
- npm ho·∫∑c yarn

### B∆∞·ªõc 1: Clone repository
```bash
git clone <repository-url>
cd be-Hien-ne
```

### B∆∞·ªõc 2: C√†i ƒë·∫∑t dependencies
```bash
npm install
```

### B∆∞·ªõc 3: C·∫•u h√¨nh Database
1. T·∫°o database trong SQL Server
2. Ch·∫°y script SQL trong file `README.md` (ph·∫ßn Database Schema) ƒë·ªÉ t·∫°o c√°c b·∫£ng v√† triggers
3. C·∫•u h√¨nh k·∫øt n·ªëi database trong file `db.config.js`:
```javascript
const config = {
    user: 'your_username',
    password: 'your_password',
    server: 'localhost',
    database: 'HeThongQuanLyCuaHang_FMSTYLE',
    options: {
        encrypt: true,
        trustServerCertificate: true
    }
};
```

### B∆∞·ªõc 4: T·∫°o t√†i kho·∫£n admin
Ch·∫°y script SQL ƒë·ªÉ t·∫°o t√†i kho·∫£n admin m·∫∑c ƒë·ªãnh:
```sql
-- T·∫°o nh√¢n vi√™n admin
INSERT INTO VITRI (tenVT) VALUES (N'Qu·∫£n l√Ω');
INSERT INTO NHANVIEN (tenNV, gioitinh, sdt, idVT) 
VALUES (N'Admin', N'Nam', '0123456789', 1);

-- T·∫°o user admin (password: admin123)
INSERT INTO USERS (username, passwordHash, role, idNV)
VALUES ('admin', UPPER(CONVERT(VARCHAR(64), HASHBYTES('SHA2_256', 'admin123'), 2)), 'admin', 1);
```

### B∆∞·ªõc 5: Ch·∫°y ·ª©ng d·ª•ng
```bash
# Development mode (v·ªõi nodemon)
npm run dev

# Production mode
npm start
```

·ª®ng d·ª•ng s·∫Ω ch·∫°y t·∫°i: `http://localhost:3000`

### B∆∞·ªõc 6: Truy c·∫≠p ·ª©ng d·ª•ng
- **Admin Panel**: `http://localhost:3000/src/pages/admin.html`
- **Staff Panel**: `http://localhost:3000/src/pages/staff.html`
- **Login**: `http://localhost:3000/src/pages/login.html`


## üìñ H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng

### ƒêƒÉng nh·∫≠p
1. Truy c·∫≠p `http://localhost:3000/src/pages/login.html`
2. Nh·∫≠p username v√† password
3. H·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông chuy·ªÉn ƒë·∫øn trang t∆∞∆°ng ·ª©ng (admin ho·∫∑c staff)

### Qu·∫£n l√Ω Admin
1. **Qu·∫£n l√Ω d·ªØ li·ªáu c∆° b·∫£n**: V·ªã tr√≠, Ph√¢n lo·∫°i KH, Ph√¢n lo·∫°i SP, Khuy·∫øn m√£i
2. **Qu·∫£n l√Ω nh√¢n vi√™n**: Th√™m, s·ª≠a, x√≥a nh√¢n vi√™n, ph√¢n quy·ªÅn
3. **Qu·∫£n l√Ω kh√°ch h√†ng**: Xem danh s√°ch, ƒëi·ªÉm t√≠ch l≈©y
4. **Qu·∫£n l√Ω h√†ng h√≥a**: Th√™m, s·ª≠a, x√≥a, theo d√µi t·ªìn kho
5. **Qu·∫£n l√Ω h√≥a ƒë∆°n**: Xem danh s√°ch, chi ti·∫øt
6. **Qu·∫£n l√Ω phi·∫øu nh·∫≠p**: T·∫°o phi·∫øu nh·∫≠p v·ªõi giao di·ªán t∆∞∆°ng t·ª± b√°n h√†ng

### Qu·∫£n l√Ω Staff
1. **T·∫°o h√≥a ƒë∆°n**:
   - Ch·ªçn s·∫£n ph·∫©m t·ª´ kho
   - Th√™m v√†o gi·ªè h√†ng
   - Ch·ªçn/Th√™m kh√°ch h√†ng
   - √Åp d·ª•ng m√£ gi·∫£m gi√° (n·∫øu c√≥)
   - S·ª≠ d·ª•ng ƒëi·ªÉm t√≠ch l≈©y
   - Ch·ªçn nh√¢n vi√™n b√°n h√†ng
   - T·∫°o h√≥a ƒë∆°n
   - In ho·∫∑c xu·∫•t PDF

2. **Phi·∫øu nh·∫≠p h√†ng**:
   - Ch·ªçn h√†ng h√≥a c√≥ s·∫µn ho·∫∑c th√™m h√†ng h√≥a m·ªõi
   - Th√™m v√†o gi·ªè h√†ng nh·∫≠p
   - Ch·ªçn ng∆∞·ªùi nh·∫≠p (qu·∫£n l√Ω/th·ªß kho)
   - T·∫°o phi·∫øu nh·∫≠p
   - H·ªá th·ªëng t·ª± ƒë·ªông c·ªông h√†ng v√†o kho

3. **Th·ªëng k√™ doanh thu**:
   - Ch·ªçn kho·∫£ng th·ªùi gian (ng√†y/tu·∫ßn/th√°ng/qu√Ω/nƒÉm)
   - L·ªçc theo nh√¢n vi√™n (t√πy ch·ªçn)
   - Xem b√°o c√°o doanh thu

## üîå API Documentation

### Authentication
- `POST /api/login` - ƒêƒÉng nh·∫≠p

### H√†ng H√≥a
- `GET /api/hanghoa` - L·∫•y danh s√°ch h√†ng h√≥a
- `POST /api/hanghoa` - T·∫°o h√†ng h√≥a m·ªõi
- `PUT /api/hanghoa/:id` - C·∫≠p nh·∫≠t h√†ng h√≥a
- `DELETE /api/hanghoa/:id` - X√≥a h√†ng h√≥a

### H√≥a ƒê∆°n
- `GET /api/hoadon` - L·∫•y danh s√°ch h√≥a ƒë∆°n
- `POST /api/hoadon` - T·∫°o h√≥a ƒë∆°n m·ªõi
- `GET /api/hoadon/:id` - L·∫•y chi ti·∫øt h√≥a ƒë∆°n
- `GET /api/hoadon/:id/pdf` - Xu·∫•t PDF h√≥a ƒë∆°n
- `GET /api/hoadon/:id/export` - Xu·∫•t Excel/JSON
- `POST /api/hoadon/:id/tra-hang` - Tr·∫£ h√†ng
- `POST /api/hoadon/:id/doi-hang` - ƒê·ªïi h√†ng

### Phi·∫øu Nh·∫≠p
- `GET /api/phieunhap` - L·∫•y danh s√°ch phi·∫øu nh·∫≠p
- `POST /api/phieunhap` - T·∫°o phi·∫øu nh·∫≠p m·ªõi
- `GET /api/chitietphieunhap/:idPN` - L·∫•y chi ti·∫øt phi·∫øu nh·∫≠p

### Kh√°ch H√†ng
- `GET /api/khachhang` - L·∫•y danh s√°ch kh√°ch h√†ng
- `POST /api/khachhang` - T·∫°o kh√°ch h√†ng m·ªõi
- `PUT /api/khachhang/:id` - C·∫≠p nh·∫≠t kh√°ch h√†ng

### Th·ªëng K√™
- `GET /api/thongke/doanhthu` - Th·ªëng k√™ doanh thu

## üóÑÔ∏è Database Schema

### C√°c b·∫£ng ch√≠nh

#### VITRI
- Qu·∫£n l√Ω v·ªã tr√≠ nh√¢n vi√™n (Qu·∫£n l√Ω, Th·ªß kho, B√°n h√†ng, ...)

#### NHANVIEN
- Th√¥ng tin nh√¢n vi√™n (m√£ NV t·ª± ƒë·ªông sinh: NV00001, NV00002, ...)

#### USERS
- T√†i kho·∫£n ƒëƒÉng nh·∫≠p (username, password hash SHA-256, role, idNV)

#### KHACHHANG
- Th√¥ng tin kh√°ch h√†ng (m√£ KH t·ª± ƒë·ªông sinh, ƒëi·ªÉm t√≠ch l≈©y, t·ªïng chi)

#### HANGHOA
- Th√¥ng tin h√†ng h√≥a (m√£ SP t·ª± ƒë·ªông sinh, s·ªë l∆∞·ª£ng, gi√° nh·∫≠p, gi√° b√°n)

#### HOADON
- H√≥a ƒë∆°n b√°n h√†ng (m√£ HD t·ª± ƒë·ªông sinh, ng√†y l·∫≠p, nh√¢n vi√™n, kh√°ch h√†ng, m√£ gi·∫£m gi√°, ƒëi·ªÉm ƒë√£ d√πng)

#### CHITIET_HD
- Chi ti·∫øt h√≥a ƒë∆°n (s·∫£n ph·∫©m, s·ªë l∆∞·ª£ng, ƒë∆°n gi√°, th√†nh ti·ªÅn)

#### PHIEUNHAP
- Phi·∫øu nh·∫≠p h√†ng (m√£ PN t·ª± ƒë·ªông sinh, ng√†y nh·∫≠p, ng∆∞·ªùi nh·∫≠p, t·ªïng ti·ªÅn)

#### CHITIET_PHIEUNHAP
- Chi ti·∫øt phi·∫øu nh·∫≠p (s·∫£n ph·∫©m, s·ªë l∆∞·ª£ng, ƒë∆°n gi√°, th√†nh ti·ªÅn)

### Triggers t·ª± ƒë·ªông

1. **trg_CapNhatKhoSauBanHang**: T·ª± ƒë·ªông tr·ª´ kho v√† t√≠ch ƒëi·ªÉm khi b√°n h√†ng
2. **trg_CapNhatKhoSauNhapHang**: T·ª± ƒë·ªông c·ªông kho khi nh·∫≠p h√†ng
3. **trg_CapNhatTongTienPhieuNhap_Delete**: C·∫≠p nh·∫≠t t·ªïng ti·ªÅn khi x√≥a chi ti·∫øt phi·∫øu nh·∫≠p

Xem chi ti·∫øt SQL schema trong file `README.md` (ph·∫ßn d∆∞·ªõi).

---

## üìù Database Schema (SQL Script)

```sql
CREATE DATABASE HeThongQuanLyCuaHang_FMSTYLE;
GO
USE HeThongQuanLyCuaHang_FMSTYLE;
GO

-- =============================================
-- 1. B·∫¢NG DANH M·ª§C G·ªêC
-- =============================================

CREATE TABLE VITRI (
    id INT IDENTITY(1,1) PRIMARY KEY,
    tenVT NVARCHAR(40) NOT NULL
);

CREATE TABLE PHANLOAI_KH(
    id INT IDENTITY(1,1) PRIMARY KEY,
    maPLKH NVARCHAR(10) UNIQUE, -- 'LE', 'THANHVIEN', 'VIP'
    tenPLKH NVARCHAR(40) NOT NULL,
    nguongChiMin MONEY DEFAULT 0
);

CREATE TABLE PHANLOAI_SANPHAM(
    id INT IDENTITY(1,1) PRIMARY KEY,
    maPLSP NVARCHAR(10) UNIQUE, -- 'NAM', 'NU', 'PK'
    tenPLSP NVARCHAR(40) NOT NULL
);

CREATE TABLE KHUYENMAI(
    id INT IDENTITY(1,1) PRIMARY KEY,
    maKM NVARCHAR(20) UNIQUE,
    tenKM NVARCHAR(100),
    phantramGiam INT CHECK(phantramGiam BETWEEN 0 AND 100),
    ngayBD DATE,
    ngayKT DATE,
    trangthai AS (CASE WHEN GETDATE() BETWEEN ngayBD AND ngayKT THEN 1 ELSE 0 END)
);

-- =============================================
-- 2. NH√ÇN VI√äN & T√ÄI KHO·∫¢N
-- =============================================

CREATE TABLE NHANVIEN(
    id INT IDENTITY(1,1) PRIMARY KEY, -- D√πng ID n√†y l√†m Kh√≥a ch√≠nh ƒë·ªÉ li√™n k·∫øt
    maNV AS ('NV' + RIGHT('000' + CAST(id AS VARCHAR(5)), 5)) PERSISTED, 
    tenNV NVARCHAR(40) NOT NULL,
    gioitinh NVARCHAR(3) CHECK(gioitinh IN (N'Nam', N'N·ªØ')), 
    sdt VARCHAR(10),
    idVT INT NOT NULL,
    trangthai BIT DEFAULT 1,
    CONSTRAINT fk_NV_VT FOREIGN KEY(idVT) REFERENCES VITRI(id)
);

CREATE TABLE USERS (
    userId INT IDENTITY(1,1) PRIMARY KEY,
    username NVARCHAR(50) NOT NULL UNIQUE,         -- T√™n ƒëƒÉng nh·∫≠p
    passwordHash VARCHAR(64) NOT NULL,            -- M·∫≠t kh·∫©u m√£ h√≥a SHA2_256
    role NVARCHAR(20) NOT NULL CHECK (role IN ('admin', 'user', 'seller', 'warehouse')), 
    idNV INT NULL,                                -- FK tr·ªè ƒë·∫øn id (INT) c·ªßa NHANVIEN
    trangthai BIT DEFAULT 1,                       -- 1: Ho·∫°t ƒë·ªông, 0: Kh√≥a
    ngaytao DATETIME DEFAULT GETDATE(),

    CONSTRAINT fk_USERS_NV FOREIGN KEY (idNV)
        REFERENCES NHANVIEN(id)                   -- R√†ng bu·ªôc v·ªõi c·ªôt id (INT)
        ON DELETE SET NULL
        ON UPDATE CASCADE
);

-- =============================================
-- 3. KH√ÅCH H√ÄNG & H√ÄNG H√ìA
-- =============================================

CREATE TABLE KHACHHANG(
    id INT IDENTITY(1,1) PRIMARY KEY,
    maKH AS ('KH' + RIGHT('000' + CAST(id AS VARCHAR(5)), 5)) PERSISTED,
    tenKH NVARCHAR(40) NOT NULL,
    sdt VARCHAR(10) UNIQUE,
    diachi NVARCHAR(100),
    idPLKH INT NOT NULL,
    diemtichluy INT DEFAULT 0,
    tongchi MONEY DEFAULT 0,
    CONSTRAINT fk_KH_PLKH FOREIGN KEY (idPLKH) REFERENCES PHANLOAI_KH(id)
);

CREATE TABLE HANGHOA(
    id INT IDENTITY(1,1) PRIMARY KEY,
    maHang AS ('SP' + RIGHT('000' + CAST(id AS VARCHAR(5)), 5)) PERSISTED,
    tenHang NVARCHAR(100) NOT NULL,
    idPLSP INT NOT NULL,
    soluong INT DEFAULT 0 CHECK(soluong >= 0),
    gianhap MONEY,
    giaban MONEY,
    tonKhoToiThieu INT DEFAULT 10,
    ngayNhapCuoi DATE DEFAULT GETDATE(),
    CONSTRAINT fk_HH_PLSP FOREIGN KEY(idPLSP) REFERENCES PHANLOAI_SANPHAM(id)
);

-- =============================================
-- 4. H√ìA ƒê∆†N & PHI·∫æU NH·∫¨P
-- =============================================

CREATE TABLE HOADON(
    id INT IDENTITY(1,1) PRIMARY KEY,
    maHD AS ('HD' + RIGHT('000' + CAST(id AS VARCHAR(5)), 5)) PERSISTED,
    diemDaDung INT DEFAULT 0,
    ngayLap DATETIME DEFAULT GETDATE(),
    idNV INT NOT NULL, -- Li√™n k·∫øt id nh√¢n vi√™n
    idKH INT NOT NULL, -- Li√™n k·∫øt id kh√°ch h√†ng
    idKM INT NULL,     -- Li√™n k·∫øt id khuy·∫øn m√£i
    tongTien MONEY DEFAULT 0,
    loaiGiaoDich NVARCHAR(20) DEFAULT N'B√°n h√†ng',
    CONSTRAINT fk_HD_NV FOREIGN KEY(idNV) REFERENCES NHANVIEN(id),
    CONSTRAINT fk_HD_KH FOREIGN KEY(idKH) REFERENCES KHACHHANG(id),
    CONSTRAINT fk_HD_KM FOREIGN KEY(idKM) REFERENCES KHUYENMAI(id)
);

CREATE TABLE CHITIET_HD(
    idHD INT NOT NULL,
    idHang INT NOT NULL,
    soluong INT NOT NULL,
    dongia MONEY,
    thanhTien AS (soluong * dongia) PERSISTED,
    PRIMARY KEY (idHD, idHang),
    CONSTRAINT fk_CTHD_HD FOREIGN KEY(idHD) REFERENCES HOADON(id),
    CONSTRAINT fk_CTHD_HH FOREIGN KEY(idHang) REFERENCES HANGHOA(id)
);

GO


CREATE TABLE LICHSU_HOATDONG (
    id INT IDENTITY(1,1) PRIMARY KEY,
    idNV INT NOT NULL, -- Nh√¢n vi√™n th·ª±c hi·ªán
    loaiHoatDong NVARCHAR(50) NOT NULL, -- 'T·∫°o h√≥a ƒë∆°n', 'T·∫°o phi·∫øu nh·∫≠p', 'S·ª≠a h√≥a ƒë∆°n', 'X√≥a h√≥a ƒë∆°n', 'S·ª≠a phi·∫øu nh·∫≠p', 'T·∫°o kh√°ch h√†ng', 'S·ª≠a kh√°ch h√†ng', 'T·∫°o h√†ng h√≥a', 'S·ª≠a h√†ng h√≥a', v.v.
    moTa NVARCHAR(500), -- M√¥ t·∫£ chi ti·∫øt: "T·∫°o h√≥a ƒë∆°n HD00001 v·ªõi t·ªïng ti·ªÅn 500,000ƒë"
    thamChieu NVARCHAR(50), -- M√£ tham chi·∫øu: maHD, maPN, maKH, maHang, v.v.
    idThamChieu INT NULL, -- ID tham chi·∫øu: idHD, idPN, idKH, idHang, v.v.
    thoiGian DATETIME DEFAULT GETDATE(),
    CONSTRAINT fk_LSHD_NV FOREIGN KEY(idNV) REFERENCES NHANVIEN(id)
);
GO

-- T·∫°o index ƒë·ªÉ t√¨m ki·∫øm nhanh
CREATE INDEX idx_LSHD_idNV ON LICHSU_HOATDONG(idNV);
CREATE INDEX idx_LSHD_thoiGian ON LICHSU_HOATDONG(thoiGian DESC);
CREATE INDEX idx_LSHD_loaiHoatDong ON LICHSU_HOATDONG(loaiHoatDong);
GO
-- =============================================
-- 5. TRIGGER T·ª∞ ƒê·ªòNG C·∫¨P NH·∫¨T KHO
-- =============================================

CREATE OR ALTER TRIGGER trg_CapNhatKhoSauBanHang
ON CHITIET_HD
AFTER INSERT
AS
BEGIN
    SET NOCOUNT ON;
    -- Tr·ª´ kho
    UPDATE HANGHOA SET soluong = HANGHOA.soluong - i.soluong
    FROM HANGHOA JOIN inserted i ON HANGHOA.id = i.idHang;
    UPDATE KHACHHANG SET tongchi = tongchi + i.thanhTien,
                         diemtichluy = diemtichluy + (CAST(i.thanhTien AS INT) / 100000)
    FROM KHACHHANG 
    JOIN HOADON h ON KHACHHANG.id = h.idKH
    JOIN inserted i ON h.id = i.idHD;
END;
GO

CREATE TABLE NHACUNGCAP(
    id INT IDENTITY(1,1) PRIMARY KEY,
    maNCC AS ('NCC' + RIGHT('000' + CAST(id AS VARCHAR(5)), 5)) PERSISTED,
    tenNCC NVARCHAR(100) NOT NULL,
    sdt VARCHAR(15),
    email NVARCHAR(100),
    diachi NVARCHAR(200),
    ghiChu NVARCHAR(500),
    trangthai BIT DEFAULT 1, -- 1: Ho·∫°t ƒë·ªông, 0: Ng·ª´ng h·ª£p t√°c
    ngayTao DATETIME DEFAULT GETDATE()
);
GO

-- B·∫£ng PHIEUNHAP
CREATE TABLE PHIEUNHAP(
    id INT IDENTITY(1,1) PRIMARY KEY,
    maPN AS ('PN' + RIGHT('000' + CAST(id AS VARCHAR(5)), 5)) PERSISTED,
    ngayNhap DATETIME DEFAULT GETDATE(),
    idNV INT NOT NULL, -- Ng∆∞·ªùi nh·∫≠p (qu·∫£n l√Ω ho·∫∑c th·ªß kho)
    idNCC INT NULL, -- Nh√† cung c·∫•p (c√≥ th·ªÉ NULL)
    tongTien MONEY DEFAULT 0,
    CONSTRAINT fk_PN_NV FOREIGN KEY(idNV) REFERENCES NHANVIEN(id),
    CONSTRAINT fk_PN_NCC FOREIGN KEY(idNCC) REFERENCES NHACUNGCAP(id)
);
GO

-- B·∫£ng CHITIET_PHIEUNHAP
CREATE TABLE CHITIET_PHIEUNHAP(
    idPN INT NOT NULL,
    idHang INT NOT NULL,
    soluong INT NOT NULL CHECK(soluong > 0),
    dongia MONEY NOT NULL, -- Gi√° nh·∫≠p
    thanhTien AS (soluong * dongia) PERSISTED,
    PRIMARY KEY (idPN, idHang),
    CONSTRAINT fk_CTPN_PN FOREIGN KEY(idPN) REFERENCES PHIEUNHAP(id) ON DELETE CASCADE,
    CONSTRAINT fk_CTPN_HH FOREIGN KEY(idHang) REFERENCES HANGHOA(id)
);
GO

-- =============================================
-- TRIGGER T·ª∞ ƒê·ªòNG C·ªòNG H√ÄNG V√ÄO KHO
-- =============================================

CREATE OR ALTER TRIGGER trg_CapNhatKhoSauNhapHang
ON CHITIET_PHIEUNHAP
AFTER INSERT
AS
BEGIN
    SET NOCOUNT ON;
    
    -- C·ªông h√†ng v√†o kho
    UPDATE HANGHOA 
    SET soluong = HANGHOA.soluong + i.soluong,
        gianhap = i.dongia, -- C·∫≠p nh·∫≠t gi√° nh·∫≠p m·ªõi nh·∫•t
        ngayNhapCuoi = CAST(GETDATE() AS DATE) -- C·∫≠p nh·∫≠t ng√†y nh·∫≠p cu·ªëi
    FROM HANGHOA 
    JOIN inserted i ON HANGHOA.id = i.idHang;
    
    -- C·∫≠p nh·∫≠t t·ªïng ti·ªÅn c·ªßa phi·∫øu nh·∫≠p
    UPDATE PHIEUNHAP
    SET tongTien = (
        SELECT ISNULL(SUM(thanhTien), 0)
        FROM CHITIET_PHIEUNHAP
        WHERE idPN = PHIEUNHAP.id
    )
    WHERE id IN (SELECT DISTINCT idPN FROM inserted);
END;
GO

-- Trigger ƒë·ªÉ c·∫≠p nh·∫≠t t·ªïng ti·ªÅn khi x√≥a chi ti·∫øt
CREATE OR ALTER TRIGGER trg_CapNhatTongTienPhieuNhap_Delete
ON CHITIET_PHIEUNHAP
AFTER DELETE
AS
BEGIN
    SET NOCOUNT ON;
    
    UPDATE PHIEUNHAP
    SET tongTien = (
        SELECT ISNULL(SUM(thanhTien), 0)
        FROM CHITIET_PHIEUNHAP
        WHERE idPN = PHIEUNHAP.id
    )
    WHERE id IN (SELECT DISTINCT idPN FROM deleted);
END;
GO
```

## üë§ T√°c gi·∫£

**FMSTYLE Development Team**

---

## üìÑ License

ISC License

---

## üôè L·ªùi c·∫£m ∆°n

C·∫£m ∆°n b·∫°n ƒë√£ s·ª≠ d·ª•ng H·ªá Th·ªëng Qu·∫£n L√Ω C·ª≠a H√†ng FMSTYLE!

N·∫øu c√≥ b·∫•t k·ª≥ c√¢u h·ªèi ho·∫∑c ƒë·ªÅ xu·∫•t n√†o, vui l√≤ng li√™n h·ªá v·ªõi ch√∫ng t√¥i.
